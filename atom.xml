<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>è™å“¥çš„åšå®¢</title>
  
  
  <link href="https://bohutang.me/atom.xml" rel="self"/>
  
  <link href="https://bohutang.me/"/>
  <updated>2022-11-22T03:48:17.477Z</updated>
  <id>https://bohutang.me/</id>
  
  <author>
    <name>BohuTANG</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Rust, Databend and the Cloud Warehouseï¼ˆ7) ä½¿ç”¨ Xor Filter æ›¿æ¢ Bloom Filter åŠ é€ŸæŸ¥è¯¢</title>
    <link href="https://bohutang.me/2022/11/21/databend-xor-filter/"/>
    <id>https://bohutang.me/2022/11/21/databend-xor-filter/</id>
    <published>2022-11-20T16:00:00.000Z</published>
    <updated>2022-11-22T03:48:17.477Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>åœ¨å¤§æ•°æ®åˆ†æé¢†åŸŸï¼Œå¾ˆå¤šä¼˜åŒ–éƒ½æ˜¯å›´ç»•ä¸€å¥è¯æ¥åšï¼šâ€reduce distance to the data.â€œ</p><p>Bloom Filter Index çš„ä½œç”¨æ˜¯è®¿é—® Storage ä¹‹å‰ä½¿ç”¨å¸ƒéš†ç´¢å¼•åšä¸‹æ¢æµ‹ï¼Œç„¶åå†³å®šæ˜¯å¦éœ€è¦ä»åç«¯è¯»å–çœŸæ­£çš„æ•°æ®å—ã€‚</p><img src="https://databend-1253727613.cos.ap-singapore.myqcloud.com/blog/xor-filter/bloom-filter.png" align="center" style="zoom:45%;" /><h2 id="æœ‰é—®é¢˜çš„-Bloom-Filter"><a href="#æœ‰é—®é¢˜çš„-Bloom-Filter" class="headerlink" title="æœ‰é—®é¢˜çš„ Bloom Filter"></a>æœ‰é—®é¢˜çš„ Bloom Filter</h2><p>å¤§å®¶æ‰€ç†Ÿæ‚‰çš„æ•°æ®åº“ï¼Œå¤§éƒ¨åˆ†éƒ½åœ¨ä½¿ç”¨ Bloom Filter è§£å†³ç­‰å€¼æŸ¥è¯¢çš„é—®é¢˜ï¼Œé¿å…åšä¸€äº›æ— ç”¨çš„æ•°æ®è¯»å–ã€‚</p><p>Databend ç¬¬ä¸€ç‰ˆ( <a href="https://github.com/datafuselabs/databend/pull/6639">databend#6639</a>) ä½¿ç”¨çš„ä¹Ÿæ˜¯ Bloom Filter ç»å…¸ç®—æ³•ï¼Œç»è¿‡æµ‹è¯•å‘ç°äº†ä¸€äº›é—®é¢˜ï¼š<br>Bloom Filter Index çš„ç´¢å¼•ç©ºé—´å ç”¨è¿‡å¤§ï¼ŒBloom Filter Index å¤§å°ç”šè‡³è¶…è¿‡äº†åŸå§‹æ•°æ®å¤§å°ï¼ˆä¸ºäº†è®©ç”¨æˆ·ç®€å•æ˜“ç”¨ï¼ŒDatabend ä¼šè‡ªåŠ¨ä¸ºæŸäº›æ•°æ®ç±»å‹åˆ›å»º Bloom ç´¢å¼•ï¼‰ï¼Œè¿™æ ·åš Bloom æ£€æµ‹è·Ÿç›´æ¥è¯»å–åç«¯æ•°æ®åŒºåˆ«ä¸å¤§ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰å¤ªå¤§çš„æ€§èƒ½æå‡ã€‚</p><p>åŸå› æ˜¯ Bloom Filter ç”Ÿæˆæ—¶å¹¶ä¸çŸ¥é“æ•°æ®çš„åŸºæ•°ï¼Œæ¯”å¦‚ Boolean ç±»å‹ï¼Œå®ƒä¹Ÿä¼šæ ¹æ®æ•°ç›®åˆ†é…ç©ºé—´ï¼Œå¹¶ä¸ä¼šå…³æ³¨åŸºæ•°é—®é¢˜ï¼ˆåŸºæ•°ä¸º 2ï¼ŒTrue or Falseï¼‰ã€‚</p><p>äºæ˜¯ Databend  ç¤¾åŒºå¼€å§‹äº†æ–°æ–¹æ¡ˆçš„æ¢ç´¢ä¹‹è·¯ï¼Œåˆæ­¥ç¡®å®šä¸€ä¸ªå¯è¡Œæ–¹æ¡ˆæ˜¯é€šè¿‡ HyperLoglog æ£€æµ‹å‡ºæ•°æ®å”¯ä¸€åº¦ï¼Œç„¶ååšç©ºé—´åˆ†é…ã€‚</p><p>9 æœˆä»½æŸä¸ªå‘¨å…­çš„ TiDB ç”¨æˆ·å¤§ä¼šä¸Šï¼ŒDatabend æœ‰ä¸ªå±•å°ï¼Œè·Ÿ xp(@drmingdrmer) è§é¢ï¼ˆDatabend å›¢é˜Ÿæ˜¯ Remote åŠå…¬ï¼Œå¤§å®¶çº¿ä¸‹è§é¢ä¸å¤ªå®¹æ˜“ ğŸ˜­ï¼‰é‡æ–°è®¨è®ºèµ·è¿™ä¸ªé—®é¢˜ï¼Œä»–æƒ³ç”¨ Trie æ€æƒ³æ¥è§£å†³ï¼Œæ€è·¯æŒºå¥½ï¼Œä½†å¤æ‚åº¦è¾ƒé«˜ã€‚</p><p>xp æ˜¯ Trie é¢†åŸŸçš„é«˜æ‰‹ï¼Œå·¥ç¨‹å®ç°æ¥å¯¹ä»–æ¥è¯´ä¸æ˜¯é—®é¢˜ï¼Œä½†éšçº¦æ„Ÿè§‰ä¸€äº›ç°æœ‰æŠ€æœ¯å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><img src="https://databend-1253727613.cos.ap-singapore.myqcloud.com/blog/xor-filter/tidb-databend.png" align="center" style="zoom:60%;" /><h2 id="é«˜æ€§ä»·æ¯”çš„-Xor-Filter"><a href="#é«˜æ€§ä»·æ¯”çš„-Xor-Filter" class="headerlink" title="é«˜æ€§ä»·æ¯”çš„ Xor Filter"></a>é«˜æ€§ä»·æ¯”çš„ Xor Filter</h2><p>å‘¨æ—¥è¿›è¡Œäº†ä¸€ç•ªæ¢ç´¢ï¼Œå‘ç°äº† Daniel Lemire å›¢é˜Ÿåœ¨ 2019 å¹´æå‡ºçš„ Xor Filter ç®—æ³•: <a href="https://lemire.me/blog/2019/12/19/xor-filters-faster-and-smaller-than-bloom-filters/">Xor Filters: Faster and Smaller Than Bloom Filters</a>ï¼Œä»ä»‹ç»çœ‹æ•ˆæœéå¸¸ä¸é”™ã€‚</p><img src="https://lemire.me/blog/wp-content/uploads/2019/12/comparison.png" style="zoom:45%;" /><p>æŠ±ç€è¯•è¯•çœ‹çš„å¿ƒç†ï¼ŒåŸºäº Rust ç‰ˆï¼ˆ<a href="https://github.com/prataprc/xorfilter">xorfilter</a>ï¼‰åšäº†ä¸€ä¸ªæµ‹è¯• ï¼ˆ<a href="https://github.com/BohuTANG/databend/commit/b45793c044c17cc6f8706c42bbe21201590f359f">Xor Filter Bench</a>ï¼Œå‘ç°ç–—æ•ˆéå¸¸ä¸é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">u64: </span><br><span class="line">xor bitmap encode:1230069 bytes, raw:8000000 bytes, ratio:0.15375863</span><br><span class="line"></span><br><span class="line">bool:</span><br><span class="line">xor bitmap encode:61 bytes, raw:1000000 bytes, ratio:0.000061</span><br><span class="line"></span><br><span class="line">string:</span><br><span class="line">xor bitmap encode:123067 bytes, raw:3000000 bytes, ratio:0.041022334</span><br><span class="line"></span><br><span class="line">100000 records of the same key:</span><br><span class="line">xor bitmap encode: 61 bytes, raw:3000000 bytes, ratio:0.000020333333</span><br></pre></td></tr></table></figure><p>äºæ˜¯ï¼Œåœ¨ <a href="https://github.com/datafuselabs/databend/pull/7860">databend#7860</a> å®ç°äº† Bloom Filter åˆ° Xor Filter çš„åˆ‡æ¢ï¼Œè®©æˆ‘ä»¬åšä¸€äº›æµ‹è¯•æ¥çœ‹çœ‹æ•ˆæœã€‚</p><h3 id="æµ‹è¯•ç¯å¢ƒ"><a href="#æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h3><p>Databend: <a href="https://github.com/datafuselabs/databend/releases/tag/v0.8.122-nightly">v0.8.122-nightly</a>ï¼Œå•èŠ‚ç‚¹<br>VM: 32 vCPU, 32 GiB (Cloud VM)<br>Object Store: S3<br>æ•°æ®é›†: 100 äº¿è®°å½•ï¼Œ350G Raw Dataï¼ŒXor Filter Index 700MBï¼Œç´¢å¼•å’Œæ•°æ®å…¨éƒ¨æŒä¹…åŒ–åˆ°å¯¹è±¡å­˜å‚¨<br>è¡¨ç»“æ„:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; desc t10b;</span><br><span class="line">+-------+-----------------+------+---------+-------+</span><br><span class="line">| Field | Type            | Null | Default | Extra |</span><br><span class="line">+-------+-----------------+------+---------+-------+</span><br><span class="line">| c1    | BIGINT UNSIGNED | NO   | 0       |       |</span><br><span class="line">| c2    | VARCHAR         | NO   |         |       |</span><br><span class="line">+-------+-----------------+------+---------+-------+</span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²-Databend"><a href="#éƒ¨ç½²-Databend" class="headerlink" title="éƒ¨ç½² Databend"></a>éƒ¨ç½² Databend</h3><p><strong>Step1ï¼šä¸‹è½½<a href="https://databend.rs/download">å®‰è£…åŒ…</a></strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/datafuselabs/databend/releases/download/v0.8.122-nightly/databend-v0.8.122-nightly-x86_64-unknown-linux-musl.tar.gz .</span><br><span class="line">tar zxvf databend-v0.8.122-nightly-x86_64-unknown-linux-musl.tar.gz</span><br></pre></td></tr></table></figure><p>è§£å‹åç›®å½•ç»“æ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ databend-meta</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ databend-metabench</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ databend-metactl</span><br><span class="line">â”‚Â Â  â””â”€â”€ databend-query</span><br><span class="line">â”œâ”€â”€ configs</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ databend-meta.toml</span><br><span class="line">â”‚Â Â  â””â”€â”€ databend-query.toml</span><br><span class="line">â”œâ”€â”€ readme.txt</span><br><span class="line">â””â”€â”€ scripts</span><br><span class="line">    â”œâ”€â”€ start.sh</span><br><span class="line">    â””â”€â”€ stop.sh</span><br></pre></td></tr></table></figure><p><strong>Step2ï¼šå¯åŠ¨ Databend Meta</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/databend-meta -c configs/databend-meta.toml</span><br></pre></td></tr></table></figure><p><strong>Step3ï¼šé…ç½® Databend Query</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim configs/databend-query.toml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">... ...</span><br><span class="line"></span><br><span class="line">[meta]</span><br><span class="line"># To enable embedded meta-store, set address to &quot;&quot;.</span><br><span class="line">embedded_dir = &quot;./.databend/meta_embedded_1&quot;</span><br><span class="line">address = &quot;127.0.0.1:9191&quot;</span><br><span class="line">username = &quot;root&quot;</span><br><span class="line">password = &quot;root&quot;</span><br><span class="line">client_timeout_in_second = 60</span><br><span class="line">auto_sync_interval = 60</span><br><span class="line"></span><br><span class="line"># Storage config.</span><br><span class="line">[storage]</span><br><span class="line"># fs | s3 | azblob | obs</span><br><span class="line">type = &quot;s3&quot;</span><br><span class="line"></span><br><span class="line"># To use S3-compatible object storage, uncomment this block and set your values.</span><br><span class="line"> [storage.s3]</span><br><span class="line">bucket = &quot;&lt;your-bucket-name&gt;&quot;</span><br><span class="line">endpoint_url = &quot;&lt;your-s3-endpoint&gt;&quot;</span><br><span class="line">access_key_id = &quot;&lt;your-key&gt;&quot;</span><br><span class="line">secret_access_key = &quot;&lt;your-access-key&gt;&quot;</span><br><span class="line">enable_virtual_host_style = true</span><br></pre></td></tr></table></figure><p>è¯¦ç»†éƒ¨ç½²æ–‡æ¡£è¯·å‚è€ƒï¼š <a href="https://databend.rs/doc/deploy/deploying-databend">https://databend.rs/doc/deploy/deploying-databend</a></p><p><strong>Step4ï¼š å¯åŠ¨ Databend Query</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/databend-query -c configs/databend-query.toml</span><br></pre></td></tr></table></figure><p><strong>Step5ï¼š æ„é€ æµ‹è¯•æ•°æ®é›†</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -h127.0.0.1 -P3307</span><br></pre></td></tr></table></figure><p>æ„é€  100 äº¿æ¡æµ‹è¯•æ•°æ®(è€—æ—¶ 16 min 0.41 sec):</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table t10b as select number as c1, cast(rand() as string) as c2 from numbers(10000000000)</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ï¼ˆæ— ä»»ä½•ç¼“å­˜ï¼Œæ•°æ®å’Œç´¢å¼•å…¨éƒ¨åœ¨å¯¹è±¡å­˜å‚¨ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t10b where  c2=&#x27;0.6622377673133426&#x27;;</span><br><span class="line">+-----------+--------------------+</span><br><span class="line">| c1        | c2                 |</span><br><span class="line">+-----------+--------------------+</span><br><span class="line">| 937500090 | 0.6622377673133426 |</span><br><span class="line">+-----------+--------------------+</span><br><span class="line">1 row in set (20.57 sec)</span><br><span class="line">Read 40000000 rows, 1009.75 MiB in 20.567 sec., 1.94 million rows/sec., 49.10 MiB/sec.</span><br></pre></td></tr></table></figure><p>å•èŠ‚ç‚¹ Databend åˆ©ç”¨ filter ä¸‹æ¨ï¼Œç„¶åä½¿ç”¨ Xor Filter ç´¢å¼•åšè¿‡æ»¤ï¼Œåœ¨ 100 äº¿è§„æ¨¡çš„éšæœºæ•°æ®ä¸Šåšç‚¹å¼æŸ¥è¯¢ï¼Œå¯ä»¥åœ¨ 20s å·¦å³ã€‚<br>ä¹Ÿå¯ä»¥åˆ©ç”¨ Databend çš„åˆ†å¸ƒå¼èƒ½åŠ›æ¥åŠ é€Ÿç‚¹æŸ¥ï¼ŒDatabend çš„è®¾è®¡ç†å¿µæ˜¯ä¸€ä»½æ•°æ®è®¡ç®—å¼¹æ€§æ‰©å±•ï¼Œä»å•èŠ‚ç‚¹æ‰©å±•åˆ°é›†ç¾¤æ¨¡å¼ä¹Ÿéå¸¸ç®€å•ï¼š<a href="https://databend.rs/doc/deploy/expanding-to-a-databend-cluster#deploying-a-new-query-node">Expanding a Standalone Databend</a>ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>[1] Arxiv: <a href="https://arxiv.org/abs/1912.08258">Xor Filters: Faster and Smaller Than Bloom and Cuckoo Filters</a><br>[2] Daniel Lemireâ€™s blog: <a href="https://lemire.me/blog/2019/12/19/xor-filters-faster-and-smaller-than-bloom-filters/">Xor Filters: Faster and Smaller Than Bloom Filters</a><br>[3] Databend, Cloud Lakehouse: <a href="https://github.com/datafuselabs/databend">https://github.com/datafuselabs/databend</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;åœ¨å¤§æ•°æ®åˆ†æé¢†åŸŸï¼Œå¾ˆå¤šä¼˜åŒ–éƒ½æ˜¯å›´ç»•ä¸€å¥è¯æ¥åšï¼šâ€reduce distance to the data.â€œ&lt;/p&gt;
&lt;p&gt;Bloom Fil</summary>
      
    
    
    
    
    <category term="Databend" scheme="https://bohutang.me/tags/Databend/"/>
    
    <category term="xor filter" scheme="https://bohutang.me/tags/xor-filter/"/>
    
    <category term="bloom filter" scheme="https://bohutang.me/tags/bloom-filter/"/>
    
  </entry>
  
  <entry>
    <title>è™å“¥ä¸TokuDBçš„æ•…äº‹</title>
    <link href="https://bohutang.me/2022/05/20/tokudb/"/>
    <id>https://bohutang.me/2022/05/20/tokudb/</id>
    <published>2022-05-19T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.054Z</updated>
    
    <content type="html"><![CDATA[<p>å¤©å¤©åœ¨çŸ¥ä¹ä¸Šè£…å¤§ä½¬ç»™æ–°æ‰‹ä»¬æŒ‡ç‚¹è¿·æ´¥ï¼Œå‘Šè¯‰å¤§å®¶å­¦ä¹ æ•°æ®åº“æŠ€æœ¯çš„æ–¹æ³•ï¼Œä»Šå¤©å°±æ¥èŠèŠè™å“¥æ˜¯æ€ä¹ˆè¿›å…¥æ•°æ®åº“åœˆçš„ï¼Œå’Œ TokuDB çš„æ•…äº‹ã€‚</p><p>TokuDB åˆæ˜¯ä¸ªä»€ä¹ˆä¸œä¸œå‘¢ï¼Ÿ</p><p>TokuDB æ˜¯ä¸€ä¸ªâ€œè€å¤è‘£â€œï¼Œåœ¨æœºæ¢°ç¡¬ç›˜æ—¶ä»£æ›¾é£é¡ä¸€æ—¶ï¼Œå®ƒæœ‰ç€ä¸é”™çš„å‹ç¼©ï¼ŒåŒæ—¶åˆå…¼å…·ç€ä¸é”™çš„è¯»ã€å†™èƒ½åŠ›ï¼Œè¢«å„å¤§å‚ç”¨æ¥è§£å†³å®¹é‡+æ€§èƒ½é—®é¢˜ã€‚</p><p>è¿™ä¸ªæ•…äº‹è¿˜å¾—ä» LevelDB è¯´èµ·ã€‚</p><p>2011å¹´ï¼ŒLevelDB å¼€æ”¾æºä»£ç ï¼Œå½“æ—¶è™å“¥è¢«è¿™ä¸ªæ¸…æ–°çš„ kv ç»™å¸å¼•ä½äº†ï¼Œå¾ˆå¿«å°±æŠŠå®ƒçš„æºç ç¿»äº†ä¸ªåº•æœå¤©ï¼Œå¤§æ¦‚ç†Ÿæ‚‰äº†è¿™ä¸ª kv çš„å†…éƒ¨è¿è¡Œæœºåˆ¶ï¼Œä»è¿™ä¸ªé¡¹ç›®å¼€å§‹è™å“¥å°±æ­£å¼å¼€å¯äº†ä»–çš„æ•°æ®åº“ä¹‹æ—…ã€‚</p><p>ä¸€è¾¹ç€æ‰‹å†™åŸå‹ï¼Œä¸€è¾¹è·Ÿè¸ªæ•°æ®åº“æŠ€æœ¯çš„æœ€æ–°è¿›å±•ï¼Œå½“æ—¶è™å“¥æŠŠæ¨ä¸Šä¸€äº›è·Ÿæ•°æ®åº“ç›¸å…³çš„ tag å‡ ä¹éƒ½å…³æ³¨äº†ï¼Œæ¯å¤©æ—©ä¸Šç¬¬ä¸€ä»¶äº‹å°±æ˜¯ç¿»é˜…è¿™äº› tag ç›¸å…³çš„æ¨æ–‡ï¼Œæ•°æ®åº“è¿™ç§é«˜å¤§ä¸Šçš„æŠ€æœ¯å¤ªæœ‰å¸å¼•åŠ›äº†ï¼Œæ¯å¤©éƒ½åœ¨ç¢ç£¨ç€æ€ä¹ˆèƒ½å¿«é€Ÿå…¥é—¨ï¼</p><p>æœ‰è¶£çš„çš„äº‹æƒ…æ˜¯ä» 2012 å¹´å¼€å§‹çš„ï¼Œè™å“¥å¼€å§‹å°è¯•å®ç° Skip Listï¼Œç„¶åç¢ç£¨æ€ä¹ˆä¼˜åŒ–å®ƒï¼ŒSkip List ç©è…»äº†å°±å¼€å§‹ç© B-Treeï¼Œæœ€åæ— èŠåˆ°åœ¨é¥­é¦†é—¨å£ç­‰åº§çš„æ—¶å€™å°±å¯ä»¥å†™ä¸€ä¸ª B-Treeï¼Œå½“æ—¶æƒ³ï¼šæ•°æ®åº“å°±è¿™ï¼Ÿäºæ˜¯å†³å®šå†å®ç°ä¸€ä¸ªå®Œæ•´ç‰ˆçš„ kv ï¼Œé¡¹ç›®ä»£å· <a href="https://github.com/BohuTANG/nessDB">nessDB</a>ã€‚</p><p>åœ¨ç ”å‘ nessDB è¿‡ç¨‹ä¸­ï¼Œå¶ç„¶å‘ç°äº†æ¥è‡ª MIT CSAIL çš„ã€ŠCache-Oblivious B-Treesã€‹ç³»åˆ—ï¼Œä»–ä»¬é€šè¿‡å¯¹ B-Tree åšä¸€ä¸ªå¸¸æ•°é¡¹ä¼˜åŒ–ä»è€Œè®©æ•´ä½“ IO å¤§å¹…é™ä½ï¼ŒåŸºäºè¿™ä¸ªæƒ³æ³•ä»–ä»¬åˆ›ç«‹äº† TokuTek è¿™å®¶å…¬å¸ï¼Œå…¨åŠ›ç ”å‘ TokuDB äº§å“ï¼Œå¹²æ´»çš„åŸºæœ¬éƒ½æ˜¯è€æ¿ä»¬æœ€å¾—æ„çš„å­¦ç”Ÿï¼Œ3 ä¸ªå­¦ç”Ÿåšç ”å‘ï¼Œå¤–åŠ è´å°”å®éªŒå®¤çš„è€æ‰‹ Rik åšæ¶æ„ï¼ˆè¿™ä½è€å“¥æ˜¯ä¸ªç¥äººï¼Œèƒ½åŠ›éå¸¸äº†å¾—ï¼Œè´å°”å®éªŒå®¤ç¡¬æ ¸ç²¾ç¥çš„ä½“ç°è€…ï¼Œç›®å‰å·²ç»é€€ä¼‘ï¼Œå‰æ®µæ—¶é—´è¿˜é‚€è¯·ä»–åŠ å…¥æˆ‘ä»¬çš„åˆåˆ›å…¬å¸ï¼Œç”±äºå®¶åº­åŸå› ï¼Œæš‚æ—¶æ— æ³•å…¨èŒå·¥ä½œï¼‰ã€‚</p><p>å½“æ—¶ TokuDB è¿˜æ˜¯é—­æºäº§å“ï¼Œå¾ˆå¤šèµ„æ–™éƒ½æ˜¯æ¥è‡ª TokuTek å®˜ç½‘ä»¥åŠè€æ¿ä»¬çš„å‡ ç¯‡ Paperï¼Œ2012 å¹´åº•ç»ˆäºè·Ÿ TokuDB ä¸»ç¨‹ Leif å–å¾—äº†è”ç³»ï¼Œæ¯å‘¨æˆ‘ä»¬éƒ½ä¼šé€šè¿‡gtalk è¿›è¡Œæ²Ÿé€šï¼Œåœ¨ Leif ä¸“ä¸šçš„æŒ‡å¯¼ä¸‹ï¼Œè™å“¥åœ¨ 2013 å¹´å®ç°ä¸€ä¸ªéå¸¸ç®€åŒ–çš„ TokuDB(<a href="https://bohutang.me/2020/06/20/clickhouse-and-friends-merge-tree-algo/">Fractal-Tree Index</a>)ï¼Œæ„Ÿè§‰åˆ°è¾¾äº†äººç”Ÿçš„å·…å³°ï¼Œèµ°è·¯å§¿åŠ¿éƒ½ä¸ä¸€æ ·äº†ï¼Œæˆä¸ºäº†æŒæ¡æ•°æ®åº“æ ¸å¿ƒæŠ€æœ¯çš„äººï¼</p><p>2013 å¹´ 4æœˆ 22 å·ï¼ŒTokuDB æ­£å¼å¼€æºï¼Œè™å“¥å¼€å§‹ç ”ç©¶å…¶æºç ï¼Œæœ€åå‘ç°è·Ÿä¹‹å‰æ¨æµ‹çš„å·®ä¸å¤ªå¤šï¼Œä½†æ˜¯ TokuDB ä¸ºäº†é›†æˆåˆ° MySQL ä½œä¸ºä¸€ä¸ª Storage Engineï¼Œåšäº†å¤§é‡çš„å·¥ä½œï¼Œæ¯”å¦‚ tokudb-engine å°±æ˜¯å¯¹æ¥ MySQL Plugin å±‚çš„ï¼Œè€ŒçœŸæ­£æ ¸å¿ƒçš„æ˜¯ ft-indexï¼Œä¸€ä¸ªåŸºäº Fractal-Tree å®ç°çš„ kv å­˜å‚¨ã€‚</p><p>éšåï¼Œè™å“¥ç”±äºå·¥ä½œéœ€è¦å°±å…¨é¢æŠ•å…¥ TokuDB çš„ç ”å‘å·¥ä½œï¼Œå…ˆæ˜¯ç»™ TokuDB å®ç°äº†ä¸€ä¸ª hot backupï¼Œè®© Xtrabackup ä¹Ÿå¯ä»¥çƒ­å¤‡ TokuDB çš„æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹éœ€è¦å¯¹ TokuDB å†…æ ¸åšä¸€äº›æ”¹åŠ¨ï¼Œè™å“¥æŠŠè¿™ä¸ªæ€è·¯åŒæ­¥ç»™äº† TokuTekï¼Œç»“æœä»–ä»¬å½“æ—¶çš„VP Tim ç»™å‘äº†ä¸€ä»½é‚®ä»¶ï¼š<br><code>Hey, send me your name/address, we owe you something as the &quot;first TokuDB contributor&quot;!</code></p><p>ç»“æœä»–ä»¬ä»ç¾å›½ç»™é‚®å¯„äº†ä¸€ä¸ª TokuMX çš„Tæ¤ï¼ŒTokuMX æ˜¯åŸºäº TokuDB çš„ MongoDBï¼ˆå½“æ—¶çš„ MongoDB è¿˜åœ¨ä½¿ç”¨ MMAP è‹¦è‹¦æŒ£æ‰ï¼ŒTokuMX å½“æ—¶æœ‰ä¸å°‘ç”¨æˆ·ï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªå°å°çš„ TokuDB è“è‰²è´´çº¸ï¼Œä¸Šé¢ç®€å•çš„å°ç€ â€œFirst TokuDB Contributorâ€ã€‚</p><p>è™å“¥å†…å¿ƒæ˜¯æ— æ¯”æ¿€åŠ¨çš„ï¼Œä¾ç„¶è®°å¾—é‚£ä¸ªé˜³å…‰æ˜åªšçš„ä¸‹åˆï¼Œåœ¨ç¹åçš„ WFC æ”¶åˆ°äº†ä¸€ä¸ªè¢«ç£¨èœ•çš®çš„ç¼–ç»‡è¢‹ï¼Œç”±FedExæ‰¿è¿ï¼Œè¿™æ˜¯æ¥è‡ªå¤§æ´‹å½¼å²¸çš„å…³æ€€ï¼</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/tokutek.jpg" style="zoom:60%;"/><p>éšåçš„ä¸€æ®µæ—¶é—´å†…ï¼Œå¼€æº TokuDB éƒ½æ˜¯ TokuTek åœ¨æŠ˜è…¾ï¼Œå‡ ä¹æ²¡æœ‰ç¤¾åŒºå¯è¨€ï¼Œè¿™ç§ä¸œè¥¿å¤–äººå¾ˆéš¾å…¥æ‰‹ï¼Œè€Œä¸”ä»–ä»¬çš„èƒ½åŠ›æå¼ºï¼Œé‡æ„ä¸€ä¸ªå¤§çš„æ¨¡å—å‡ å‘¨å°±æå®šï¼Œè™å“¥ä¹Ÿå­¤ç‹¬çš„ç»´æŠ¤ç€å…¬å¸å†…éƒ¨çš„ TokuDB åˆ†æ”¯ï¼Œä¿® bugï¼Œå¢åŠ  featureã€‚</p><p>2015 å¹´ 4 æœˆä»½ï¼Œè™å“¥ç››æƒ…é‚€è¯· Leif æ¥ä¸­å›½ï¼Œå¸¦ä»–é€›äº†ä¸€äº›çŸ¥åæ™¯ç‚¹ï¼Œä¸´èµ°å‰ä¸€å¤©ï¼ŒLeif æ‰¾äº†åæµ·çš„ä¸€å®¶é…’å§ï¼Œå¾ˆè±ªæƒ…çš„è¯´åæ­£å›åˆ°ç¾å›½ï¼Œæ¢æ±‡çš„äººæ°‘å¸ä¹Ÿç”¨ä¸ç€äº†ï¼Œå’±ä»¬ä¸é†‰ä¸å½’ã€‚</p><p>Leif è¾¹ç‚¹é…’è¾¹ä»‹ç»è¿™ä¸ªé…’çš„å‘³é“ä»¥åŠåœ¨ç¾å›½çš„æ¬¢è¿åº¦ï¼Œæ¯ç‚¹ä¸€ä¸ªæ–°é…’ï¼Œè‡ªå·±å…ˆå°ä¸€å£åå†æŠŠå£æ¯è½¬ 180 åº¦ï¼Œä¿©äººæ•´äº†åŠå¤©ï¼Œæœ€å Leif é€æ¼ä¸€ä¸ªæ¶ˆæ¯ï¼ŒTokuDB å·²ç»è¢«è€æ¿å–ç»™äº†Perconaï¼Œä»–ä»¬åŸç­äººé©¬ä¸€ä¸ªéƒ½ä¸ä¼šè¿‡å»ï¼Œç†ç”±æ˜¯ bla blaâ€¦ï¼ŒGoogle ç»™äº†ä»–ä»¬å›¢é˜Ÿå‘äº† Offerï¼Œä½†ä»–å‘èª“è¿™è¾ˆå­å†ä¹Ÿä¸ç¢° Database è¿™ä¸ªè¡Œä¸šï¼Œè¯´æ˜¯<strong>å¤ªè¾›è‹¦</strong>ï¼Œçœ‹æ¥ TokuDB è¿™ä¸ªäº‹æƒ…å¯¹ä»–ä»¬ä¼¤å®³è›®å¤§ã€‚</p><p>è¯è¯´ TokuDB è¢« Percona æ”¶è´­åï¼Œå¾ˆå¿«æˆä¸ºäº†ä¸€ä¸ªçƒ‚æ‘Šå­ï¼Œä¹Ÿæ…¢æ…¢åœæ­¢ç»´æŠ¤ï¼Œä»–ä»¬ CTO ä¹Ÿå¤šæ¬¡é‚€è¯·è™å“¥åŠ å…¥ï¼Œéƒ½è¢«å©‰æ‹’ã€‚</p><p>2016 å¹´ï¼Œè™å“¥å’Œ Rik æˆç«‹äº† <a href="https://github.com/xelabs">XeLabs</a> ç»„ç»‡ï¼Œè´Ÿè´£ TokuDB ç‰ˆæœ¬çš„æŒç»­ç»´æŠ¤ï¼Œè¿™ä¸ªç‰ˆæœ¬è¢«å¤šå®¶å…¬å¸ä½¿ç”¨ï¼Œç¨³å®šæ”¯æ’‘ç€ä¸Šä¸‡ä¸ª TokuDB å®ä¾‹è¿è¡Œï¼Œæœ€ç»ˆç”±äºç²¾åŠ›æœ‰é™ï¼Œé¡¹ç›®ä¹Ÿé€æ¸åœæ›´ï¼Œç»´æŠ¤ MySQL ç‰ˆæœ¬æ²¡é‚£ä¹ˆå®¹æ˜“ï¼Œæ”¹ä¸€ä¸ªå°åœ°æ–¹å°±éœ€è¦åšä¸€å †æµ‹è¯•ï¼Œå¥½æ­¹ TokuDB å·¥ç¨‹è´¨é‡éå¸¸å¥½ï¼Œbug å·²ç»å¾ˆå°‘ï¼Œå³ä½¿ç°åœ¨ä½¿ç”¨é—®é¢˜ä¹Ÿä¸å¤§ï¼Œåªæ˜¯ç°åœ¨æ˜¯ Cloud Database çš„å¤©ä¸‹ï¼Œå¾ˆå°‘æœ‰äººå†å»éƒ¨ç½² MySQL äº†ã€‚</p><p>å¥½äº†ï¼Œè¿™å°±æ˜¯è™å“¥å’Œ TokuDB çš„æ•…äº‹ã€‚</p><p>è™å“¥è¿˜æœ‰å’Œåˆ†å¸ƒå¼æ•°æ®åº“çš„æ•…äº‹ï¼Œå’Œæ•°ä»“çš„æ•…äº‹ï¼Œæ•…äº‹å¤ªå¤šäº†ï¼ŒçœŸæƒ†æ€…ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å¤©å¤©åœ¨çŸ¥ä¹ä¸Šè£…å¤§ä½¬ç»™æ–°æ‰‹ä»¬æŒ‡ç‚¹è¿·æ´¥ï¼Œå‘Šè¯‰å¤§å®¶å­¦ä¹ æ•°æ®åº“æŠ€æœ¯çš„æ–¹æ³•ï¼Œä»Šå¤©å°±æ¥èŠèŠè™å“¥æ˜¯æ€ä¹ˆè¿›å…¥æ•°æ®åº“åœˆçš„ï¼Œå’Œ TokuDB çš„æ•…äº‹ã€‚&lt;/p&gt;
&lt;p&gt;TokuDB åˆæ˜¯ä¸ªä»€ä¹ˆä¸œä¸œå‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;TokuDB æ˜¯ä¸€ä¸ªâ€œè€å¤è‘£â€œï¼Œåœ¨æœºæ¢°ç¡¬ç›˜æ—¶ä»£æ›¾é£é¡ä¸€æ—¶ï¼Œå®ƒæœ‰ç€ä¸é”™çš„å‹ç¼©ï¼ŒåŒæ—¶</summary>
      
    
    
    
    
    <category term="tokudb" scheme="https://bohutang.me/tags/tokudb/"/>
    
  </entry>
  
  <entry>
    <title>Rust, Databend and the Cloud Warehouseï¼ˆ6) å¦‚ä½•ç®€å•ã€é«˜æ•ˆçš„è¿›è¡Œç•™å­˜å’Œæ¼æ–—åˆ†æ</title>
    <link href="https://bohutang.me/2022/05/18/databend-cloud-warehouse-retention-and-funnel-analysis/"/>
    <id>https://bohutang.me/2022/05/18/databend-cloud-warehouse-retention-and-funnel-analysis/</id>
    <published>2022-05-17T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.053Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Databend æ˜¯ä¸€ä¸ªä½¿ç”¨ Rust ç ”å‘ã€å¼€æºçš„ã€å®Œå…¨é¢å‘äº‘æ¶æ„çš„æ–°å¼æ•°ä»“ï¼Œè‡´åŠ›äºæä¾›æé€Ÿçš„å¼¹æ€§æ‰©å±•èƒ½åŠ›ï¼Œæ‰“é€ æŒ‰éœ€ã€æŒ‰é‡çš„ Data Cloud äº§å“ä½“éªŒã€‚<br>å¼€æºåœ°å€ï¼š<a href="https://github.com/datafuselabs/databend">https://github.com/datafuselabs/databend</a></p></blockquote><img src="https://datafuse-1253727613.cos.ap-hongkong.myqcloud.com/learn/databend-funnel.png" align="center" style="zoom:40%;" /><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a><b>å‰è¨€</b></h2><p>éšç€ç§»åŠ¨äº’è”ç½‘çš„å‘å±•ï¼Œæˆ‘ä»¬æ—¶åˆ»éƒ½åœ¨ç”Ÿäº§ç€æ•°æ®ã€‚</p><p>å¦‚æœä½ åšäº†ä¸€æ¬¾ APPï¼Œ3 æœˆä»½æ–°å¢ç”¨æˆ· 1000 äººï¼Œä½ æ˜¯ä¸æ˜¯æƒ³äº†è§£åœ¨æœªæ¥çš„æŸäº›æ—¶é—´æ®µå†…ï¼Œè¿™éƒ¨åˆ†ç”¨æˆ·é‡Œæœ‰å¤šå°‘äººæŒç»­ä½¿ç”¨äº†ä½ çš„ APPï¼Ÿ</p><p>å¦‚æœä½ åœ¨ç»è¥ä¸€ä¸ªç”µå•†ï¼Œä½ å¯èƒ½æ›´åŠ å…³æ³¨ç”¨æˆ·åœ¨<code>ç™»å½•</code>ï¼Œ<code>è®¿é—®ï¼ˆæŸä¸ªå•†å“ï¼‰</code>ï¼Œ<code>ä¸‹å•</code>ï¼Œ<code>ä»˜æ¬¾</code>æµç¨‹é‡Œæ¯ä¸ªç¯èŠ‚çš„è½¬åŒ–ç‡ï¼Œäº†è§£ç”¨æˆ·è¡Œä¸ºè½¨è¿¹å˜åŒ–ï¼Œä»¥ç²¾å‡†ä¼˜åŒ–äº§å“è®¾è®¡ã€‚æ¯”å¦‚ï¼Œå¦‚æœ Andorid ç”¨æˆ·åœ¨ <code>ä¸‹å•</code> åˆ° <code>ä»˜æ¬¾</code>è¿™ä¸ªç¯èŠ‚è½¬åŒ–ç‡æ˜æ˜¾ä½äºå…¶ä»–å®¢æˆ·ç«¯ï¼Œè¯´æ˜ Andorid å®¢æˆ·ç«¯åœ¨ <code>ä»˜æ¬¾</code> è¿™ä¸ªç¯èŠ‚ä¸Šå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚</p><p>è¿™å°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´çš„ç”¨æˆ·ç•™å­˜å’Œæ¼æ–—è½¬åŒ–ç‡åˆ†æã€‚</p><p>å¤§éƒ¨åˆ†æ•°ä»“è¦æ»¡è¶³è¿™ä¸¤ä¸ªéœ€æ±‚ï¼ŒåŸºæœ¬éƒ½è¦å†™ä¸€å † SQL æ¥è¿›è¡Œå¤æ‚è¡¨è¾¾ï¼Œä¸”æ€§èƒ½ä½ä¸‹ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªåˆ†æä¼šé‡åº¦ä¾èµ– GROUP BYï¼Œç™¾ä¸‡çº§æ•°æ®å¯èƒ½å°±ä¼šåœ¨åˆ†é’Ÿçº§ã€‚</p><p>æœ¬ç¯‡å°±æ¥èŠèŠ Databend å¦‚ä½•åšåˆ°<strong>ç®€æ´</strong>ã€<strong>é«˜æ•ˆ</strong>çš„æ»¡è¶³è¿™ä¸¤ä¸ªéœ€æ±‚ï¼Œä½¿ç”¨ä¸€ä¸ªç®€å•çš„ SQLï¼Œ åœ¨<strong>åƒä¸‡çº§</strong>çš„æ•°æ®é›†ä¸Šä¹Ÿå¯ä»¥è½»æ¾æå®šã€‚</p><h2 id="ç•™å­˜åˆ†æ"><a href="#ç•™å­˜åˆ†æ" class="headerlink" title="ç•™å­˜åˆ†æ"></a><b>ç•™å­˜åˆ†æ</b></h2><h3 id="æ•°æ®è¡¨"><a href="#æ•°æ®è¡¨" class="headerlink" title="æ•°æ®è¡¨"></a><b>æ•°æ®è¡¨</b></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE events(`user_id` INT, `visit_date` DATE);</span><br></pre></td></tr></table></figure><ul><li><code>user_id</code>  - ç”¨æˆ· ID</li><li><code>visit_date</code> - ç”¨æˆ·è®¿é—®æ—¥æœŸ</li></ul><h3 id="æ„é€ æ•°æ®é›†"><a href="#æ„é€ æ•°æ®é›†" class="headerlink" title="æ„é€ æ•°æ®é›†"></a><b>æ„é€ æ•°æ®é›†</b></h3><p>æ„é€ ç”¨æˆ·è®¿é—®è®°å½•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># user_id ä» 0 åˆ° 10000000 åœ¨ 2022-05-15 è®¿é—®æ•°æ®</span><br><span class="line">INSERT INTO events SELECT number AS user_id, &#x27;2022-05-15&#x27; FROM numbers(10000000);</span><br><span class="line"></span><br><span class="line"># user_id ä» 0 åˆ° 5000000 åœ¨ 2022-05-16 è®¿é—®æ•°æ®</span><br><span class="line">INSERT INTO events SELECT number AS user_id, &#x27;2022-05-16&#x27; FROM numbers(5000000);</span><br><span class="line"></span><br><span class="line"># user_id ä» 0 åˆ° 100000 åœ¨ 2022-05-17 è®¿é—®æ•°æ®</span><br><span class="line">INSERT INTO events SELECT number As user_id, &#x27;2022-05-17&#x27; FROM numbers(100000);</span><br></pre></td></tr></table></figure><h3 id="ç•™å­˜åˆ†æ-1"><a href="#ç•™å­˜åˆ†æ-1" class="headerlink" title="ç•™å­˜åˆ†æ"></a><b>ç•™å­˜åˆ†æ</b></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    sum(r[0]) AS r1,</span><br><span class="line">    sum(r[1]) AS r2,</span><br><span class="line">    sum(r[2]) AS r3</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">    SELECT</span><br><span class="line">        user_id,</span><br><span class="line">        retention(login_date = &#x27;2022-05-15&#x27;, login_date = &#x27;2022-05-16&#x27;, login_date = &#x27;2022-05-17&#x27;) AS r</span><br><span class="line">    FROM events</span><br><span class="line">    GROUP BY user_id</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨ <a href="https://databend.rs/doc/reference/functions/aggregate-functions/aggregate-retention">Databend retention</a> å‡½æ•°è½»æ¾æå®šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----------+---------+--------+</span><br><span class="line">| r1       | r2      | r3     |</span><br><span class="line">+----------+---------+--------+</span><br><span class="line">| 10000000 | 5000000 | 100000 |</span><br><span class="line">+----------+---------+--------+</span><br></pre></td></tr></table></figure><ul><li><code>2022-05-15</code> æœ‰ <code>10000000</code> äººè®¿é—®</li><li><code>2022-05-16</code> æœ‰ <code>5000000</code> ä¸ªç”¨æˆ·æŒç»­è®¿é—®ï¼Œç”¨æˆ·ç•™å­˜ç‡ <code>5000000/10000000</code> &#x3D; <code>50%</code></li><li><code>2022-05-17</code> æœ‰<code>100000</code>ä¸ªç”¨æˆ·æŒç»­è®¿é—®ï¼Œç”¨æˆ·ç•™å­˜ç‡ <code>100000/10000000</code> &#x3D; <code>10%</code></li></ul><h2 id="æ¼æ–—åˆ†æ"><a href="#æ¼æ–—åˆ†æ" class="headerlink" title="æ¼æ–—åˆ†æ"></a><b>æ¼æ–—åˆ†æ</b></h2><h3 id="æ•°æ®è¡¨-1"><a href="#æ•°æ®è¡¨-1" class="headerlink" title="æ•°æ®è¡¨"></a><b>æ•°æ®è¡¨</b></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE events(user_id BIGINT, event_name VARCHAR, event_timestamp TIMESTAMP);</span><br></pre></td></tr></table></figure><ul><li><code>user_id</code>  - ç”¨æˆ· ID</li><li><code>event_name</code> - äº‹ä»¶ç±»å‹ï¼š<code>ç™»å½•</code>ï¼Œ <code>è®¿é—®</code> ï¼Œ<code>ä¸‹å•</code> ï¼Œ<code>ä»˜æ¬¾</code></li><li><code>event_timestamp</code> - äº‹ä»¶æ—¶é—´ï¼ˆ<a href="https://databend.rs/doc/reference/data-types/data-type-time-date-types">Databend TIMESTAMP</a> ç±»å‹ç²¾åº¦æ˜¯å°æ•°ç‚¹å 6 ä½ï¼Œ å¾®ç§’ï¼ˆmicrosecondï¼‰ï¼‰</li></ul><h3 id="æ„é€ æ•°æ®é›†-1"><a href="#æ„é€ æ•°æ®é›†-1" class="headerlink" title="æ„é€ æ•°æ®é›†"></a><b>æ„é€ æ•°æ®é›†</b></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># ç”¨æˆ· 100123 äº‹ä»¶</span><br><span class="line">INSERT INTO events VALUES(100123, &#x27;ç™»å½•&#x27;, &#x27;2022-05-14 10:01:00&#x27;);</span><br><span class="line">INSERT INTO events VALUES(100123, &#x27;è®¿é—®&#x27;, &#x27;2022-05-14 10:02:00&#x27;);</span><br><span class="line">INSERT INTO events VALUES(100123, &#x27;ä¸‹å•&#x27;, &#x27;2022-05-14 10:04:00&#x27;);</span><br><span class="line">INSERT INTO events VALUES(100123, &#x27;ä»˜æ¬¾&#x27;, &#x27;2022-05-14 10:10:00&#x27;);</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ· 100125 äº‹ä»¶</span><br><span class="line">INSERT INTO events VALUES(100125, &#x27;ç™»å½•&#x27;, &#x27;2022-05-15 11:00:00&#x27;);</span><br><span class="line">INSERT INTO events VALUES(100125, &#x27;è®¿é—®&#x27;, &#x27;2022-05-15 11:01:00&#x27;);</span><br><span class="line">INSERT INTO events VALUES(100125, &#x27;ä¸‹å•&#x27;, &#x27;2022-05-15 11:02:00&#x27;);</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ· 100126 äº‹ä»¶</span><br><span class="line">INSERT INTO events VALUES(100126, &#x27;ç™»å½•&#x27;, &#x27;2022-05-15 12:00:00&#x27;);</span><br><span class="line">INSERT INTO events VALUES(100126, &#x27;è®¿é—®&#x27;, &#x27;2022-05-15 12:01:00&#x27;);</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ· 100127 äº‹ä»¶</span><br><span class="line">INSERT INTO events VALUES(100127, &#x27;ç™»å½•&#x27;, &#x27;2022-05-15 11:30:00&#x27;);</span><br><span class="line">INSERT INTO events VALUES(100127, &#x27;è®¿é—®&#x27;, &#x27;2022-05-15 11:31:00&#x27;);</span><br></pre></td></tr></table></figure><h3 id="æ¼æ–—åˆ†æ-1"><a href="#æ¼æ–—åˆ†æ-1" class="headerlink" title="æ¼æ–—åˆ†æ"></a><b>æ¼æ–—åˆ†æ</b></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    level,</span><br><span class="line">    count() AS count</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">    SELECT</span><br><span class="line">        user_id,</span><br><span class="line">        window_funnel(3600000000)(event_timestamp, event_name = &#x27;ç™»å½•&#x27;, event_name = &#x27;è®¿é—®&#x27;, event_name = &#x27;ä¸‹å•&#x27;, event_name = &#x27;ä»˜æ¬¾&#x27;) AS level</span><br><span class="line">    FROM events</span><br><span class="line">    GROUP BY user_id</span><br><span class="line">)</span><br><span class="line">GROUP BY level ORDER BY level ASC;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+-------+-------+</span><br><span class="line">| level | count |</span><br><span class="line">+-------+-------+</span><br><span class="line">|     2 |     2 |</span><br><span class="line">|     3 |     1 |</span><br><span class="line">|     4 |     1 |</span><br><span class="line">+-------+-------+</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨ <a href="https://databend.rs/doc/reference/functions/aggregate-functions/aggregate-windowfunnel">Databend window_funnel</a> å‡½æ•°å¯¹ç”¨æˆ·åœ¨ 1 å°æ—¶çª—å£å†…ï¼Œè¿›è¡Œäº‹ä»¶é“¾ä¸‹é’»åˆ†æã€‚</p><p>ä¸€å°æ—¶å†…ï¼šæœ‰å¤šå°‘ç”¨æˆ·ç™»å½•ï¼ˆlevel-1) â€“&gt; æœ‰å¤šå°‘ç”¨æˆ·è®¿é—®ï¼ˆlevel-2ï¼‰ â€“&gt; æœ‰å¤šå°‘ç”¨æˆ·ä¸‹å•ï¼ˆlevel-3ï¼‰ â€“&gt; æœ‰å¤šå°‘ç”¨æˆ·ä»˜æ¬¾ï¼ˆlevel-4ï¼‰</p><p>ä»ç»“æœæ¥çœ‹ï¼š</p><ul><li><p><code>ç™»å½• --&gt; è®¿é—®</code> è¿™æ¡äº‹ä»¶é“¾ä¸Šæ€»å…±æœ‰ 2 ä¸ªç”¨æˆ·ï¼Œ<code>100126</code> å’Œ <code>100127</code></p></li><li><p><code>ç™»å½• --&gt; è®¿é—® --&gt; ä¸‹å•</code> è¿™æ¡äº‹ä»¶é“¾ä¸Šæœ‰ 1 ä½ç”¨æˆ·ï¼Œ<code>100125</code></p></li><li><p><code>ç™»å½• --&gt; è®¿é—® --&gt; ä¸‹å• --&gt; è´­ä¹°</code> è¿™æ¡äº‹ä»¶é“¾ä¸Šæ€»å…±æœ‰ 1 ä½ç”¨æˆ·ï¼Œ<code>100123</code></p></li></ul><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è½»æ¾è®¡ç®—å‡ºæ¯ä¸ªé˜¶æ®µçš„è½¬åŒ–ç‡ã€‚</p><h2 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a><b>æ€§èƒ½</b></h2><p>ä»ä¸Šé¢ç¤ºä¾‹å¯ä»¥çœ‹å‡ºï¼Œç•™å­˜å’Œæ¼æ–—åˆ†æéƒ½é‡åº¦ä¾èµ–  <code>GROUP BY user_id</code>ï¼Œå¦‚æœ <code>user_id</code> è¾ƒå¤šï¼Œå¯¹ <code>GROUP BY</code>  è®¡ç®—é€Ÿåº¦æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼ŒDatabend åœ¨ <code>GROUP BY</code>ä¸Šåšäº†å¤§é‡çš„ä¼˜åŒ–ï¼Œç›®å‰æ€§èƒ½å·²ç»éå¸¸å¼ºæ‚ï¼Œå…·ä½“æœºåˆ¶å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  <a href="https://mp.weixin.qq.com/s?__biz=Mzg4NzYzMzk1Mw==&mid=2247484933&idx=1&sn=f6fa2d04e5864602e00b0be4ef163e99">Databend çš„ Group By èšåˆæŸ¥è¯¢ä¸ºä»€ä¹ˆè·‘çš„è¿™ä¹ˆå¿«ï¼Ÿ</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><b>æ€»ç»“</b></h2><p>Databend ç•™å­˜ï¼ˆRETENTIONï¼‰å‡½æ•°å’Œæ¼æ–—åˆ†æï¼ˆWINDOW_FUNNELï¼‰å‡½æ•°å»å¹´å·²ç»å®ç°ï¼ŒæŠŠå¤æ‚çš„é€»è¾‘è¿›è¡Œå°è£…ï¼Œè®©ç”¨æˆ·ä½¿ç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿ã€‚</p><p>Databend ä½œä¸ºä¸€ä¸ªæ–°ä¸€ä»£äº‘æ•°ä»“ï¼Œåœ¨è®¾è®¡ä¸Šåšäº†ä¸€ä¸ªå¾ˆå¤§çš„è½¬å˜ï¼š<strong>æ•°æ®ä¸å†æ˜¯é‡å¿ƒï¼Œç”¨æˆ·çš„ä½“éªŒæ‰æ˜¯</strong>ã€‚</p><p>å¯¹äºä¸€ä¸ªæ•°ä»“äº§å“ï¼Œç›¸ä¿¡å¤§éƒ¨åˆ†ç”¨æˆ·éƒ½å¸Œæœ›ï¼š</p><ul><li>ä¸å†ä¸ºå­˜å‚¨ç©ºé—´å‘æ„</li><li>ä¸å†ä¸ºè®¡ç®—èµ„æºå‘æ„</li><li>å¼€ç®±å³ç”¨ï¼ŒçœŸæ­£çš„æŒ‰éœ€ã€æŒ‰é‡ä»˜è´¹</li></ul><p>éšç€äº‘åŸºç¡€è®¾æ–½çš„å‘å±•ï¼Œæˆ‘ä»¬åœ¨ Databend Platform é‡Œè®©è¿™ä¸€åˆ‡éƒ½å˜æˆäº†å¯èƒ½ã€‚</p><p>åŸºäºå¼€æº <a href="https://github.com/datafuselabs/databend">Databend</a> å†…æ ¸ã€AWS EC2 è®¡ç®—èµ„æºã€S3 çš„å¯¹è±¡å­˜å‚¨ï¼ŒåŠ ä¸Šè‡ªç ”çš„ Serverless Infrastructureï¼ŒDatabend å›¢é˜Ÿå³å°†æ¨å‡ºä»–ä»¬çš„ç¬¬ä¸€ä¸ªä¼ä¸šçº§äº§å“ï¼šDatabend Platformã€‚</p><p>æ¥ï¼Œè®©æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹åœ¨ Databend Platform é‡Œå¦‚ä½•åšæ¼æ–—åˆ†æï¼š</p><ol><li>é€‰æ‹© Worksheet</li><li>é€‰æ‹©ä¼‘çœ çš„ Warehouse</li><li>æ‰§è¡Œæ¼æ–—åˆ†æ SQLï¼Œè‡ªåŠ¨å”¤é†’ Warehouse</li><li>Warehouse è‡ªåŠ¨ä¼‘çœ </li><li>å°±æ˜¯è¿™ä¹ˆç®€å•</li></ol><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/blog-window-funnel.gif" align="center" style="zoom:45%;" />]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Databend æ˜¯ä¸€ä¸ªä½¿ç”¨ Rust ç ”å‘ã€å¼€æºçš„ã€å®Œå…¨é¢å‘äº‘æ¶æ„çš„æ–°å¼æ•°ä»“ï¼Œè‡´åŠ›äºæä¾›æé€Ÿçš„å¼¹æ€§æ‰©å±•èƒ½åŠ›ï¼Œæ‰“é€ æŒ‰éœ€ã€æŒ‰é‡çš„ Data Cloud äº§å“ä½“éªŒã€‚&lt;br&gt;å¼€æºåœ°å€ï¼š&lt;a href=&quot;https://github.com/datafus</summary>
      
    
    
    
    
    <category term="databend" scheme="https://bohutang.me/tags/databend/"/>
    
    <category term="user retention" scheme="https://bohutang.me/tags/user-retention/"/>
    
    <category term="window funnel" scheme="https://bohutang.me/tags/window-funnel/"/>
    
    <category term="funnel conversion" scheme="https://bohutang.me/tags/funnel-conversion/"/>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://bohutang.me/2022/05/08/ecdsa-rsa/"/>
    <id>https://bohutang.me/2022/05/08/ecdsa-rsa/</id>
    <published>2022-05-07T16:00:00.000Z</published>
    <updated>2022-11-22T03:22:56.823Z</updated>
    
    <content type="html"><![CDATA[<h2 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h2><p>ç›¸ä¿¡å¾ˆå¤šåŒå­¦è¿˜åœ¨ä½¿ç”¨ RSA ç®—æ³•ç”¨äºç”Ÿæˆ SSH å…¬é’¥ï¼Œå¯èƒ½è¿˜ä¼šçº ç»“é€‰æ‹©å¤šå°‘ä½æ‰è¶³å¤Ÿå®‰å…¨ï¼Œä¸€èˆ¬å»ºè®®æ˜¯ 4096 bits:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -C &quot;your_email@example.com&quot;</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬çš„å…¬é’¥(public key) å°±ä¼šéå¸¸é•¿ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat test_rsa_4096.pub</span><br><span class="line"></span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCXlH8OxqMFhv2+En10yV2ZorDzRFXQm9pPuWQ8G5iu+cUpyhwDoKnd+l6PCZTrCgcVJgLSsVAVbZ3CK6Qnoj3TDQl4yaj90UasmivWM2INc2hObr5P2y2AqWnnZBXmxpoUGZPz/9323JalC+m/EwXNcdrC5JzgD083BC0ykfB801vcAzrZwsnbKfCUsGfUNP9mco3+hFwTqgfJxEvmI3X6hbGIGY1d2QbGMLrs3JYVsfRzJDjFaYOSwXZR6pM5uUCKENt9hOmVUZfuZqvlzLZX95yc53a6qNgOJhzaFZYz3wD2gY0dNp1boGnAtXsLqEnqtm9skp05iMuT01B9WrKEOZG5rsRZDh3bYXJ8ZP0lO/RbStuBczd8ZgObb32NfUyHG2JObDpm9mjsvWZqJxJbT5l/6vMXu8hQ6ikDrf6R33PRcRdbUIrAOpDUrfBxjkUonxjqqEbHhpcAlMWNJ4qcjtjvSnLOhH9GBn5KCnFJ7VIbyXc+Gj9AAp9xuV/9jv1R7CathkS2QrC5s9pFY3I24mFevpkioEeJYPAYUTuFBenWg5MdFK99FYO44wjmFa/RxwEQtYFXV+RybTJTC0eDpjK1u3w7LVm2JjEVoSfOJIKt9yZQn5Fm0kmueBz5aQ4CzZNoZBMKr7TT0dX9cJoANzd19uM4uCV6HRVJmQyz4Q== your_email@example.com</span><br></pre></td></tr></table></figure><h2 id="Ed25519"><a href="#Ed25519" class="headerlink" title="Ed25519"></a>Ed25519</h2><p>å…¶å®ï¼Œæœ‰ä¸€äº›æ›´å…ˆè¿›çš„ç®—æ³•ï¼Œæ¯” RSA æ›´å®‰å…¨ï¼Œå…¬é’¥æ›´ç®€çŸ­ï¼Œéšç€åŒºå—é“¾çš„æ™®åŠï¼Œå®ƒä»¬æ­£æ…¢æ…¢è¢«æ›´å¤šçš„äººæ¥å—ï¼Œæ¯”å¦‚ Ed25519ï¼Œè™½ç„¶å®ƒåªæœ‰ 256 bitï¼Œä½†å®‰å…¨æ€§æ¯” RSA 3072 è¿˜è¦é«˜ã€‚</p><p>Ed25519 SSH Key ç”Ÿæˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t ed25519 -C &quot;your_email@example.com&quot;</span><br></pre></td></tr></table></figure><p>å…¬é’¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat test_ed25519.pub </span><br><span class="line">ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGcMXqCXtcjny9gXV1NDmwArHy0AgJs+R7N6XpOutviw your_email@example.com</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Github å·²ç»é»˜è®¤æ¨èå¤§å®¶ä½¿ç”¨ Ed25519: <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent">https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent</a></p><p>Ed25519 æ˜¯ä¸€ä¸ªæ¤­åœ†æ›²çº¿ï¼Œéå¸¸ä¼˜ç¾ï¼Œå®‰å…¨æ€§ç»è¿‡æ•°å­¦ä¸¥æ ¼è¯æ˜ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/ed25519.png" style="zoom:45%;">         By Deirdre Connolly in [State of the Curve] (2016)<p>è¿™é‡Œæœ‰ä¸€ä»½ç›®å‰ä½¿ç”¨ Ed25519 çš„åˆ—è¡¨ï¼š <a href="https://ianix.com/pub/ed25519-deployment.html">https://ianix.com/pub/ed25519-deployment.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;RSA&quot;&gt;&lt;a href=&quot;#RSA&quot; class=&quot;headerlink&quot; title=&quot;RSA&quot;&gt;&lt;/a&gt;RSA&lt;/h2&gt;&lt;p&gt;ç›¸ä¿¡å¾ˆå¤šåŒå­¦è¿˜åœ¨ä½¿ç”¨ RSA ç®—æ³•ç”¨äºç”Ÿæˆ SSH å…¬é’¥ï¼Œå¯èƒ½è¿˜ä¼šçº ç»“é€‰æ‹©å¤šå°‘ä½æ‰è¶³å¤Ÿå®‰å…¨ï¼Œä¸€èˆ¬å»ºè®®æ˜¯ 4096 bits:&lt;/p&gt;</summary>
      
    
    
    
    
    <category term="ecdsa" scheme="https://bohutang.me/tags/ecdsa/"/>
    
    <category term="ed25519" scheme="https://bohutang.me/tags/ed25519/"/>
    
    <category term="rsa" scheme="https://bohutang.me/tags/rsa/"/>
    
  </entry>
  
  <entry>
    <title>Rust, Databend and the Cloud Warehouseï¼ˆ5ï¼‰ä» Git åˆ° Fuse Engine å­˜å‚¨å¼•æ“</title>
    <link href="https://bohutang.me/2022/05/06/databend-cloud-warehouse-fuse-engine/"/>
    <id>https://bohutang.me/2022/05/06/databend-cloud-warehouse-fuse-engine/</id>
    <published>2022-05-05T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.053Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Databend æ˜¯ä¸€ä¸ªä½¿ç”¨ Rust ç ”å‘ã€å¼€æºçš„ã€å®Œå…¨é¢å‘äº‘æ¶æ„çš„æ–°å¼æ•°ä»“ï¼Œè‡´åŠ›äºæä¾›æé€Ÿçš„å¼¹æ€§æ‰©å±•èƒ½åŠ›ï¼Œæ‰“é€ æŒ‰éœ€ã€æŒ‰é‡çš„ Data Cloud äº§å“ä½“éªŒã€‚<br>å¼€æºåœ°å€ï¼š<a href="https://github.com/datafuselabs/databend">https://github.com/datafuselabs/databend</a></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a><b>å‰è¨€</b></h2><p>è¿™ç¯‡æ¥ä»‹ç»ä¸‹ Databend åº•åº§ï¼š Fuse Engineï¼Œä¸€ä¸ªåŠ¨åŠ›æ¾æ¹ƒçš„åˆ—å¼å­˜å‚¨å¼•æ“ï¼ŒDatabend Fuse Engine åœ¨è®¾è®¡ä¹‹åˆç¤¾åŒºç»™å®ƒçš„å®šä½æ˜¯ï¼š<b>åŠ¨åŠ›è¦æ¾æ¹ƒï¼Œæ¶æ„è¦ç®€å•ï¼Œå¯é æ€§è¦é«˜ã€‚</b><br>åœ¨æ­£å¼ä»‹ç»ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ç»„â€œæŒ‘æˆ˜æ•°æ®â€ï¼ŒDatabend Fuse Engine + AWS S3ï¼Œä¸€ä¸ªäº‹åŠ¡åœ¨ ~1.5 å°æ—¶å†™å…¥äº† 22.89 TB åŸå§‹æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO ontime_new SELECT * FROM ontime_new;</span><br><span class="line">Query OK, 0 rows affected (1 hour 34 min 36.82 sec)</span><br><span class="line">Read 31619274180 rows, 22.89 TB in 5675.207 sec., 5.57 million rows/sec., 4.03 GB/sec.</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œåœ¨åŠŸèƒ½ä¸Šè¦æ»¡è¶³ï¼š</p><ul><li>åˆ†å¸ƒå¼äº‹åŠ¡ï¼šæ”¯æŒå¤šä¸ªè®¡ç®—èŠ‚ç‚¹åŒæ—¶è¯»ã€å†™åŒä¸€ä»½æ•°æ®ï¼ˆå­˜ç®—åˆ†ç¦»æ¶æ„é¦–å…ˆè¦è§£å†³çš„é—®é¢˜ï¼‰</li><li>å¿«ç…§éš”ç¦»ï¼šä¸åŒç‰ˆæœ¬æ•°æ®ä¹‹é—´äº’ä¸å½±å“ï¼Œæ–¹ä¾¿åš Table Zero-Copy</li><li>å›æº¯èƒ½åŠ›ï¼šå¯åˆ‡æ¢åˆ°ä»»æ„ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ–¹ä¾¿åš Time Travel</li><li>æ•°æ®åˆå¹¶ï¼šåˆå¹¶åç”Ÿæˆæ–°ç‰ˆæœ¬æ•°æ®</li><li>ç®€å•ã€å¥å£®ï¼šå…³ç³»é€šè¿‡æ–‡ä»¶æ¥æè¿°ï¼ŒåŸºäºè¿™äº›æ–‡ä»¶å³å¯æ¢å¤å‡ºæ•´ä¸ªæ•°æ®ç³»ç»Ÿ</li></ul><p>ä»è¿™äº›éœ€æ±‚å‡ºå‘ï¼Œä½ ä¼šå‘ç° Fuse Engine è·Ÿ Git â€œå½¢ä¼¼â€ï¼ˆGit-inspiredï¼‰ï¼Œåœ¨ä»‹ç» Fuse Engine è®¾è®¡ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Git åº•å±‚æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><h2 id="Git-å·¥ä½œæœºåˆ¶"><a href="#Git-å·¥ä½œæœºåˆ¶" class="headerlink" title="Git å·¥ä½œæœºåˆ¶"></a><b>Git å·¥ä½œæœºåˆ¶</b></h2><p>Git è§£å†³äº†åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®ç‰ˆæœ¬ç®¡ç†ï¼ˆdata version controlï¼‰é—®é¢˜ï¼Œå®ƒæœ‰éš”ç¦»ï¼ˆbranchï¼‰ã€æäº¤ï¼ˆcommitï¼‰ã€å›æº¯ï¼ˆcheckoutï¼‰ï¼Œä»¥åŠåˆå¹¶ï¼ˆmergeï¼‰åŠŸèƒ½ï¼ŒåŸºäº Git è¯­ä¹‰å®Œå…¨å¯ä»¥æ‰“é€ å‡ºä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨å¼•æ“ã€‚å¸‚é¢ä¸Šä¹Ÿå‡ºç°ä¸€äº›åŸºäº Git-like æ€æƒ³è€Œæ„å»ºçš„äº§å“ï¼Œæ¯”å¦‚ <a href="https://projectnessie.org/">Nessie - Transactional Catalog for Data Lakes</a> å’Œ <a href="https://lakefs.io/">lakeFS</a> ã€‚</p><p>ä¸ºäº†æ›´å¥½çš„æ¢ç´¢ Git åº•å±‚å·¥ä½œæœºåˆ¶ï¼Œæˆ‘ä»¬é€‰æ‹©ä»æ•°æ®åº“è§’åº¦å‡ºå‘ï¼Œä½¿ç”¨ Git è¯­ä¹‰æ¥å®Œæˆä¸€ç³»åˆ—â€œæ•°æ®â€æ“ä½œã€‚</p><ol><li>é¦–å…ˆï¼Œ å‡†å¤‡ä¸€ä¸ªæ•°æ®æ–‡ä»¶ <code>cloud.txt</code>ï¼Œå†…å®¹ä¸º:</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2022/05/06, Databend, Cloud</span><br></pre></td></tr></table></figure><ol start="2"><li>æŠŠ <code>cloud.txt</code> æ•°æ®å†™åˆ° Git ç³»ç»Ÿï¼š</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -m &quot;Add olap.txt&quot;</span><br></pre></td></tr></table></figure><ol start="3"><li>Git ä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªå¿«ç…§ï¼ŒCommit ID ä¸º <code>7d972c7ba9213c2a2b15422d4f31a8cbc9815f71</code>ï¼š</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git log </span><br><span class="line">commit 7d972c7ba9213c2a2b15422d4f31a8cbc9815f71 (HEAD)</span><br><span class="line">Author: BohuTANG &lt;overred.shuttler@gmail.com&gt;</span><br><span class="line">Date:   Fri May 6 16:44:21 2022 +0800</span><br><span class="line"></span><br><span class="line">    Add cloud.txt</span><br></pre></td></tr></table></figure><ol start="4"><li>å†å‡†å¤‡ä¸€ä¸ªæ–°æ–‡ä»¶ <code>warehouse.txt</code></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2022/05/07, Databend, Warehouse</span><br></pre></td></tr></table></figure><ol start="5"><li>æŠŠ <code>warehouse.txt</code> æ•°æ®å†™åˆ° Git ç³»ç»Ÿ</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -m &quot;Add warehouse.txt&quot;</span><br></pre></td></tr></table></figure><ol start="6"><li>Git ä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªæ–°çš„å¿«ç…§ï¼ŒCommit ID ä¸º  <code>15af34e4d16082034e1faeaddd0332b3836f1424</code></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">commit 15af34e4d16082034e1faeaddd0332b3836f1424 (HEAD)</span><br><span class="line">Author: BohuTANG &lt;overred.shuttler@gmail.com&gt;</span><br><span class="line">Date:   Fri May 6 17:41:43 2022 +0800</span><br><span class="line"></span><br><span class="line">    Add warehouse.txt</span><br><span class="line"></span><br><span class="line">commit 7d972c7ba9213c2a2b15422d4f31a8cbc9815f71</span><br><span class="line">Author: BohuTANG &lt;overred.shuttler@gmail.com&gt;</span><br><span class="line">Date:   Fri May 6 16:44:21 2022 +0800</span><br><span class="line"></span><br><span class="line">    Add cloud.txt</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒGit å·²ç»ä¸ºæˆ‘ä»¬ç»´æŠ¤äº† 2 ä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ID 15af34e4d16082034e1faeaddd0332b3836f1424ï¼Œç‰ˆæœ¬2</span><br><span class="line">ID 7d972c7ba9213c2a2b15422d4f31a8cbc9815f71ï¼Œç‰ˆæœ¬1</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥æ ¹æ® Commit ID è¿›è¡Œç‰ˆæœ¬é—´çš„ä»»æ„åˆ‡æ¢ï¼Œä¹Ÿå°±æ˜¯å®ç°äº† Time Travel å’Œ Table Zero-Copy åŠŸèƒ½ï¼Œé‚£ä¹ˆ Git åº•å±‚æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ æ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå®ƒé€šè¿‡å¼•å…¥ 3 ç±»å¯¹è±¡æ–‡ä»¶æ¥è¿›è¡Œå…³ç³»æè¿°ï¼š</p><ul><li>Commit æ–‡ä»¶ï¼Œç”¨äºæè¿° tree å¯¹è±¡ä¿¡æ¯</li><li>Tree æ–‡ä»¶ï¼Œç”¨äºæè¿° blob å¯¹è±¡ä¿¡æ¯</li><li>Blob æ–‡ä»¶ï¼Œç”¨äºæè¿°æ–‡ä»¶ä¿¡æ¯</li></ul><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/fuse-engien-git.png" align="center" style="zoom:45%;" /><h3 id="HEAD-æ–‡ä»¶"><a href="#HEAD-æ–‡ä»¶" class="headerlink" title="HEAD æ–‡ä»¶"></a><b>HEAD æ–‡ä»¶</b></h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ª HEAD  æŒ‡é’ˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat .git/HEAD</span><br><span class="line">15af34e4d16082034e1faeaddd0332b3836f1424</span><br></pre></td></tr></table></figure><h3 id="Commit-æ–‡ä»¶"><a href="#Commit-æ–‡ä»¶" class="headerlink" title="Commit æ–‡ä»¶"></a><b>Commit æ–‡ä»¶</b></h3><p>Commit æ–‡ä»¶ä¼šè®°å½•è·Ÿ commit ç›¸å…³çš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯ï¼Œæ¯”å¦‚å½“å‰ tree ä»¥åŠ parentï¼Œè¿˜æœ‰æäº¤äººç­‰ï¼Œæ–‡ä»¶è·¯å¾„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.git/objects/15/af34e4d16082034e1faeaddd0332b3836f1424</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p 15af34e4d16082034e1faeaddd0332b3836f1424</span><br><span class="line"></span><br><span class="line">tree 576c63e580846fa6df2337c1f074c8d840e0b70a</span><br><span class="line">parent 7d972c7ba9213c2a2b15422d4f31a8cbc9815f71</span><br><span class="line">author BohuTANG &lt;overred.shuttler@gmail.com&gt; 1651830103 +0800</span><br><span class="line">committer BohuTANG &lt;overred.shuttler@gmail.com&gt; 1651830103 +0800</span><br><span class="line"></span><br><span class="line">Add warehouse.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Tree-æ–‡ä»¶"><a href="#Tree-æ–‡ä»¶" class="headerlink" title="Tree æ–‡ä»¶"></a><b>Tree æ–‡ä»¶</b></h3><p>Tree æ–‡ä»¶è®°å½•å½“å‰ç‰ˆæœ¬ä¸‹æ‰€æœ‰çš„æ•°æ®æ–‡ä»¶ï¼Œæ–‡ä»¶è·¯å¾„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.git/objects/57/6c63e580846fa6df2337c1f074c8d840e0b70a</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p 576c63e580846fa6df2337c1f074c8d840e0b70a</span><br><span class="line"></span><br><span class="line">100644 blob 688de5069f9e873c7e7bd15aa67c6c33e0594ddecloud.txt</span><br><span class="line">100644 blob bdea812b9602ed3c6662a2231b3f1e7b52dc1ccbwarehouse.txt</span><br></pre></td></tr></table></figure><h3 id="Blob-æ–‡ä»¶"><a href="#Blob-æ–‡ä»¶" class="headerlink" title="Blob æ–‡ä»¶"></a><b>Blob æ–‡ä»¶</b></h3><p>Blob æ–‡ä»¶æ˜¯åŸå§‹æ•°æ®æ–‡ä»¶ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡ <code>git cat-file</code> å‘½ä»¤æ¥æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼ˆå¦‚æœä½¿ç”¨ Git æ¥ç®¡ç†ä»£ç ï¼ŒBlob å°±æ˜¯æˆ‘ä»¬çš„ä»£ç æ–‡ä»¶ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p 688de5069f9e873c7e7bd15aa67c6c33e0594dde</span><br><span class="line">2022/05/06, Databend, Cloud</span><br><span class="line"></span><br><span class="line">git cat-file -p bdea812b9602ed3c6662a2231b3f1e7b52dc1ccb</span><br><span class="line">2022/05/07, Databend, Warehouse</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Fuse-Engine"><a href="#Fuse-Engine" class="headerlink" title="Fuse Engine"></a><b>Fuse Engine</b></h2><p>Databend Fuse Engine åœ¨è®¾è®¡ä¸Šï¼Œè·Ÿ Git éå¸¸ç±»ä¼¼ï¼Œå®ƒå¼•å…¥ 3 ä¸ªæè¿°æ–‡ä»¶ï¼š</p><ul><li>Snapshot æ–‡ä»¶ï¼Œç”¨äºæè¿° Segment å¯¹è±¡ä¿¡æ¯</li><li>Segment æ–‡ä»¶ï¼Œç”¨äºæè¿° Block å¯¹è±¡ä¿¡æ¯</li><li>Block æ–‡ä»¶ï¼Œç”¨äºæè¿° Parquet æ–‡ä»¶ä¿¡æ¯</li></ul><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/fuse-engine-fuse.png" align="center" style="zoom:45%;" /><p>æˆ‘ä»¬ç»§ç»­åœ¨ Fuse Engine é‡Œè¿›è¡Œä¸€æŠŠåˆšæ‰åœ¨ Git è¿›è¡Œçš„æ“ä½œã€‚</p><ol><li>é¦–å…ˆ<a href="https://databend.rs/doc/reference/sql/ddl/table/ddl-create-table">åˆ›å»ºä¸€ä¸ªè¡¨</a>:</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE git(file VARCHAR, content VARCHAR);</span><br></pre></td></tr></table></figure><ol start="2"><li><p>æŠŠ <code>cloud.txt</code> æ•°æ®å†™åˆ° Fuse Engine</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO git VALUES(&#x27;cloud.txt&#x27;, &#x27;2022/05/06, Databend, Cloud&#x27;);</span><br></pre></td></tr></table></figure></li><li><p>Fuse ä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªæ–°çš„ Snapshot ID <code>6450690b09c449939a83268c49c12bb2</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CALL system$fuse_snapshot(&#x27;default&#x27;, &#x27;git&#x27;);</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">         snapshot_id: 6450690b09c449939a83268c49c12bb2</span><br><span class="line">   snapshot_location: 53/133/_ss/6450690b09c449939a83268c49c12bb2_v1.json</span><br><span class="line">      format_version: 1</span><br><span class="line">previous_snapshot_id: NULL</span><br><span class="line">       segment_count: 1</span><br><span class="line">         block_count: 1</span><br><span class="line">           row_count: 1</span><br><span class="line">  bytes_uncompressed: 68</span><br><span class="line">    bytes_compressed: 351</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>æŠŠ <code>warehouse.txt</code> æ•°æ®å†™åˆ° Fuse Engine</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO git VALUES(&#x27;warehouse.txt&#x27;, &#x27;2022/05/07, Databend, Warehouse&#x27;);</span><br></pre></td></tr></table></figure></li><li><p>Fuse Engine ä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªæ–°çš„ Snapshot ID <code>efe2687fd1fc48f8b414b5df2cec1e19</code>ï¼Œå¹¶æŒ‡å‘å‰ä¸€ä¸ª Snapshot ID <code>6450690b09c449939a83268c49c12bb2</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CALL system$fuse_snapshot(&#x27;default&#x27;, &#x27;git&#x27;);</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">         snapshot_id: efe2687fd1fc48f8b414b5df2cec1e19</span><br><span class="line">   snapshot_location: 53/133/_ss/efe2687fd1fc48f8b414b5df2cec1e19_v1.json</span><br><span class="line">      format_version: 1</span><br><span class="line">previous_snapshot_id: 6450690b09c449939a83268c49c12bb2</span><br><span class="line">       segment_count: 2</span><br><span class="line">         block_count: 2</span><br><span class="line">           row_count: 2</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">         snapshot_id: 6450690b09c449939a83268c49c12bb2</span><br><span class="line">   snapshot_location: 53/133/_ss/6450690b09c449939a83268c49c12bb2_v1.json</span><br><span class="line">      format_version: 1</span><br><span class="line">previous_snapshot_id: NULL</span><br><span class="line">       segment_count: 1</span><br><span class="line">         block_count: 1</span><br><span class="line">           row_count: 1</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç›®å‰ä¸ºæ­¢ï¼ŒFuse Engine ä¸ºæˆ‘ä»¬ç”Ÿæˆäº† 2 ä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ID efe2687fd1fc48f8b414b5df2cec1e19ï¼Œç‰ˆæœ¬2</span><br><span class="line">ID 6450690b09c449939a83268c49c12bb2ï¼Œç‰ˆæœ¬1</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯è·Ÿ Git éå¸¸ç±»ä¼¼ï¼Ÿ</p></li></ol><h3 id="HEAD"><a href="#HEAD" class="headerlink" title="HEAD"></a><b>HEAD</b></h3><p>è·Ÿ Git ä¸€æ ·ï¼ŒFuse Engine ä¹Ÿéœ€è¦ä¸€ä¸ª HEAD ä½œä¸ºå…¥å£ï¼ŒæŸ¥çœ‹ Fuse Engine çš„ HEADï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE TABLE git\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: git</span><br><span class="line">Create Table: CREATE TABLE `git` (</span><br><span class="line">  `file` VARCHAR,</span><br><span class="line">  `content` VARCHAR</span><br><span class="line">) ENGINE=FUSE SNAPSHOT_LOCATION=&#x27;53/133/_ss/efe2687fd1fc48f8b414b5df2cec1e19_v1.json&#x27;</span><br></pre></td></tr></table></figure><p><code>SNAPSHOT_LOCATION</code> å°±æ˜¯ HEADï¼Œé»˜è®¤æŒ‡å‘æœ€æ–°çš„å¿«ç…§ <code>efe2687fd1fc48f8b414b5df2cec1e19</code>ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•åˆ‡åˆ° ID ä¸º <code>6450690b09c449939a83268c49c12bb2</code> çš„å¿«ç…§æ•°æ®å‘¢ï¼Ÿ å¾ˆç®€å•ï¼Œå…ˆæŸ¥çœ‹å½“å‰è¡¨çš„ Snapshot ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CALL system$fuse_snapshot(&#x27;default&#x27;, &#x27;git&#x27;)\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">         snapshot_id: efe2687fd1fc48f8b414b5df2cec1e19</span><br><span class="line">   snapshot_location: 53/133/_ss/efe2687fd1fc48f8b414b5df2cec1e19_v1.json</span><br><span class="line">      format_version: 1</span><br><span class="line">previous_snapshot_id: 6450690b09c449939a83268c49c12bb2</span><br><span class="line">       segment_count: 2</span><br><span class="line">         block_count: 2</span><br><span class="line">           row_count: 2</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">         snapshot_id: 6450690b09c449939a83268c49c12bb2</span><br><span class="line">   snapshot_location: 53/133/_ss/6450690b09c449939a83268c49c12bb2_v1.json</span><br><span class="line">      format_version: 1</span><br><span class="line">previous_snapshot_id: NULL</span><br><span class="line">       segment_count: 1</span><br><span class="line">         block_count: 1</span><br><span class="line">           row_count: 1</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºä¸€ä¸ªæ–°è¡¨ï¼ˆgit_v1ï¼‰å¹¶æŠŠ <code>SNAPSHOT_LOCATION</code> æŒ‡å‘ç›¸åº”çš„ Snapshot æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE git_v1(`file` VARCHAR, `content` VARCHAR) SNAPSHOT_LOCATION=&#x27;53/133/_ss/6450690b09c449939a83268c49c12bb2_v1.json&#x27;;</span><br><span class="line"></span><br><span class="line">SELECT * FROM git_v1;</span><br><span class="line">+-----------+-----------------------------+</span><br><span class="line">| file      | content                     |</span><br><span class="line">+-----------+-----------------------------+</span><br><span class="line">| cloud.txt | 2022/05/06, Databend, Cloud |</span><br><span class="line">+-----------+-----------------------------+</span><br></pre></td></tr></table></figure><h3 id="Snapshot-æ–‡ä»¶"><a href="#Snapshot-æ–‡ä»¶" class="headerlink" title="Snapshot æ–‡ä»¶"></a><b>Snapshot æ–‡ä»¶</b></h3><p>ç”¨äºå­˜å‚¨ Segment ä¿¡æ¯ï¼Œæ–‡ä»¶è·¯å¾„ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">53/133/_ss/efe2687fd1fc48f8b414b5df2cec1e19_v1.json</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;format_version&quot;:1,</span><br><span class="line">   &quot;snapshot_id&quot;:&quot;efe2687f-d1fc-48f8-b414-b5df2cec1e19&quot;,</span><br><span class="line">   &quot;prev_snapshot_id&quot;:[</span><br><span class="line">      &quot;6450690b-09c4-4993-9a83-268c49c12bb2&quot;,</span><br><span class="line">      1</span><br><span class="line">   ],</span><br><span class="line">   </span><br><span class="line">   &quot;segments&quot;:[</span><br><span class="line">      [</span><br><span class="line">         &quot;53/133/_sg/df56e911eb26446b9f8fac5acc65a580_v1.json&quot;</span><br><span class="line">      ],</span><br><span class="line">      [</span><br><span class="line">         &quot;53/133/_sg/d0bff902b98846469480b23c2a8f93d7_v1.json&quot;</span><br><span class="line">      ]</span><br><span class="line">   ]</span><br><span class="line">   ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Segment-æ–‡ä»¶"><a href="#Segment-æ–‡ä»¶" class="headerlink" title="Segment æ–‡ä»¶"></a><b>Segment æ–‡ä»¶</b></h3><p>ç”¨äºå­˜å‚¨ Block ç›¸å…³ä¿¡æ¯ï¼Œæ–‡ä»¶è·¯å¾„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">53/133/_sg/df56e911eb26446b9f8fac5acc65a580_v1.json</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;format_version&quot;:1,</span><br><span class="line">   &quot;blocks&quot;:[</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;row_count&quot;:1,</span><br><span class="line">         &quot;block_size&quot;:76,</span><br><span class="line">         &quot;file_size&quot;:360,</span><br><span class="line">         &quot;location&quot;:[</span><br><span class="line">            &quot;53/133/_b/ba4a60013e27479e856f739aefeadfaf_v0.parquet&quot;,</span><br><span class="line">            0</span><br><span class="line">         ],</span><br><span class="line">         &quot;compression&quot;:&quot;Lz4Raw&quot;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">   ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Block-æ–‡ä»¶"><a href="#Block-æ–‡ä»¶" class="headerlink" title="Block æ–‡ä»¶"></a><b>Block æ–‡ä»¶</b></h3><p>Fuse Engine åº•å±‚æ•°æ®ä½¿ç”¨ Parquet æ ¼å¼ï¼Œæ¯ä¸ªæ–‡ä»¶å†…éƒ¨æœ‰å¤šä¸ª Block ç»„æˆã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a><b>å°ç»“</b></h2><p>Databend Fuse Engine åœ¨æ—©æœŸè®¾è®¡ï¼ˆ2021 å¹´ 10 æœˆï¼‰æ—¶å€™ï¼Œéœ€æ±‚å¾ˆæ˜ç¡®ï¼Œä½†æ–¹æ¡ˆé€‰å‹è¿˜æ˜¯ç»å†è¿‡ä¸€æ®µå°æ›²æŠ˜ã€‚å½“æ—¶ï¼ŒDatabend ç¤¾åŒºè°ƒç ”äº†å¸‚é¢ä¸Šå¤§é‡çš„ Table Format æ–¹æ¡ˆï¼ˆæ¯”å¦‚ Iceberg ç­‰ï¼‰ï¼Œå½“æ—¶é¢ä¸´çš„æŒ‘æˆ˜æ˜¯åŸºäºç°æœ‰æ–¹æ¡ˆè¿˜æ˜¯è‡ªå·±é€ ä¸€å¥—ï¼Ÿæœ€ç»ˆé€‰æ‹©ç ”å‘ä¸€å¥—ç®€æ´çš„ã€é€‚åˆè‡ªå·±çš„ Storage Engineï¼Œä½†æ•°æ®å­˜å‚¨æ ¼å¼é€‰æ‹© Parquet æ ‡å‡†ã€‚<br>åœ¨ Fuse Engine é‡Œï¼Œæˆ‘ä»¬æŠŠ Parquet Footer å•ç‹¬å­˜æ”¾ï¼Œä»¥å‡å°‘ä¸å¿…è¦çš„ Seek æ“ä½œï¼Œå¦å¤–å¢åŠ äº†ä¸€å¥—æ›´åŠ çµæ´»çš„ç´¢å¼•æœºåˆ¶ï¼Œæ¯”å¦‚ Aggregationï¼ŒJoin ç­‰éƒ½å¯ä»¥æœ‰è‡ªå·±çš„ç´¢å¼•æ¥è¿›è¡ŒåŠ é€Ÿã€‚</p><p>æ¬¢è¿ä½“éªŒ Fuse Engineï¼ŒæŒ‚ä¸Šå¯¹è±¡å­˜å‚¨ï¼Œè®©ä½ ä½“éªŒä¸ä¸€æ ·çš„å¤§æ•°æ®åˆ†æ <a href="https://databend.rs/doc/deploy">https://databend.rs/doc/deploy</a><br>Databend å¼€æºåœ°å€ï¼š<a href="https://github.com/datafuselabs/databend">https://github.com/datafuselabs/databend</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Databend æ˜¯ä¸€ä¸ªä½¿ç”¨ Rust ç ”å‘ã€å¼€æºçš„ã€å®Œå…¨é¢å‘äº‘æ¶æ„çš„æ–°å¼æ•°ä»“ï¼Œè‡´åŠ›äºæä¾›æé€Ÿçš„å¼¹æ€§æ‰©å±•èƒ½åŠ›ï¼Œæ‰“é€ æŒ‰éœ€ã€æŒ‰é‡çš„ Data Cloud äº§å“ä½“éªŒã€‚&lt;br&gt;å¼€æºåœ°å€ï¼š&lt;a href=&quot;https://github.com/datafus</summary>
      
    
    
    
    
    <category term="databend" scheme="https://bohutang.me/tags/databend/"/>
    
    <category term="git" scheme="https://bohutang.me/tags/git/"/>
    
    <category term="cloud warehouse" scheme="https://bohutang.me/tags/cloud-warehouse/"/>
    
  </entry>
  
  <entry>
    <title>Rust, Databend and the Cloud Warehouseï¼ˆ4ï¼‰Databend ç¤¾åŒºå¦‚ä½•åšæµ‹è¯•</title>
    <link href="https://bohutang.me/2021/09/14/databend-cloud-warehouse-how-to-test/"/>
    <id>https://bohutang.me/2021/09/14/databend-cloud-warehouse-how-to-test/</id>
    <published>2021-09-14T07:41:00.000Z</published>
    <updated>2022-08-27T08:25:55.053Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Databend æ˜¯ä¸€ä¸ªä½¿ç”¨ Rust ç ”å‘ã€å¼€æºçš„ã€å®Œå…¨é¢å‘äº‘æ¶æ„çš„æ–°å¼æ•°ä»“ï¼Œè‡´åŠ›äºæä¾›æé€Ÿçš„å¼¹æ€§æ‰©å±•èƒ½åŠ›ï¼Œæ‰“é€ æŒ‰éœ€ã€æŒ‰é‡çš„ Data Cloud äº§å“ä½“éªŒã€‚<br>å¼€æºåœ°å€ï¼š<a href="https://github.com/datafuselabs/databend">https://github.com/datafuselabs/databend</a></p></blockquote><p>Databend ä»ç¬¬ä¸€å¤©å°±æ˜¯å¼€æºçš„ï¼Œæµ‹è¯•ç³»ç»Ÿä¹Ÿæ˜¯åŸºäºå¼€æºç”Ÿæ€æ‰€æ„å»ºï¼Œä½¿ç”¨äº†å¤§é‡çš„ github CIï¼ˆå…è´¹ï¼‰ï¼Œå·²ç»æ”¯æ’‘äº†æˆ‘ä»¬åŠå¹´æ¥çš„å¿«é€Ÿè¿­ä»£ã€‚</p><p>å¯¹äºä¸€ä¸ªå¼€æºæ•°æ®åº“é¡¹ç›®ï¼Œåšåˆ°å¯æµ‹è¯•æ€§æ˜¯åŠ é€Ÿè¿­ä»£çš„ä¸äºŒæ³•å®ã€‚ä¸€ä¸ª Pull Request (é€šå¸¸è¯´çš„ Patch) ä»æäº¤åˆ°åˆå¹¶åˆ°ä¸»å¹²åˆ†æ”¯ï¼Œä½œä¸ºä¸€ä¸ª Review äººå‘˜ä¼šæ¯”è¾ƒå…³æ³¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜:</p><ol><li>æ˜¯å¦ä¼šå¯¼è‡´åŠŸèƒ½ä¸æ­£å¸¸ï¼Ÿ</li><li>æ˜¯å¦ä¼šå½±å“åˆ†å¸ƒå¼æ‰§è¡Œï¼Ÿ</li><li>æ˜¯å¦æœ‰è·¨å¹³å°ç¼–è¯‘é—®é¢˜ï¼Ÿ</li><li>æ˜¯å¦ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Ÿ</li></ol><p>æœ¬ç¯‡å°±ä»ä¸€ä¸ª Pull Request æµ‹è¯•å‘¨æœŸè¯´èµ·ï¼Œçœ‹çœ‹å®ƒä»åˆ›å»ºå†åˆ°åˆå¹¶å…¥ä¸»å¹²åˆ†æ”¯ï¼ŒDatabend ç»è¿‡äº†å“ªäº›æµ‹è¯•ï¼Œé’ˆå¯¹ä¸Šé¢å››ä¸ªé—®é¢˜åšåˆ°å¿ƒä¸­æœ‰æ•°ï¼Œè®©æ¯ä¸ª Pull Request éƒ½æœ‰è´¨é‡ä¿éšœã€‚</p><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a><strong>å•å…ƒæµ‹è¯•</strong></h3><p>å•å…ƒæµ‹è¯•æ˜¯æœ€å°çš„æµ‹è¯•å•å…ƒã€‚</p><p>æˆ‘ä»¬æ¯å†™ä¸€ä¸ªå‡½æ•°éƒ½è¦åšåˆ°å¯ç‹¬ç«‹æµ‹è¯•ï¼Œå¦‚æœè¿™ä¸ªå‡½æ•°æœ‰å…¶ä»–çŠ¶æ€ä¾èµ–ï¼Œé‚£çŠ¶æ€ä¹Ÿè¦æ˜¯å¯ä»¥ Mock çš„ã€‚</p><p>åœ¨ Databend ä¸­ï¼Œå•å…ƒæµ‹è¯•éƒ½æ”¾åœ¨ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚ï¼Œx_test.rs:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_y</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">   ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›®å‰ Databend æœ‰ 500+ çš„å•å…ƒæµ‹è¯•ï¼Œå¹¶å¯¹ä¸€äº›çŠ¶æ€åšäº†å…¨å±€ Mockï¼Œè®©å¼€å‘è€…æ›´åŠ å®¹æ˜“çš„ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼Œä»¥ä»ä»£ç å±‚é¢ç¡®ä¿å‡½æ•°æ‰§è¡Œéƒ½ç¬¦åˆé¢„æœŸï¼Œå°½æ—©çš„å‘ç°å’Œè§£å†³é—®é¢˜ã€‚</p><p>Databend çš„å•å…ƒæµ‹è¯•ä¼šåœ¨ Ubuntu å’Œ MacOS ä¸¤ä¸ªç³»ç»Ÿä¸Šè¿è¡Œ ï¼ˆDatabend ç ”å‘ä¸»è¦ä½¿ç”¨ Mac å’Œ Ubuntu ä¸¤ä¸ªä¸»åŠ›ç³»ç»Ÿï¼‰ã€‚</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/test-unit.png" style="zoom:50%;"/><h3 id="åŠŸèƒ½æµ‹è¯•"><a href="#åŠŸèƒ½æµ‹è¯•" class="headerlink" title="åŠŸèƒ½æµ‹è¯•"></a><strong>åŠŸèƒ½æµ‹è¯•</strong></h3><p>å½“å•å…ƒæµ‹è¯•é€šè¿‡åï¼Œå¹¶ä¸ä¸€å®šä¿è¯åŠŸèƒ½æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºåŠŸèƒ½é€šå¸¸æ¥è¯´æ˜¯ç”±å¤šä¸ªå‡½æ•°é€»è¾‘æ€§çš„è´¯ç©¿è€Œæˆã€‚</p><p>åŠŸèƒ½æµ‹è¯•åˆåˆ†ä¸º Stateless å’Œ Stateful ä¸¤ç§æ¨¡å‹ï¼Œå…¶ä¸­ Stateless æµ‹è¯•æ¨¡å‹ä¸éœ€è¦åŠ è½½æ•°æ®é›†ï¼Œ Stateful æµ‹è¯•æ¨¡å‹åˆ™éœ€è¦åŠ è½½é¢„å€¼çš„æ•°æ®é›†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç€é‡çœ‹ä¸‹ Stateless æµ‹è¯•æ¨¡å‹ã€‚</p><p>Databend å‚è€ƒäº† ClickHouse çš„åšæ³•ï¼Œä½¿ç”¨è¡¨å‡½æ•° <code>numbers_mt</code> æ¥ä¾¿æ·çš„åš Stateless æµ‹è¯•ã€‚</p><p>æ¯”å¦‚è¿™ä¸ªç¨å¾®â€œå¤æ‚â€çš„SQLï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT number%3 as c1, number%2 as c2 FROM numbers_mt(10000) WHERE number &gt; 2 GROUP BY number%3, number%2 ORDER BY c1, c2;</span><br></pre></td></tr></table></figure><p>å®ƒå…ˆæ ¹æ®æ¡ä»¶è¿‡æ»¤æ•°æ®ï¼Œç„¶åå†è¿›è¡Œ GROUP BY åˆ†ç»„ï¼Œæœ€ååšä¸€ä¸ªæ’åºï¼Œè¿™ä¸ª SQL æ‰§è¡Œæ—¶ï¼Œä¼šæ¶‰åŠéå¸¸å¤šçš„å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»æœ‰ä¸€å¥—ä¾¿æ·çš„æœºåˆ¶æ¥ä¿è¯å¤šä¸ªå‡½æ•°ç»„æˆçš„åŠŸèƒ½ä¹Ÿæ˜¯æ­£ç¡®çš„ã€‚</p><p>Databend æ˜¯å¦‚ä½•åšçš„å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬ä¼šå…ˆå®šä¹‰ä¸€ä¸ªéœ€è¦æµ‹è¯•çš„ SQL é›†ï¼Œx.sqlï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> number<span class="operator">%</span><span class="number">3</span> <span class="keyword">as</span> c1, number<span class="operator">%</span><span class="number">2</span> <span class="keyword">as</span> c2 <span class="keyword">FROM</span> numbers_mt(<span class="number">10000</span>) <span class="keyword">WHERE</span> number <span class="operator">&gt;</span> <span class="number">2</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> number<span class="operator">%</span><span class="number">3</span>, number<span class="operator">%</span><span class="number">2</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> c1, c2;</span><br></pre></td></tr></table></figure><p>ç„¶åå†å®šä¹‰ä¸€ä¸ªé¢„æœŸçš„ç»“æœé›†ï¼Œx.resultï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0  0</span><br><span class="line">0  1</span><br><span class="line">1  0</span><br><span class="line">1  1</span><br><span class="line">2  0</span><br><span class="line">2  1</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡åšåŠŸèƒ½æµ‹è¯•çš„æ—¶å€™ï¼ŒDatabend ä¼šè°ƒç”¨è¿™ä¸ª x.sql æ–‡ä»¶ï¼Œç„¶åæŠŠå¾—åˆ°çš„ç»“æœé›†å’Œ x.result æ–‡ä»¶è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœæœ‰å‡ºå…¥åˆ™æŠ¥é”™å¹¶ç»™å‡ºæç¤ºä¿¡æ¯ã€‚</p><p>ç”±äº Databend å…·å¤‡åˆ†å¸ƒå¼çš„ MPP èƒ½åŠ›ï¼Œæ‰€ä»¥åŠŸèƒ½æµ‹è¯•ä¼šåœ¨å•æœºï¼ˆStandaloneï¼‰å’Œ é›†ç¾¤ï¼ˆClusterï¼‰ä¸¤ç§æ¨¡å¼ä¸‹è¿›è¡Œå›å½’æµ‹è¯•ï¼Œä»¥ç¡®ä¿ Patch å¯¹åŠŸèƒ½æ²¡æœ‰å½±å“ã€‚</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/test-stateless.png" style="zoom:50%;"/><h3 id="æ€§èƒ½æµ‹è¯•"><a href="#æ€§èƒ½æµ‹è¯•" class="headerlink" title="æ€§èƒ½æµ‹è¯•"></a><strong>æ€§èƒ½æµ‹è¯•</strong></h3><p>å½“å•å…ƒæµ‹è¯•å’ŒåŠŸèƒ½æµ‹è¯•éƒ½é€šè¿‡åï¼Œæˆ‘ä»¬è¿˜ä¼šå…³æ³¨ä¸€ä¸ªé‡è¦çš„æŒ‡æ ‡ï¼šè¿™ä¸ª Patch æ˜¯å¦å¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Ÿæˆ–è€…æ˜¯ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–çš„ Patch æå‡äº†å¤šå°‘æ€§èƒ½ï¼Ÿ</p><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼ŒDatabend ä½¿ç”¨æ•°å­—æ¥åšé‡åŒ–ï¼Œæˆ‘ä»¬åªéœ€åœ¨ Pull Request é‡Œå›å¤: <code>/run-perf master</code> CI ä¼šè‡ªåŠ¨ç¼–è¯‘å½“å‰åˆ†æ”¯ç„¶åè·‘ç›¸åº”çš„æ€§èƒ½æµ‹è¯•ï¼Œå†è·Ÿ master åšå¯¹æ¯”å¹¶ç”Ÿæˆä¸€ä»½æ€§èƒ½å¯¹æ¯”æŠ¥å‘Šï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/test-perf-report.png" style="zoom:50%;"/><p>è¿™æ ·ï¼ŒReview äººå‘˜å°±å¯ä»¥æ ¹æ®è¿™ä¸ªæŠ¥å‘Šæ¸…æ™°çš„çŸ¥é“å½“å‰ Patch å¯¹æ€§èƒ½çš„å½±å“ï¼Œä»¥ç¡®ä¿æ¯ä¸ª Patch åœ¨æ€§èƒ½ä¸Šéƒ½æ˜¯å¯æ§çš„ã€‚</p><h3 id="ç¼–è¯‘æµ‹è¯•"><a href="#ç¼–è¯‘æµ‹è¯•" class="headerlink" title="ç¼–è¯‘æµ‹è¯•"></a><strong>ç¼–è¯‘æµ‹è¯•</strong></h3><p>Databend ç›®æ ‡æ˜¯æ‰“é€ ä¸€ä¸ªè·¨å¹³å°çš„ Cloud Warehouseï¼Œæ‰€ä»¥è¦æ±‚æ¯ä¸ª Patch åœ¨ä»¥ä¸‹å‡ ä¸ªå¹³å°éƒ½å¯ä»¥æ­£å¸¸ç¼–è¯‘å’Œå·¥ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- &#123;os: ubuntu-latest, toolchain: stable, target: x86_64-unknown-linux-gnu, cross: false&#125;</span><br><span class="line">- &#123;os: ubuntu-latest, toolchain: stable, target: aarch64-unknown-linux-gnu, cross: true&#125;</span><br><span class="line">- &#123;os: ubuntu-latest, toolchain: stable, target: arm-unknown-linux-gnueabi, cross: true&#125;</span><br><span class="line">- &#123;os: ubuntu-latest, toolchain: stable, target: armv7-unknown-linux-gnueabihf, cross: true&#125;</span><br><span class="line">- &#123;os: macos-latest, toolchain: stable, target: x86_64-apple-darwin, cross: false&#125;</span><br></pre></td></tr></table></figure><p>å½“è¿™ä¸ª CI è·‘å®Œåï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç¡®çš„çŸ¥é“å½“å‰ Patch å¯¹è·¨ç‰ˆæœ¬ç¼–è¯‘æ˜¯æ²¡æœ‰å½±å“çš„ã€‚</p><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a><strong>å°ç»“</strong></h3><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/test-all-passed.png" style="zoom:50%;"/><p>ä»¥ä¸Šæ‰€æœ‰çš„ CI æµ‹è¯•éƒ½é€šè¿‡åï¼Œæˆ‘ä»¬çš„ Pull Request æ‰ç®—åˆæ ¼ï¼Œå…·å¤‡åˆå¹¶åˆ°ä¸»å¹²åˆ†æ”¯çš„æ¡ä»¶ã€‚</p><p>å¦‚æœæ²¡æœ‰è¿™äº›è‡ªåŠ¨åŒ–æµ‹è¯• CI åšä¿éšœï¼Œæ¯ä¸ªé—®é¢˜éƒ½ä¼šæ¶ˆè€— Review äººå‘˜å¤§é‡çš„ç²¾åŠ›å»åšéªŒè¯ï¼Œè¿™ç§æ¨¡å¼è‚¯å®šä¸å¯æŒä¹…ï¼Œä¸¥é‡å½±å“äº§å“çš„è¿­ä»£é€Ÿåº¦ï¼Œæ‹–æ…¢ç¤¾åŒºçš„èŠ‚å¥ã€‚</p><p>Databend ä»ç¬¬ä¸€å¤©å¼€å§‹å°±åœ¨åŠªåŠ›æ‰“é€ ä¸€ä¸ªå¯æµ‹è¯•çš„ç³»ç»Ÿï¼Œä¸ºæ­¤æˆ‘ä»¬ç ”å‘äº† test-infra ä»¥åŠç¤¾åŒºåä½œçš„ fusebot æœºå™¨äººï¼Œä»¥åŠ é€Ÿ Databend äº§å“è¿­ä»£ï¼Œå°½å¿«æä¾›ä¸€ä¸ªå¯è¯•ç”¨çš„ Alpha ç‰ˆæœ¬ã€‚</p><h3 id="References"><a href="#References" class="headerlink" title="References"></a><strong>References</strong></h3><ol><li><a href="https://github.com/datafuselabs/databend">Databend: A Modern Real-Time Data Processing &amp; Analytics DBMS with Cloud-Native Architecture</a></li><li><a href="https://github.com/datafuselabs/databend/tree/master/.github/workflows">Databend Github Workflows</a></li><li><a href="https://github.com/datafuselabs/test-infra">Databend Test Infra</a></li><li><a href="https://github.com/datafuselabs/fusebots">Databend FuseBots</a></li><li><a href="https://clickhouse.tech/docs/en/development/tests/">ClickHouse Testing</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Databend æ˜¯ä¸€ä¸ªä½¿ç”¨ Rust ç ”å‘ã€å¼€æºçš„ã€å®Œå…¨é¢å‘äº‘æ¶æ„çš„æ–°å¼æ•°ä»“ï¼Œè‡´åŠ›äºæä¾›æé€Ÿçš„å¼¹æ€§æ‰©å±•èƒ½åŠ›ï¼Œæ‰“é€ æŒ‰éœ€ã€æŒ‰é‡çš„ Data Cloud äº§å“ä½“éªŒã€‚&lt;br&gt;å¼€æºåœ°å€ï¼š&lt;a href=&quot;https://github.com/datafus</summary>
      
    
    
    
    
    <category term="databend" scheme="https://bohutang.me/tags/databend/"/>
    
    <category term="cloud warehouse" scheme="https://bohutang.me/tags/cloud-warehouse/"/>
    
  </entry>
  
  <entry>
    <title>Rust, Databend and the Cloud Warehouseï¼ˆ3ï¼‰Datafuse æ›´åä¸º Databend</title>
    <link href="https://bohutang.me/2021/09/14/datafuse-cloud-warehouse-rename-databend/"/>
    <id>https://bohutang.me/2021/09/14/datafuse-cloud-warehouse-rename-databend/</id>
    <published>2021-09-13T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.054Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Databend æ˜¯ä¸€ä¸ªä½¿ç”¨ Rust ç ”å‘ã€å¼€æºçš„ã€å®Œå…¨é¢å‘äº‘æ¶æ„çš„æ–°å¼æ•°ä»“ï¼Œè‡´åŠ›äºæä¾›æé€Ÿçš„å¼¹æ€§æ‰©å±•èƒ½åŠ›ï¼Œæ‰“é€ æŒ‰éœ€ã€æŒ‰é‡çš„ Data Cloud äº§å“ä½“éªŒã€‚<br>å¼€æºåœ°å€ï¼š<a href="https://github.com/datafuselabs/databend">https://github.com/datafuselabs/databend</a></p></blockquote><p>æ­¤ç¯‡ä¸ç®—ä¸€ä¸ªæŠ€æœ¯æ–‡ç« ï¼Œä½†æ˜¯æ¯”è¾ƒé‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬é¡¹ç›®æ”¹åäº†ï¼Œåšä¸ªè¯´æ˜ã€‚</p><h3 id="é¡¹ç›®æ›´ååŸå› "><a href="#é¡¹ç›®æ›´ååŸå› " class="headerlink" title="é¡¹ç›®æ›´ååŸå› "></a><strong>é¡¹ç›®æ›´ååŸå› </strong></h3><p>Datafuse å’Œå¼€æºé¡¹ç›® DataFusion åç§°åœ¨è‹±è¯­è¯­å¢ƒé‡Œæ¯”è¾ƒæ¥è¿‘ï¼Œä¸ºäº†å¤§å®¶æœªæ¥çš„å‘å±•ï¼Œæˆ‘ä»¬å†³å®šæŠŠé¡¹ç›®æ›´åä¸ºï¼šDatabend ã€‚</p><p>ç”±äºæ–‡åŒ–å·®å¼‚å¯¼è‡´çš„ä¸€äº›è¯¯è§£ï¼Œå¤§å®¶èŠå¼€åä¹Ÿå°±åŒ–è§£äº†ï¼Œæ„Ÿè°¢ Andy çš„ç†è§£å’Œæ”¯æŒï¼Œç›¸ä¿¡ DataFusion å’Œ  Databend éƒ½æœ‰ç€ç¾å¥½çš„å‰æ™¯ã€‚</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/databend-andy-comment.png" style="zoom:50%;"/><h3 id="Databend-å¯“æ„"><a href="#Databend-å¯“æ„" class="headerlink" title="Databend å¯“æ„"></a><strong>Databend å¯“æ„</strong></h3><p>ç›¸å¯¹è®ºæ˜¯ 20 ä¸–çºªæœ€ä¼Ÿå¤§çš„å‘ç°ä¹‹ä¸€ï¼Œç”±äºç‰©è´¨çš„å­˜åœ¨ï¼Œæ—¶é—´å’Œç©ºé—´ä¼šå‘ç”Ÿå¼¯æ›²ï¼ˆspace-time bendï¼‰ï¼Œå®ƒè®©äººç±»é‡æ–°å®¡è§†æ—¶é—´ä¸ç©ºé—´ã€‚æˆ‘ä»¬æœŸæœ› Databend çš„å‡ºç°ï¼Œè®©æ›´å¤šäººé‡æ–°å®¡è§†æ•°æ®ï¼Œå‘æ˜å‡ºæ›´å¤§çš„ä»·å€¼ã€‚</p><h3 id="å…³äº-ã€ŒDatafuse-Labsã€"><a href="#å…³äº-ã€ŒDatafuse-Labsã€" class="headerlink" title="å…³äº ã€ŒDatafuse Labsã€"></a><strong>å…³äº ã€ŒDatafuse Labsã€</strong></h3><p>ã€ŒDatafuse Labsã€æˆç«‹äº 2021 å¹´ 3 æœˆï¼Œæ˜¯å¼€æºé¡¹ç›® Databend çš„èƒŒåå›¢é˜Ÿï¼Œå›¢é˜Ÿåœ¨äº‘åŸç”Ÿæ•°æ®åº“é¢†åŸŸæœ‰ç€ä¸°å¯Œçš„å·¥ç¨‹ç»éªŒï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ•°æ®åº“å¼€æºç¤¾åŒºæ´»è·ƒè´¡çŒ®è€…ï¼Œç›®å‰åœ¨ä¸­å›½ã€ç¾å›½ã€æ–°åŠ å¡å‡è®¾æœ‰ç ”å‘ä¸­å¿ƒï¼Œè‡´åŠ›äºæˆä¸ºä¸šç•Œé¢†å…ˆçš„ Data Cloud åŸºç¡€è½¯ä»¶ä¾›åº”å•†ã€‚</p><h3 id="åŠ å…¥æˆ‘ä»¬"><a href="#åŠ å…¥æˆ‘ä»¬" class="headerlink" title="åŠ å…¥æˆ‘ä»¬"></a><strong>åŠ å…¥æˆ‘ä»¬</strong></h3><ul><li><p>æ•°æ®åº“å·¥ç¨‹å¸ˆï¼šè´Ÿè´£ Databend å†…æ ¸è®¾è®¡ä¸ç ”å‘ï¼Œæœ‰ä¸°å¯Œçš„åˆ†å¸ƒå¼ç³»ç»Ÿç»éªŒï¼Œç†Ÿæ‚‰ Rust æˆ– C++ ï¼Œå¯¹æ•°æ®åº“æœ‰ç€æµ“åšçš„å…´è¶£ï¼Œå¯ Worldwide Remote åŠå…¬ã€‚</p></li><li><p>äº‘å¹³å°å·¥ç¨‹å¸ˆï¼šè´Ÿè´£ Databend Cloud äº§å“è®¾è®¡ä¸ç ”å‘ï¼Œæœ‰ Kubernetes å¼€å‘ç»éªŒè€…ä¼˜å…ˆï¼Œå¯ Worldwide Remote åŠå…¬ã€‚<br>å¦‚æœå¯¹æˆ‘ä»¬æ„Ÿå…´è¶£ï¼Œç®€å†è¯·æŠ•é€’ï¼š<a href="mailto:&#x68;&#x72;&#64;&#x64;&#x61;&#x74;&#97;&#x66;&#117;&#115;&#x65;&#x6c;&#97;&#x62;&#115;&#46;&#x63;&#111;&#x6d;">&#x68;&#x72;&#64;&#x64;&#x61;&#x74;&#97;&#x66;&#117;&#115;&#x65;&#x6c;&#97;&#x62;&#115;&#46;&#x63;&#111;&#x6d;</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Databend æ˜¯ä¸€ä¸ªä½¿ç”¨ Rust ç ”å‘ã€å¼€æºçš„ã€å®Œå…¨é¢å‘äº‘æ¶æ„çš„æ–°å¼æ•°ä»“ï¼Œè‡´åŠ›äºæä¾›æé€Ÿçš„å¼¹æ€§æ‰©å±•èƒ½åŠ›ï¼Œæ‰“é€ æŒ‰éœ€ã€æŒ‰é‡çš„ Data Cloud äº§å“ä½“éªŒã€‚&lt;br&gt;å¼€æºåœ°å€ï¼š&lt;a href=&quot;https://github.com/datafus</summary>
      
    
    
    
    
    <category term="databend" scheme="https://bohutang.me/tags/databend/"/>
    
    <category term="cloud warehouse" scheme="https://bohutang.me/tags/cloud-warehouse/"/>
    
  </entry>
  
  <entry>
    <title>Rust, Databend and the Cloud Warehouseï¼ˆ2ï¼‰Databend æ¶æ„æ¦‚è§ˆ</title>
    <link href="https://bohutang.me/2021/08/21/datafuse-cloud-warehouse-design/"/>
    <id>https://bohutang.me/2021/08/21/datafuse-cloud-warehouse-design/</id>
    <published>2021-08-20T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.054Z</updated>
    
    <content type="html"><![CDATA[<p>Databend æ˜¯ä¸€ä¸ªå¼€æºçš„ã€å®Œå…¨é¢å‘äº‘æ¶æ„çš„æ–°å¼æ•°ä»“ï¼Œå®ƒæä¾›å¿«é€Ÿçš„å¼¹æ€§æ‰©å±•èƒ½åŠ›ï¼Œå¹¶ç»“åˆäº‘çš„å¼¹æ€§ã€ç®€å•æ€§å’Œä½æˆæœ¬ï¼Œä½¿ Data Cloud æ„å»ºå˜å¾—æ›´åŠ å®¹æ˜“ã€‚Databend æŠŠæ•°æ®å­˜å‚¨åœ¨åƒ AWS S3 ï¼ŒAzure Blob è¿™äº›äº‘ä¸Šçš„å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥ä½¿ä¸åŒçš„è®¡ç®—èŠ‚ç‚¹æŒ‚è½½åŒä¸€ä»½æ•°æ®ï¼Œä»è€Œåšåˆ°è¾ƒé«˜çš„å¼¹æ€§ï¼Œå®ç°å¯¹èµ„æºçš„ç²¾ç»†åŒ–æ§åˆ¶ã€‚</p><p>Databend åœ¨è®¾è®¡ä¸Šä¸“æ³¨ä»¥ä¸‹èƒ½åŠ›ï¼š</p><ol><li><strong>å¼¹æ€§</strong> åœ¨ Databend ä¸­ï¼Œå­˜å‚¨å’Œè®¡ç®—èµ„æºå¯ä»¥æŒ‰éœ€ã€æŒ‰é‡å¼¹æ€§æ‰©å±•ã€‚</li><li><strong>å®‰å…¨</strong> Databend ä¸­æ•°æ®æ–‡ä»¶å’Œç½‘ç»œä¼ è¾“éƒ½æ˜¯ç«¯åˆ°ç«¯åŠ å¯†ï¼Œå¹¶åœ¨ SQL çº§åˆ«æä¾›åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚</li><li><strong>æ˜“ç”¨</strong> Databend å…¼å®¹ ANSI SQLï¼Œå¹¶å¯ä»¥ä½¿ç”¨ MySQL å’Œ ClickHouse å®¢æˆ·ç«¯æ¥å…¥ï¼Œå‡ ä¹æ— å­¦ä¹ æˆæœ¬ã€‚</li><li><strong>æˆæœ¬</strong> Databend å¤„ç†æŸ¥è¯¢éå¸¸é«˜æ•ˆï¼Œç”¨æˆ·åªéœ€è¦ä¸ºä½¿ç”¨çš„èµ„æºä»˜è´¹ã€‚</li></ol><img src="https://datafuse-1253727613.cos.ap-hongkong.myqcloud.com/arch/datafuse-arch-20210817.svg" align="center" /><p>ä¸Šå›¾æ˜¯ Databend çš„æ•´ä½“æ¶æ„å›¾ï¼Œæ•´ä¸ªç³»ç»Ÿä¸»è¦ç”±ä¸‰å¤§éƒ¨åˆ†ç»„æˆï¼š<code>Meta service Layer</code>ã€<code>Compute Layer</code> å’Œ <code>Storage Layer</code>ã€‚</p><h2 id="Meta-Service-Layer"><a href="#Meta-Service-Layer" class="headerlink" title="Meta Service Layer"></a><strong>Meta Service Layer</strong></h2><p>Meta Service æ˜¯ä¸€ä¸ªå¤šç§Ÿæˆ·ã€é«˜å¯ç”¨çš„åˆ†å¸ƒå¼ key-value å­˜å‚¨æœåŠ¡ï¼Œå…·å¤‡äº‹åŠ¡èƒ½åŠ›ï¼Œä¸»è¦ç”¨äºå­˜å‚¨ï¼š</p><ul><li><code>Metadata</code> : è¡¨çš„å…ƒä¿¡æ¯ã€ç´¢å¼•ä¿¡æ¯ã€é›†ç¾¤ä¿¡æ¯ã€äº‹åŠ¡ä¿¡æ¯ç­‰ã€‚</li><li><code>Administration</code>ï¼šç”¨æˆ·ç³»ç»Ÿã€ç”¨æˆ·æƒé™ç­‰ä¿¡æ¯ã€‚</li><li><code>Security</code> ï¼šç”¨æˆ·ç™»å½•è®¤è¯ã€æ•°æ®åŠ å¯†ç­‰ã€‚</li></ul><h2 id="Compute-Layer"><a href="#Compute-Layer" class="headerlink" title="Compute Layer"></a><strong>Compute Layer</strong></h2><p>è®¡ç®—å±‚ç”±å¤šä¸ªé›†ç¾¤ï¼ˆclusterï¼‰ç»„æˆï¼Œä¸åŒé›†ç¾¤å¯ä»¥æ‰¿æ‹…ä¸åŒçš„å·¥ä½œè´Ÿè½½ï¼Œæ¯ä¸ªé›†ç¾¤åˆæœ‰å¤šä¸ªè®¡ç®—èŠ‚ç‚¹ï¼ˆnodeï¼‰ç»„æˆï¼Œä½ å¯ä»¥è½»æ¾çš„æ·»åŠ ã€åˆ é™¤èŠ‚ç‚¹æˆ–é›†ç¾¤ï¼Œåšåˆ°èµ„æºçš„æŒ‰éœ€ã€æŒ‰é‡ç®¡ç†ã€‚</p><p>è®¡ç®—èŠ‚ç‚¹æ˜¯è®¡ç®—å±‚çš„æœ€å°æ„æˆå•å…ƒï¼Œå…¶ä¸­æ¯ä¸ªè®¡ç®—èŠ‚ç‚¹åŒ…å«ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š</p><ul><li><strong>æ‰§è¡Œè®¡åˆ’ ï¼ˆPlannerï¼‰</strong></li></ul><p>æ ¹æ®ç”¨æˆ·è¾“å…¥çš„ SQL ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œå®ƒåªæ˜¯ä¸ªé€»è¾‘è¡¨è¾¾ï¼Œå¹¶ä¸èƒ½çœŸæ­£çš„æ‰§è¡Œï¼Œè€Œæ˜¯ç”¨äºæŒ‡å¯¼æ•´ä¸ªè®¡ç®—æµæ°´çº¿ï¼ˆPipelineï¼‰çš„ç¼–æ’ä¸ç”Ÿæˆã€‚<br>æ¯”å¦‚è¯­å¥ <code>SELECT number + 1 FROM numbers_mt(10) WHERE number &gt; 8 LIMIT 2</code><br>æ‰§è¡Œè®¡åˆ’ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">datafuse :) EXPLAIN SELECT number + 1 FROM numbers_mt(10) WHERE number &gt; 8 LIMIT 2</span><br><span class="line">â”Œâ”€explainâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Limit: 2                                                                                                                â”‚</span><br><span class="line">â”‚   Projection: (number + 1):UInt64                                                                                       â”‚</span><br><span class="line">â”‚     Expression: (number + 1):UInt64 (Before Projection)                                                                 â”‚</span><br><span class="line">â”‚       Filter: (number &gt; 8)                                                                                              â”‚</span><br><span class="line">â”‚         ReadDataSource: scan partitions: [1], scan schema: [number:UInt64], statistics: [read_rows: 10, read_bytes: 80] â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ‰§è¡Œè®¡åˆ’è‡ªä¸‹è€Œä¸Šåˆ†åˆ«æ˜¯ ï¼š</p><p><code>ReadDataSource</code>ï¼šè¡¨ç¤ºä»å“ªäº›æ–‡ä»¶é‡Œè¯»å–æ•°æ®<br><code>Filter</code>: è¡¨ç¤ºè¦åš (number &gt; 8) è¡¨è¾¾å¼è¿‡æ»¤<br><code>Expression</code>: è¡¨ç¤ºè¦åš (number + 1) è¡¨è¾¾å¼è¿ç®—<br><code>Projection</code>: è¡¨ç¤ºæŸ¥è¯¢åˆ—æ˜¯å“ªäº›<br><code>Limit</code>: è¡¨ç¤ºå–å‰ 2 æ¡æ•°æ®</p><ul><li><strong>ä¼˜åŒ–å™¨ ï¼ˆOptimizerï¼‰</strong></li></ul><p>å¯¹æ‰§è¡Œè®¡åˆ’åšä¸€äº›åŸºäºè§„åˆ™çš„ä¼˜åŒ–ï¼ˆA Rule Based Optimizerï¼‰, æ¯”å¦‚åšä¸€äº›è°“è¯ä¸‹æ¨æˆ–æ˜¯å»æ‰ä¸€äº›ä¸å¿…è¦çš„åˆ—ç­‰ï¼Œä»¥ä½¿æ•´ä¸ªæ‰§è¡Œè®¡åˆ’æ›´ä¼˜ã€‚</p><ul><li><strong>å¤„ç†å™¨ ï¼ˆProcessorsï¼‰</strong></li></ul><p>å¤„ç†å™¨ï¼ˆProcessorï¼‰æ˜¯æ‰§è¡Œè®¡ç®—é€»è¾‘çš„æ ¸å¿ƒç»„ä»¶ã€‚æ ¹æ®æ‰§è¡Œè®¡åˆ’ï¼Œå¤„ç†å™¨ä»¬è¢«ç¼–æ’æˆä¸€ä¸ªæµæ°´çº¿ï¼ˆPipelineï¼‰ï¼Œç”¨äºæ‰§è¡Œè®¡ç®—ä»»åŠ¡ã€‚</p><p>æ•´ä¸ª Pipeline æ˜¯ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ï¼Œæ¯ä¸ªç‚¹æ˜¯ä¸€ä¸ªå¤„ç†å™¨ï¼Œæ¯æ¡è¾¹ç”±å¤„ç†å™¨çš„ InPort å’Œ OutPort ç›¸è¿æ„æˆï¼Œæ•°æ®åˆ°è¾¾ä¸åŒçš„å¤„ç†å™¨è¿›è¡Œè®¡ç®—åï¼Œé€šè¿‡è¾¹æµå‘ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼Œå¤šä¸ªå¤„ç†å™¨å¯ä»¥å¹¶è¡Œè®¡ç®—ï¼Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹è¿˜å¯ä»¥è·¨èŠ‚ç‚¹åˆ†å¸ƒå¼æ‰§è¡Œï¼Œè¿™æ˜¯ Databend é«˜æ€§èƒ½çš„ä¸€ä¸ªé‡è¦è®¾è®¡ã€‚</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ EXPLAIN PIPELINE æ¥æŸ¥çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">datafuse :) EXPLAIN PIPELINE SELECT number + 1 FROM numbers_mt(10000) WHERE number &gt; 8 LIMIT 2</span><br><span class="line">â”Œâ”€explainâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ LimitTransform Ã— 1 processor                                          â”‚</span><br><span class="line">â”‚   Merge (ProjectionTransform Ã— 16 processors) to (LimitTransform Ã— 1) â”‚</span><br><span class="line">â”‚     ProjectionTransform Ã— 16 processors                               â”‚</span><br><span class="line">â”‚       ExpressionTransform Ã— 16 processors                             â”‚</span><br><span class="line">â”‚         FilterTransform Ã— 16 processors                               â”‚</span><br><span class="line">â”‚           SourceTransform Ã— 16 processors                             â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>åŒæ ·ï¼Œç†è§£è¿™ä¸ª Pipeline æˆ‘ä»¬è‡ªä¸‹è€Œä¸Šæ¥çœ‹ï¼š<br><code>SourceTransform</code>ï¼šè¯»å–æ•°æ®æ–‡ä»¶ï¼Œ16 ä¸ªç‰©ç† CPU å¹¶è¡Œå¤„ç†<br><code>FilterTransform</code>ï¼šå¯¹æ•°æ®è¿›è¡Œ (number &gt; 8) è¡¨è¾¾å¼è¿‡æ»¤ï¼Œ16 ä¸ªç‰©ç† CPU å¹¶è¡Œå¤„ç†<br><code>ExpressionTransform</code>ï¼šå¯¹æ•°æ®è¿›è¡Œ (number + 1) è¡¨è¾¾å¼æ‰§è¡Œï¼Œ16 ä¸ªç‰©ç† CPU å¹¶è¡Œå¤„ç†<br><code>ProjectionTransform</code>ï¼šå¯¹æ•°æ®å¤„ç†ç”Ÿæˆæœ€ç»ˆåˆ—<br><code>LimitTransform</code>ï¼šå¯¹æ•°æ®è¿›è¡Œ Limit 2 å¤„ç†ï¼ŒPipeline è¿›è¡ŒæŠ˜å ï¼Œç”±ä¸€ä¸ªç‰©ç† CPU æ¥æ‰§è¡Œ</p><p>Databend é€šè¿‡ Pipeline å¹¶è¡Œæ¨¡å‹ï¼Œå¹¶ç»“åˆå‘é‡è®¡ç®—æœ€å¤§é™åº¦çš„å»å‹æ¦¨ CPU èµ„æºï¼Œä»¥åŠ é€Ÿè®¡ç®—ã€‚</p><ul><li><strong>ç¼“å­˜ (Cache)</strong></li></ul><p>è®¡ç®—èŠ‚ç‚¹ä½¿ç”¨æœ¬åœ° SSD ç¼“å­˜æ•°æ®å’Œç´¢å¼•ï¼Œä»¥æé«˜æ•°æ®äº²å’Œæ€§æ¥åŠ é€Ÿè®¡ç®—ã€‚<br>ç¼“å­˜çš„é¢„çƒ­æ–¹å¼æœ‰ï¼š</p><ul><li>LOAD_ON_DEMAND - æŒ‰éœ€åŠ è½½ç´¢å¼•æˆ–æ•°æ®å—ï¼ˆé»˜è®¤ï¼‰ã€‚</li><li>LOAD_INDEX - åªåŠ è½½ç´¢å¼•ã€‚</li><li>LOAD_ALL - åŠ è½½å…¨éƒ¨çš„æ•°æ®å’Œç´¢å¼•ï¼Œå¯¹äºè¾ƒå°çš„è¡¨å¯ä»¥é‡‡å–è¿™ç§æ¨¡å¼ã€‚</li></ul><h2 id="Storage-Layer"><a href="#Storage-Layer" class="headerlink" title="Storage Layer"></a><strong>Storage Layer</strong></h2><p>Databend ä½¿ç”¨ Parquet åˆ—å¼å­˜å‚¨æ ¼å¼æ¥å‚¨å­˜æ•°æ®ï¼Œä¸ºäº†åŠ å¿«æŸ¥æ‰¾ï¼ˆPartition Pruningï¼‰ï¼ŒDatafuse ä¸ºæ¯ä¸ª Parquet æä¾›äº†è‡ªå·±çš„ç´¢å¼•ï¼ˆæ ¹æ® Primary Key ç”Ÿæˆï¼‰ï¼š</p><ul><li>min_max.idx Parquet æ–‡ä»¶ minimum å’Œ maximum å€¼</li><li>sparse.idx ä»¥ N æ¡è®°å½•ä¸ºé¢—ç²’åº¦çš„ç¨€ç–ç´¢å¼•</li></ul><p>é€šè¿‡è¿™äº›ç´¢å¼•ï¼Œ æˆ‘ä»¬å¯ä»¥å‡å°‘æ•°æ®çš„äº¤äº’ï¼Œå¹¶ä½¿è®¡ç®—é‡å¤§å¤§å‡å°‘ã€‚<br>å‡è®¾æœ‰ä¸¤ä¸ªParquet æ–‡ä»¶ï¼š<code>f1</code>, <code>f2</code>ã€‚<br><code>f1</code> çš„ <code>min_max.idx: [3, 5]</code> ï¼›<code>f2</code> çš„ <code>min_max.idx: [4, 6]</code> ã€‚å¦‚æœæŸ¥è¯¢æ¡ä»¶ä¸ºï¼š<code>where x &lt; 4</code> ï¼Œ æˆ‘ä»¬åªéœ€è¦ <code>f1</code> æ–‡ä»¶å°±å¯ä»¥ï¼Œå†æ ¹æ® <code>sparse.idx</code> ç´¢å¼•å®šä½åˆ° <code>f1</code> æ–‡ä»¶ä¸­çš„æŸä¸ªæ•°æ®é¡µã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><strong>æ€»ç»“</strong></h2><p>Databend æ˜¯ä¸€ä¸ªå®Œå…¨é¢å‘äº‘æ¶æ„è€Œè®¾è®¡çš„æ–°å¼æ•°ä»“ï¼Œå®ƒæŠŠä¼ ç»Ÿæ•°æ®åº“è¿›è¡Œè§£è€¦ï¼Œå†æ ¹æ®éœ€æ±‚ç»„è£…å‡ºä¸€ä¸ª Cloud Warehouseï¼Œä»¥è¿½æ±‚é«˜å¼¹æ€§ã€ä½æˆæœ¬ä¸ºå®—æ—¨ã€‚</p><p>Databend ç›®å‰çš„èšåˆå‡½æ•°å·²ç»<a href="https://datafuse.rs/overview/performance/">éå¸¸é«˜æ•ˆ</a>ï¼ŒåŸºäºè¿™äº›é«˜æ•ˆçš„èšåˆå‡½æ•°ï¼ˆå°¤å…¶æ˜¯ Group Byï¼‰ï¼Œæˆ‘ä»¬å®ç°äº†æ¨¡å‹å‡½æ•° <a href="https://datafuse.rs/sqlstatement/aggregate-functions/aggregate-windowfunnel/">windowFunnel</a>ï¼Œç”¨äºæ¼æ´æ¨¡å‹çš„é«˜æ•ˆè®¡ç®—ã€‚</p><p>Databend æ­£å¤„äºé«˜é€Ÿè¿­ä»£æœŸï¼Œæ¬¢è¿å…³æ³¨æˆ‘ä»¬: <a href="https://github.com/datafuselabs/databend/">https://github.com/datafuselabs/databend/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Databend æ˜¯ä¸€ä¸ªå¼€æºçš„ã€å®Œå…¨é¢å‘äº‘æ¶æ„çš„æ–°å¼æ•°ä»“ï¼Œå®ƒæä¾›å¿«é€Ÿçš„å¼¹æ€§æ‰©å±•èƒ½åŠ›ï¼Œå¹¶ç»“åˆäº‘çš„å¼¹æ€§ã€ç®€å•æ€§å’Œä½æˆæœ¬ï¼Œä½¿ Data Cloud æ„å»ºå˜å¾—æ›´åŠ å®¹æ˜“ã€‚Databend æŠŠæ•°æ®å­˜å‚¨åœ¨åƒ AWS S3 ï¼ŒAzure Blob è¿™äº›äº‘ä¸Šçš„å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥ä½¿ä¸åŒçš„è®¡ç®—èŠ‚ç‚¹æŒ‚</summary>
      
    
    
    
    
    <category term="databend" scheme="https://bohutang.me/tags/databend/"/>
    
    <category term="cloud warehouse" scheme="https://bohutang.me/tags/cloud-warehouse/"/>
    
  </entry>
  
  <entry>
    <title>Rust, Datafuse and the Cloud Warehouseï¼ˆ1ï¼‰äº‘æ—¶ä»£æ•°ä»“æ¶æ„è®¾è®¡</title>
    <link href="https://bohutang.me/2021/08/08/datafuse-cloud-warehouse-arch/"/>
    <id>https://bohutang.me/2021/08/08/datafuse-cloud-warehouse-arch/</id>
    <published>2021-08-07T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.054Z</updated>
    
    <content type="html"><![CDATA[<p>ä¼ ç»Ÿæ•°ä»“æ¶æ„ä¸é€‚åˆäº‘ï¼Ÿ</p><p>Cloud Warehouse è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p><p>Cloud Warehouse æ¶æ„åº”è¯¥æ˜¯ä»€ä¹ˆæ ·ï¼Ÿ</p><p>å¸¦ç€é—®é¢˜ï¼Œé€šè¿‡å®æˆ˜ï¼Œå‘ Cloud Warehouse å‡ºå‘ã€‚</p><h2 id="Sharding-Warehouse"><a href="#Sharding-Warehouse" class="headerlink" title="Sharding Warehouse"></a><b>Sharding Warehouse</b></h2><p>é¦–å…ˆï¼Œæ¥çœ‹çœ‹ä¼ ç»Ÿå¼ Sharding Warehouse æ¶æ„ï¼Œä»¥åŠå®ƒåœ¨äº‘ä¸Šçš„å±€é™æ€§ã€‚</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/sharding-warehouse.png" align="center" style="zoom:35%;" /><p>æ¯ä¸ª shard æ•°æ®åŒºé—´æ˜¯å›ºå®šçš„ï¼Œå¾ˆå®¹æ˜“å‘ç”Ÿæ•°æ®çƒ­ç‚¹(data skew)é—®é¢˜ï¼Œä¸€èˆ¬è§£å†³åŠæ³•ï¼š</p><p> â‘  æå‡è¯¥ shard ç¡¬ä»¶é…ç½®ï¼Œå¦‚æœçƒ­ç‚¹å¾ˆéš¾é¢„ä¼°ï¼Œæ•´ä¸ªé›†ç¾¤é…ç½®éƒ½éœ€è¦æå‡ï¼Œèµ„æºä¸Šç²’åº¦æ§åˆ¶ç²—æš´ã€‚</p><p> â‘¡ æ‰©å®¹ï¼Œæ‰©å®¹è¿‡ç¨‹(å¢åŠ  shard-4)æ¶‰åŠæ•°æ®è¿ç§»ï¼Œå¦‚æœæ•°æ®é‡å¤§ï¼Œshard-4 å¯æœåŠ¡ç­‰å¾…æ—¶é—´ä¹Ÿä¼šåŠ é•¿ã€‚</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/sharding-warehouse-scale.png" align="center" style="zoom:35%;" /><p>å¦‚æœåªæ˜¯æŠŠ Sharding Warehouse ç®€å•çš„æ¬åˆ°äº‘ä¸Šï¼Œèµ„æºæ§åˆ¶ç²’åº¦è¿˜æ˜¯å¾ˆç²—ç³™ï¼Œå¾ˆéš¾åšåˆ°ç²¾ç»†åŒ–æ§åˆ¶ï¼Œä»è€Œæ— æ³•å®ç°æ¯”è¾ƒç²¾ç¡®çš„æŒ‰éœ€ã€æŒ‰é‡è®¡è´¹ã€‚</p><p>ä¹Ÿå°±è¯´ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥éšæ„æ‰©å±•ï¼Œä½†æ˜¯æˆæœ¬ä¾ç„¶é«˜æ˜‚ã€‚</p><h2 id="Cloud-Warehouse"><a href="#Cloud-Warehouse" class="headerlink" title="Cloud Warehouse"></a><b>Cloud Warehouse</b></h2><p>å¦‚æœä¸€ä¸ª Cloud  Warehouse æ»¡è¶³:</p><ol><li>æŒ‰éœ€çš„å¼¹æ€§æ‰©å±•</li><li>æŒ‰é‡çš„ç²¾ç»†åŒ–èµ„æºæ§åˆ¶</li></ol><p>é‚£ä¹ˆå®ƒçš„æ¶æ„åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿ</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/cloud-warehouse-v1.png" align="center" style="zoom:35%;" /><p>é¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªå­˜å‚¨å’Œè®¡ç®—åˆ†ç¦»çš„æ¶æ„ï¼Œå…¶æ¬¡æ˜¯è®¡ç®—èŠ‚ç‚¹å°½é‡æ— çŠ¶æ€ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ &#x2F;åˆ é™¤è®¡ç®—èŠ‚ç‚¹ï¼Œç®—åŠ›éšæ—¶å¢åŠ å’Œå‡å°‘ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¹³æ»‘çš„è¿‡ç¨‹ï¼Œä¸æ¶‰åŠæ•°æ®çš„è¿ç§»ã€‚<br>node-4 åŸºæœ¬æ˜¯ severless çš„ï¼Œå¯è®¤ä¸ºæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿è¡Œå®Œæ¯•è‡ªåŠ¨æ¶ˆäº¡ï¼Œåœ¨è°ƒåº¦ä¸Šå¯ä»¥åšåˆ°æ›´åŠ ç²¾ç»†åŒ–ã€‚</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/cloud-warehouse-v1-scale.png" align="center" style="zoom:35%;" /><p>å¤§å®¶çœ‹åˆ°è¿™ä¸ªæ¶æ„åæˆ–è®¸æœ‰ä¸€ä¸ªç–‘é—®ï¼š<br>Cloud Warehouse æ¶æ„æ¯”ä¼ ç»Ÿæ¶æ„æ›´ç®€å•å•Š :)<br>Shared Storage å¯ä»¥æ˜¯ AWS S3ï¼Œè¿˜å¯ä»¥æ˜¯ Azure Blob Storageï¼Œéƒ½è®©äº‘æ¥åšäº†ï¼Œcompute ä½¿ç”¨ç±»ä¼¼ Presto çš„è®¡ç®—å¼•æ“ä¸å°±æ˜¯å®Œç¾çš„ Cloud Warehouse äº†å—ï¼Ÿ</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªç°å®é—®é¢˜æŒ¡ä½äº†é€šå¾€ç†æƒ³çš„å¤§é“ï¼š</p><p>Shared Storage é€šå¸¸ä¸æ˜¯ä¸ºä½å»¶è¿Ÿã€é«˜ååè€Œè®¾è®¡ï¼Œå¶å°”æ€§çš„æŠ–åŠ¨ä¹Ÿå¾ˆéš¾æ§åˆ¶ï¼Œå¦‚æœé è®¡ç®—å¼•æ“è›®åŠ›ç¡¬åˆšï¼Œè¿™çœ‹èµ·æ¥å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„äº§å“ã€‚</p><h2 id="å¦‚ä½•è®¾è®¡ï¼Ÿ"><a href="#å¦‚ä½•è®¾è®¡ï¼Ÿ" class="headerlink" title="å¦‚ä½•è®¾è®¡ï¼Ÿ"></a><b>å¦‚ä½•è®¾è®¡ï¼Ÿ</b></h2><p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹ Cloud Warehouse é‡Œçš„æ•°æ®æœ‰å‡ ç§çŠ¶æ€:</p><ol><li>Persistent dataï¼šé€šå¸¸æŒ‡ç”¨æˆ·çš„æ•°æ®ï¼Œé‡åº¦ä¾èµ– Shared Storage</li><li>Intermediate dataï¼šä¸€èˆ¬æŒ‡è®¡ç®—çš„ä¸´æ—¶ä¸­é—´ç»“æœï¼Œæ¯”å¦‚æ’åºã€JOINç­‰äº§ç”Ÿçš„ä¸´æ—¶æ•°æ®</li><li>Metadataï¼šobject catalogs, table schema, user ç­‰å…ƒæ•°æ®</li></ol><p>æ—¢ç„¶ Shared Storage å·²ç»å‡è®¾æ˜¯ä¸å¯é çš„ï¼Œé‚£æˆ‘ä»¬å°½é‡å‡å°‘ä» Shared Storage è¯»å–æ•°æ®å¥½äº†ï¼Œå¢åŠ  Cache æ¥è§£å†³ã€‚</p><p>æ–°çš„é—®é¢˜åˆæ¥äº†ï¼Œè¿™ä¸ª Cache åˆ°åº• Cache ä»€ä¹ˆæ•°æ®å‘¢ï¼Œæ˜¯åŸå§‹çš„å—æ•°æ®è¿˜æ˜¯ç´¢å¼•ï¼Ÿæ˜¯ä¸€ä¸ªå…¨å±€ Cache è¿˜æ˜¯è®¡ç®—èŠ‚ç‚¹å†…çš„ Cacheï¼Ÿ</p><h3 id="Snowflake-æ¶æ„"><a href="#Snowflake-æ¶æ„" class="headerlink" title="Snowflake æ¶æ„"></a>Snowflake æ¶æ„</h3><p>æˆ‘ä»¬å…ˆçœ‹çœ‹ Snowflake è€å¤§å“¥çš„è®¾è®¡:</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/cloud-warehouse-distributed-cache.png" align="center" style="zoom:35%;" /><p>Snowflake åœ¨è®¡ç®—å’Œå­˜å‚¨ä¹‹é—´åŠ äº†ä¸€ä¸ªå…±äº«çš„ Ephemeral Storageï¼Œä¸»è¦ç”¨äº Intermediate data å­˜å‚¨ï¼ŒåŒæ—¶è‚©è´Ÿç€ Persistent data cacheï¼Œå¥½å¤„æ˜¯ç¼“å­˜å¯ä»¥å……åˆ†åˆ©ç”¨ï¼Œç¼ºç‚¹æ˜¯è¿™ä¸ª Distributed Emphemeral Storage åšåˆ° Elastic åŒæ ·é¢ä¸´ä¸€äº›æŒ‘æˆ˜ï¼Œæ¯”å¦‚å¤šç§Ÿæˆ·æƒ…å†µä¸‹èµ„æºéš”ç¦»ç­‰é—®é¢˜ã€‚</p><h3 id="Datafuse-æ¶æ„"><a href="#Datafuse-æ¶æ„" class="headerlink" title="Datafuse æ¶æ„"></a>Datafuse æ¶æ„</h3><p>Cloud Warehouse å¼ºè°ƒçŠ¶æ€åˆ†ç¦»ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ Persistent data é¢„å…ˆç”Ÿæˆè¶³å¤Ÿå¤šçš„ç´¢å¼•æ”¾åˆ° Metadata Serviceï¼Œæ¯ä¸ªè®¡ç®—èŠ‚ç‚¹è¿›è¡Œè®¢é˜…ï¼Œæ ¹æ®éœ€è¦æ›´æ–°æœ¬åœ°çš„ Cacheï¼Œè¿™ä¸ªæ¶æ„è·Ÿ FireBolt æ¯”è¾ƒç›¸ä¼¼ã€‚</p><p>è¿™æ˜¯ç›®å‰æ¯”è¾ƒç®€å•å¯è¡Œçš„æ–¹å¼ï¼Œå¢åŠ è®¡ç®—èŠ‚ç‚¹ï¼Œåªè¦åŠ çƒ­ Cache å³å¯ï¼ŒåŒæ ·ä¼šé¢ä¸´ä¸€äº›æŒ‘æˆ˜ï¼Œæ¯”å¦‚æµ·é‡çš„ç´¢å¼•ä¿¡æ¯å¿«é€ŸåŒæ­¥é—®é¢˜ã€‚</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/blog-datafuse/cloud-warehouse-cache-index.png" align="center" style="zoom:35%;" /><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><b>æ€»ç»“</b></h2><p><a href="https://github.com/datafuselabs/databend">Databend</a> æ˜¯ä¸€ä¸ªå¼€æºçš„ Cloud Warehouseï¼Œé‡åœ¨è®¡ç®—å’ŒçŠ¶æ€åˆ†ç¦»ï¼Œä¸“æ³¨äº‘ä¸Šçš„å¼¹æ€§æ‰©å±•ï¼Œè®©å¤§å®¶è½»æ¾æ‰“é€ å‡ºè‡ªå·±çš„ Data Cloudã€‚</p><p>å¾ˆé«˜å…´ï¼Œåˆå¼€äº†æ–°ç³»åˆ—æ¥è®² Databendï¼Œä¸€ä¸ªæŠŠ Rust å’Œ Cloud è¿›è¡Œè¿æ¥çš„ Warehouse é¡¹ç›®ï¼Œå……æ»¡ä¹è¶£å’ŒæŒ‘æˆ˜ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a><b>References</b></h2><ol><li><a href="https://github.com/datafuselabs/databend">Databend: A Modern Real-Time Data Processing &amp; Analytics DBMS with Cloud-Native Architecture</a></li><li><a href="https://www.usenix.org/system/files/nsdi20-paper-vuppalapati.pdf">Building An Elastic Query Engine on Disaggregated</a></li><li><a href="http://www.vertica.com/wp-content/uploads/2018/05/Vertica_EON_SIGMOD_Paper.pdf">Eon Mode: Bringing the Vertica Columnar Database to the Cloud</a></li><li><a href="https://www.firebolt.io/resources/firebolt-cloud-data-warehouse-whitepaper">The Firebolt Cloud Data Warehouse Whitepaper</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¼ ç»Ÿæ•°ä»“æ¶æ„ä¸é€‚åˆäº‘ï¼Ÿ&lt;/p&gt;
&lt;p&gt;Cloud Warehouse è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ&lt;/p&gt;
&lt;p&gt;Cloud Warehouse æ¶æ„åº”è¯¥æ˜¯ä»€ä¹ˆæ ·ï¼Ÿ&lt;/p&gt;
&lt;p&gt;å¸¦ç€é—®é¢˜ï¼Œé€šè¿‡å®æˆ˜ï¼Œå‘ Cloud Warehouse å‡ºå‘ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Sharding-</summary>
      
    
    
    
    
    <category term="databend" scheme="https://bohutang.me/tags/databend/"/>
    
    <category term="Cloud Warehouse" scheme="https://bohutang.me/tags/Cloud-Warehouse/"/>
    
    <category term="snowflake" scheme="https://bohutang.me/tags/snowflake/"/>
    
    <category term="firebolt" scheme="https://bohutang.me/tags/firebolt/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆ15ï¼‰Group By ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«</title>
    <link href="https://bohutang.me/2021/01/21/clickhouse-and-friends-groupby/"/>
    <id>https://bohutang.me/2021/01/21/clickhouse-and-friends-groupby/</id>
    <published>2021-01-20T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.050Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æ­ç§˜ ClickHouse Group By ä¹‹å‰ï¼Œå…ˆèŠèŠæ•°æ®åº“çš„æ€§èƒ½å¯¹æ¯”æµ‹è¯•é—®é¢˜ã€‚<br>åœ¨è™å“¥çœ‹æ¥ï¼Œä¸€ä¸ªâ€œè®²æ­¦å¾·â€çš„æ€§èƒ½å¯¹æ¯”æµ‹è¯•åº”è¯¥æä¾›ä»€ä¹ˆä¿¡æ¯å‘¢ï¼Ÿ</p><p>é¦–å…ˆè¦å°Šé‡å®¢è§‚äº‹å®ï¼Œåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ï¼Œx æ¯” y å¿«ï¼Ÿ<br>å…¶æ¬¡æ˜¯ä¸ºä»€ä¹ˆ x ä¼šæ¯” y å¿«ï¼Ÿ </p><p>å¦‚æœä»¥ä¸Šä¸¤æ¡éƒ½åšåˆ°äº†ï¼Œè¿˜æœ‰ä¸€ç‚¹ä¹Ÿæ¯”è¾ƒé‡è¦ï¼š x çš„ä¼˜åŠ¿å¯ä»¥æ”¯æ’‘å¤šä¹…ï¼Ÿ æ˜¯æ¶æ„ç­‰å¸¦æ¥çš„é•¿æœŸä¼˜åŠ¿ï¼Œè¿˜æ˜¯ä¸€è¢‹çƒŸçš„ä¼˜åŒ–æ‰€å¾—ï¼Œæ˜¯å¦èƒ½æŒç»­è·Ÿä¸Šè‡ªå·±çš„çµé­‚ã€‚<br>å¦‚æœåªæ˜¯è´´å‡ ä¸ªå¦–è‰³çš„æ•°å­—ï¼Œç®—ä¸ä¸Šæ˜¯ benchmarkï¼Œè€Œæ˜¯ benchmarketã€‚</p><p>å¥½äº†ï¼Œå›åˆ° Group By æ­£é¢˜ã€‚<br>ç›¸ä¿¡å¾ˆå¤šåŒå­¦å·²ç»ä½“éªŒåˆ° ClickHouse Group By çš„å‡ºè‰²æ€§èƒ½ï¼Œæœ¬ç¯‡å°±æ¥åˆ†æä¸‹å¿«çš„åŸå› ã€‚<br>é¦–å…ˆå®‰æ…°ä¸€ä¸‹ï¼ŒClickHouse çš„ Group By å¹¶æ²¡æœ‰ä½¿ç”¨é«˜å¤§ä¸Šçš„é»‘ç§‘æŠ€ï¼Œåªæ˜¯æ‘¸ç´¢äº†ä¸€æ¡ç›¸å¯¹è¾ƒä¼˜çš„æ–¹æ¡ˆã€‚</p><h2 id="ä¸€æ¡-SQL"><a href="#ä¸€æ¡-SQL" class="headerlink" title="ä¸€æ¡ SQL"></a><b>ä¸€æ¡ SQL</b></h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT sum(number) FROM numbers(10) GROUP BY number % 3</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°±ä»¥è¿™æ¡ç®€å•çš„ SQL ä½œä¸ºçº¿ç´¢ï¼Œçœ‹çœ‹ ClickHouse æ€ä¹ˆå®ç° Group By èšåˆã€‚</p><h2 id="1-ç”Ÿæˆ-AST"><a href="#1-ç”Ÿæˆ-AST" class="headerlink" title="1. ç”Ÿæˆ AST"></a><b>1. ç”Ÿæˆ AST</b></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN AST</span><br><span class="line">SELECT sum(number)</span><br><span class="line">FROM numbers(10)</span><br><span class="line">GROUP BY number % 3</span><br><span class="line"></span><br><span class="line">â”Œâ”€explainâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ SelectWithUnionQuery (children 1)           â”‚</span><br><span class="line">â”‚  ExpressionList (children 1)                â”‚</span><br><span class="line">â”‚   SelectQuery (children 3)                  â”‚</span><br><span class="line">â”‚    ExpressionList (children 1)              â”‚</span><br><span class="line">â”‚     Function sum (children 1)               â”‚  // sum èšåˆ</span><br><span class="line">â”‚      ExpressionList (children 1)            â”‚</span><br><span class="line">â”‚       Identifier number                     â”‚</span><br><span class="line">â”‚    TablesInSelectQuery (children 1)         â”‚</span><br><span class="line">â”‚     TablesInSelectQueryElement (children 1) â”‚</span><br><span class="line">â”‚      TableExpression (children 1)           â”‚</span><br><span class="line">â”‚       Function numbers (children 1)         â”‚</span><br><span class="line">â”‚        ExpressionList (children 1)          â”‚</span><br><span class="line">â”‚         Literal UInt64_10                   â”‚</span><br><span class="line">â”‚    ExpressionList (children 1)              â”‚</span><br><span class="line">â”‚     Function modulo (children 1)            â”‚  // number % 3 å‡½æ•°</span><br><span class="line">â”‚      ExpressionList (children 2)            â”‚</span><br><span class="line">â”‚       Identifier number                     â”‚</span><br><span class="line">â”‚       Literal UInt64_3                      â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h2 id="2-ç”Ÿæˆ-Query-Plan"><a href="#2-ç”Ÿæˆ-Query-Plan" class="headerlink" title="2. ç”Ÿæˆ Query Plan"></a><b>2. ç”Ÿæˆ Query Plan</b></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN</span><br><span class="line">SELECT sum(number)</span><br><span class="line">FROM numbers(10)</span><br><span class="line">GROUP BY number % 3</span><br><span class="line"></span><br><span class="line">â”Œâ”€explainâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Expression ((Projection + Before ORDER BY))                                   â”‚ </span><br><span class="line">â”‚   Aggregating                                                                 â”‚ // sum èšåˆ</span><br><span class="line">â”‚     Expression (Before GROUP BY)                                              â”‚ // number % 3</span><br><span class="line">â”‚       SettingQuotaAndLimits (Set limits and quota after reading from storage) â”‚</span><br><span class="line">â”‚         ReadFromStorage (SystemNumbers)                                       â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸»è¦åœ¨ <a href="https://github.com/ClickHouse/ClickHouse/blob/27ddf78ba572b893cb5351541f566d1080d8a9c6/src/Interpreters/InterpreterSelectQuery.cpp#L1063">InterpreterSelectQuery::executeImpl@Interpreters&#x2F;InterpreterSelectQuery.cpp</a></p><h2 id="3-ç”Ÿæˆ-Pipeline"><a href="#3-ç”Ÿæˆ-Pipeline" class="headerlink" title="3. ç”Ÿæˆ Pipeline"></a><b>3. ç”Ÿæˆ Pipeline</b></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN PIPELINE</span><br><span class="line">SELECT sum(number)</span><br><span class="line">FROM numbers(10)</span><br><span class="line">GROUP BY number % 3</span><br><span class="line"></span><br><span class="line">â”Œâ”€explainâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ (Expression)                  â”‚</span><br><span class="line">â”‚ ExpressionTransform           â”‚</span><br><span class="line">â”‚   (Aggregating)               â”‚</span><br><span class="line">â”‚   AggregatingTransform        â”‚  // sum è®¡ç®—</span><br><span class="line">â”‚     (Expression)              â”‚</span><br><span class="line">â”‚     ExpressionTransform       â”‚  // number % 3 è®¡ç®—</span><br><span class="line">â”‚       (SettingQuotaAndLimits) â”‚</span><br><span class="line">â”‚         (ReadFromStorage)     â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h2 id="4-æ‰§è¡Œ-Pipeline"><a href="#4-æ‰§è¡Œ-Pipeline" class="headerlink" title=" 4. æ‰§è¡Œ Pipeline "></a><b> 4. æ‰§è¡Œ Pipeline </b></h2><p>Pipeline æ˜¯ä»åº•éƒ¨å¾€ä¸Šé€ä¸€æ‰§è¡Œã€‚</p><h3 id="4-1-ReadFromStorage"><a href="#4-1-ReadFromStorage" class="headerlink" title="4.1 ReadFromStorage"></a>4.1 ReadFromStorage</h3><p>é¦–å…ˆä» ReadFromStorage æ‰§è¡Œï¼Œç”Ÿæˆä¸€ä¸ª block1ï¼Œ æ•°æ®å¦‚ä¸‹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€numberâ”€â”</span><br><span class="line">â”‚      0 â”‚</span><br><span class="line">â”‚      1 â”‚</span><br><span class="line">â”‚      2 â”‚</span><br><span class="line">â”‚      3 â”‚</span><br><span class="line">â”‚      4 â”‚</span><br><span class="line">â”‚      5 â”‚</span><br><span class="line">â”‚      6 â”‚</span><br><span class="line">â”‚      7 â”‚</span><br><span class="line">â”‚      8 â”‚</span><br><span class="line">â”‚      9 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">numberç±»å‹ä¸º UInt64</span><br></pre></td></tr></table></figure><h3 id="4-2-ExpressionTransform"><a href="#4-2-ExpressionTransform" class="headerlink" title="4.2 ExpressionTransform"></a>4.2 ExpressionTransform</h3><p>ExpressionTransform åŒ…å«äº† 2 ä¸ª action:</p><ol><li>åå­—ä¸º numberï¼Œtype ä¸º INPUT</li><li>åå­—ä¸º modulo(number, 3)ï¼Œ type ä¸º FUNCTION</li></ol><p>ç»è¿‡ ExpressionTransform è¿è¡Œå¤„ç†åç”Ÿæˆä¸€ä¸ªæ–°çš„ block2ï¼Œ æ•°æ®å¦‚ä¸‹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€numberâ”€â”¬â”€modulo(number, 3)â”€â”</span><br><span class="line">â”‚      0 â”‚                 0 â”‚</span><br><span class="line">â”‚      1 â”‚                 1 â”‚</span><br><span class="line">â”‚      2 â”‚                 2 â”‚</span><br><span class="line">â”‚      3 â”‚                 0 â”‚</span><br><span class="line">â”‚      4 â”‚                 1 â”‚</span><br><span class="line">â”‚      5 â”‚                 2 â”‚</span><br><span class="line">â”‚      6 â”‚                 0 â”‚</span><br><span class="line">â”‚      7 â”‚                 1 â”‚</span><br><span class="line">â”‚      8 â”‚                 2 â”‚</span><br><span class="line">â”‚      9 â”‚                 0 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">number ç±»å‹ä¸º UInt64</span><br><span class="line">modulo(number, 3) ç±»å‹ä¸º UInt8</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸»è¦åœ¨ <a href="https://github.com/ClickHouse/ClickHouse/blob/27ddf78ba572b893cb5351541f566d1080d8a9c6/src/Interpreters/ExpressionActions.cpp#L416">ExpressionActions::execute@Interpreters&#x2F;ExpressionActions.cpp</a></p><h3 id="4-3-AggregatingTransform"><a href="#4-3-AggregatingTransform" class="headerlink" title="4.3 AggregatingTransform"></a>4.3 AggregatingTransform</h3><p>AggregatingTransform æ˜¯ Group By é«˜æ€§èƒ½çš„æ ¸å¿ƒæ‰€åœ¨ã€‚<br>æœ¬ç¤ºä¾‹ä¸­çš„ modulo(number, 3) ç±»å‹ä¸º UInt8ï¼Œåœ¨åšä¼˜åŒ–ä¸Šï¼ŒClickHouse ä¼šé€‰æ‹©ä½¿ç”¨æ•°ç»„ä»£æ›¿ hashtableä½œä¸ºåˆ†ç»„ï¼ŒåŒºåˆ†é€»è¾‘è§ <a href="https://github.com/ClickHouse/ClickHouse/blob/27ddf78ba572b893cb5351541f566d1080d8a9c6/src/Interpreters/Aggregator.cpp#L526">Interpreters&#x2F;Aggregator.cpp</a></p><p>åœ¨è®¡ç®— sum çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šç”Ÿæˆä¸€ä¸ªæ•°ç»„ [1024]ï¼Œç„¶ååšäº†ä¸€ä¸ªç¼–è¯‘å±•å¼€(ä»£ç  <a href="https://github.com/ClickHouse/ClickHouse/blob/27ddf78ba572b893cb5351541f566d1080d8a9c6/src/AggregateFunctions/IAggregateFunction.h#L412-L487">addBatchLookupTable8@AggregateFunctions&#x2F;IAggregateFunction.h</a>):</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">static constexpr size_t UNROLL_COUNT = 4;</span><br><span class="line">std::unique_ptr&lt;Data[]&gt; places&#123;new Data[256 * UNROLL_COUNT]&#125;;</span><br><span class="line">bool has_data[256 * UNROLL_COUNT]&#123;&#125;; /// Separate flags array to avoid heavy initialization.</span><br><span class="line"></span><br><span class="line">size_t i = 0;</span><br><span class="line"></span><br><span class="line">/// Aggregate data into different lookup tables.</span><br><span class="line">size_t batch_size_unrolled = batch_size / UNROLL_COUNT * UNROLL_COUNT;</span><br><span class="line">for (; i &lt; batch_size_unrolled; i += UNROLL_COUNT)</span><br><span class="line">&#123;</span><br><span class="line">    for (size_t j = 0; j &lt; UNROLL_COUNT; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">        size_t idx = j * 256 + key[i + j];</span><br><span class="line">        if (unlikely(!has_data[idx]))</span><br><span class="line">        &#123;</span><br><span class="line">            new (&amp;places[idx]) Data;</span><br><span class="line">            has_data[idx] = true;</span><br><span class="line">        &#125;</span><br><span class="line">        func.add(reinterpret_cast&lt;char *&gt;(&amp;places[idx]), columns, i + j, nullptr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>sum(number) â€¦ GROUP BY number % 3 è®¡ç®—æ–¹å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array[0] = 0 + 3 + 6 + 9 = 18</span><br><span class="line">array[1] = 1 + 4 + 7 = 12</span><br><span class="line">array[2] = 2 + 5 + 8 = 15</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯é’ˆå¯¹ UInt8 åšçš„ä¸€ä¸ªä¼˜åŒ–åˆ†æ”¯ï¼Œé‚£ä¹ˆå¯¹äºå…¶ä»–ç±»å‹æ€ä¹ˆä¼˜åŒ–å¤„ç†å‘¢ï¼Ÿ<br>ClickHouse é’ˆå¯¹ä¸åŒçš„ç±»å‹åˆ†åˆ«æä¾›äº†ä¸åŒçš„ hashtableï¼Œå£°åŠ¿æ¯”è¾ƒæµ©å¤§ï¼ˆä»£ç è§ <a href="https://github.com/ClickHouse/ClickHouse/blob/27ddf78ba572b893cb5351541f566d1080d8a9c6/src/Interpreters/Aggregator.h#L68-L103">Aggregator.h</a>ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">using AggregatedDataWithUInt8Key = FixedImplicitZeroHashMapWithCalculatedSize&lt;UInt8, AggregateDataPtr&gt;;</span><br><span class="line">using AggregatedDataWithUInt16Key = FixedImplicitZeroHashMap&lt;UInt16, AggregateDataPtr&gt;;</span><br><span class="line">using AggregatedDataWithUInt32Key = HashMap&lt;UInt32, AggregateDataPtr, HashCRC32&lt;UInt32&gt;&gt;;</span><br><span class="line">using AggregatedDataWithUInt64Key = HashMap&lt;UInt64, AggregateDataPtr, HashCRC32&lt;UInt64&gt;&gt;;</span><br><span class="line">using AggregatedDataWithShortStringKey = StringHashMap&lt;AggregateDataPtr&gt;;</span><br><span class="line">using AggregatedDataWithStringKey = HashMapWithSavedHash&lt;StringRef, AggregateDataPtr&gt;;</span><br><span class="line">using AggregatedDataWithKeys128 = HashMap&lt;UInt128, AggregateDataPtr, UInt128HashCRC32&gt;;</span><br><span class="line">using AggregatedDataWithKeys256 = HashMap&lt;DummyUInt256, AggregateDataPtr, UInt256HashCRC32&gt;;</span><br><span class="line">using AggregatedDataWithUInt32KeyTwoLevel = TwoLevelHashMap&lt;UInt32, AggregateDataPtr, HashCRC32&lt;UInt32&gt;&gt;;</span><br><span class="line">using AggregatedDataWithUInt64KeyTwoLevel = TwoLevelHashMap&lt;UInt64, AggregateDataPtr, HashCRC32&lt;UInt64&gt;&gt;;</span><br><span class="line">using AggregatedDataWithShortStringKeyTwoLevel = TwoLevelStringHashMap&lt;AggregateDataPtr&gt;;</span><br><span class="line">using AggregatedDataWithStringKeyTwoLevel = TwoLevelHashMapWithSavedHash&lt;StringRef, AggregateDataPtr&gt;;</span><br><span class="line">using AggregatedDataWithKeys128TwoLevel = TwoLevelHashMap&lt;UInt128, AggregateDataPtr, UInt128HashCRC32&gt;;</span><br><span class="line">using AggregatedDataWithKeys256TwoLevel = TwoLevelHashMap&lt;DummyUInt256, AggregateDataPtr, UInt256HashCRC32&gt;;</span><br><span class="line">using AggregatedDataWithUInt64KeyHash64 = HashMap&lt;UInt64, AggregateDataPtr, DefaultHash&lt;UInt64&gt;&gt;;</span><br><span class="line">using AggregatedDataWithStringKeyHash64 = HashMapWithSavedHash&lt;StringRef, AggregateDataPtr, StringRefHash64&gt;;</span><br><span class="line">using AggregatedDataWithKeys128Hash64 = HashMap&lt;UInt128, AggregateDataPtr, UInt128Hash&gt;;</span><br><span class="line">using AggregatedDataWithKeys256Hash64 = HashMap&lt;DummyUInt256, AggregateDataPtr, UInt256Hash&gt;;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æ”¹æˆ GROUP BY number*100000 åï¼Œå®ƒä¼šé€‰æ‹© AggregatedDataWithUInt64Key çš„ hashtable ä½œä¸ºåˆ†ç»„ã€‚</p><p>è€Œä¸” ClickHouse æä¾›äº†ä¸€ç§ Two Level æ–¹å¼ï¼Œç”¨è¯­åº”å¯¹æœ‰å¤§é‡åˆ†ç»„ key çš„æƒ…å†µï¼ŒLevel1 å…ˆåˆ†å¤§ç»„ï¼ŒLevel2 å°ç»„å¯ä»¥å¹¶è¡Œè®¡ç®—ã€‚<br>é’ˆå¯¹ String ç±»å‹ï¼Œæ ¹æ®ä¸åŒçš„é•¿åº¦ï¼Œhashtable ä¹Ÿåšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä»£ç è§ <a href="https://github.com/ClickHouse/ClickHouse/blob/27ddf78ba572b893cb5351541f566d1080d8a9c6/src/Common/HashTable/StringHashMap.h#L78-L82">HashTable&#x2F;StringHashMap.h</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><b>æ€»ç»“</b></h2><p>ClickHouse ä¼šæ ¹æ® Group By çš„æœ€ç»ˆç±»å‹ï¼Œé€‰æ‹©ä¸€ä¸ªæœ€ä¼˜çš„ hashtable æˆ–æ•°ç»„ï¼Œä½œä¸ºåˆ†ç»„åŸºç¡€æ•°æ®ç»“æ„ï¼Œä½¿å†…å­˜å’Œè®¡ç®—å°½é‡æœ€ä¼˜ã€‚</p><p>è¿™ä¸ªâ€æœ€ä¼˜è§£â€œæ˜¯æ€ä¹ˆæ‰¾åˆ°çš„ï¼Ÿä» test ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ˜¯ä¸åœçš„å°è¯•ã€æµ‹è¯•éªŒè¯å‡ºæ¥çš„ï¼Œæµ“åšçš„ bottom-up å“²å­¦èŒƒã€‚</p><p>hashtable æµ‹è¯•ä»£ç ï¼š<a href="https://github.com/ClickHouse/ClickHouse/tree/27ddf78ba572b893cb5351541f566d1080d8a9c6/src/Interpreters/tests">Interpreters&#x2F;tests</a></p><p>lookuptable æµ‹è¯•ä»£ç ï¼š <a href="https://github.com/ClickHouse/ClickHouse/blob/27ddf78ba572b893cb5351541f566d1080d8a9c6/src/Common/tests/average.cpp">tests&#x2F;average.cpp</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨æ­ç§˜ ClickHouse Group By ä¹‹å‰ï¼Œå…ˆèŠèŠæ•°æ®åº“çš„æ€§èƒ½å¯¹æ¯”æµ‹è¯•é—®é¢˜ã€‚&lt;br&gt;åœ¨è™å“¥çœ‹æ¥ï¼Œä¸€ä¸ªâ€œè®²æ­¦å¾·â€çš„æ€§èƒ½å¯¹æ¯”æµ‹è¯•åº”è¯¥æä¾›ä»€ä¹ˆä¿¡æ¯å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;é¦–å…ˆè¦å°Šé‡å®¢è§‚äº‹å®ï¼Œåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ï¼Œx æ¯” y å¿«ï¼Ÿ&lt;br&gt;å…¶æ¬¡æ˜¯ä¸ºä»€ä¹ˆ x ä¼šæ¯” y å¿«ï¼Ÿ &lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="clickhouse" scheme="https://bohutang.me/tags/clickhouse/"/>
    
    <category term="ClickHouseå’Œä»–çš„æœ‹å‹ä»¬" scheme="https://bohutang.me/tags/ClickHouse%E5%92%8C%E4%BB%96%E7%9A%84%E6%9C%8B%E5%8F%8B%E4%BB%AC/"/>
    
    <category term="aggregator" scheme="https://bohutang.me/tags/aggregator/"/>
    
    <category term="hashtable" scheme="https://bohutang.me/tags/hashtable/"/>
    
    <category term="groupby" scheme="https://bohutang.me/tags/groupby/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆ14ï¼‰å­˜å‚¨è®¡ç®—åˆ†ç¦»æ–¹æ¡ˆä¸å®ç°</title>
    <link href="https://bohutang.me/2020/09/18/clickhouse-and-friends-compute-storage/"/>
    <id>https://bohutang.me/2020/09/18/clickhouse-and-friends-compute-storage/</id>
    <published>2020-09-17T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.050Z</updated>
    
    <content type="html"><![CDATA[<img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/clickhouse-map-2020-replicatedmergetree.png" align="center" style="zoom:50%;" /><p><b>æœ€åæ›´æ–°: 2020-09-28</b></p><p>å¦‚æœå¤šä¸ª ClickHouse server å¯ä»¥æŒ‚è½½åŒä¸€ä»½æ•°æ®(åˆ†å¸ƒå¼å­˜å‚¨ç­‰)ï¼Œå¹¶ä¸”æ¯ä¸ª server éƒ½å¯å†™ï¼Œè¿™æ ·ä¼šæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå‰¯æœ¬æœºåˆ¶äº¤ç»™åˆ†å¸ƒå¼å­˜å‚¨æ¥ä¿éšœï¼Œä¸Šå±‚æ¶æ„å˜å¾—ç®€å•æœ´ç´ ï¼›</p><p>å…¶æ¬¡ï¼Œclickhouse-server å¯ä»¥åœ¨ä»»æ„æœºå™¨ä¸Šå¢åŠ ã€å‡å°‘ï¼Œä½¿å­˜å‚¨å’Œè®¡ç®—èƒ½åŠ›å¾—åˆ°å……åˆ†å‘æŒ¥ã€‚</p><p>æœ¬æ–‡å°±æ¥æ¢è®¨ä¸€ä¸‹ ClickHouse çš„å­˜å‚¨è®¡ç®—åˆ†ç¦»æ–¹æ¡ˆï¼Œå®ç°ä¸Šå¹¶ä¸å¤æ‚ã€‚</p><h2 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1. é—®é¢˜"></a><b>1. é—®é¢˜</b></h2><p>ClickHouse è¿è¡Œæ—¶æ•°æ®ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š<b>å†…å­˜å…ƒæ•°æ®</b>å’Œ<b>ç£ç›˜æ•°æ®</b>ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹å†™æµç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">w1. å¼€å§‹å†™å…¥æ•°æ®</span><br><span class="line">w2. ç”Ÿæˆå†…å­˜partä¿¡æ¯ï¼Œå¹¶ç»´æŠ¤part metadataåˆ—è¡¨</span><br><span class="line">w3. æŠŠpartæ•°æ®å†™åˆ°ç£ç›˜</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹è¯»æµç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r1. ä»part metadataå®šä½éœ€è¦è¯»å–çš„part</span><br><span class="line">r2. ä»ç£ç›˜è¯»å–partæ•°æ®</span><br><span class="line">r3. è¿”å›ç»™ä¸Šå±‚æ•°æ®</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå¦‚æœ server1 å†™äº†ä¸€æ¡æ•°æ®ï¼Œåªä¼šæ›´æ–°è‡ªå·±å†…å­˜çš„ part metadataï¼Œå…¶ä»– server æ˜¯æ„ŸçŸ¥ä¸åˆ°çš„ï¼Œè¿™æ ·ä¹Ÿå°±æ— æ³•æŸ¥è¯¢åˆ°åˆšå†™å…¥çš„æ•°æ®ã€‚</p><p>å­˜å‚¨è®¡ç®—åˆ†ç¦»ï¼Œé¦–å…ˆè¦è§£å†³çš„å°±æ˜¯å†…å­˜çŠ¶æ€æ•°æ®çš„åŒæ­¥é—®é¢˜ã€‚</p><p>åœ¨ ClickHouse é‡Œï¼Œæˆ‘ä»¬éœ€è¦è§£å†³çš„æ˜¯å†…å­˜ä¸­ part metadata åŒæ­¥é—®é¢˜ã€‚</p><h2 id="2-å†…å­˜æ•°æ®åŒæ­¥"><a href="#2-å†…å­˜æ•°æ®åŒæ­¥" class="headerlink" title="2. å†…å­˜æ•°æ®åŒæ­¥"></a><b>2. å†…å­˜æ•°æ®åŒæ­¥</b></h2><p>åœ¨ä¸Šç¯‡ <a href="/2020/09/13/clickhouse-and-friends-replicated-merge-tree/">&lt;ReplicatedMergeTreeè¡¨å¼•æ“åŠåŒæ­¥æœºåˆ¶&gt;</a> ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å‰¯æœ¬é—´çš„æ•°æ®åŒæ­¥æœºåˆ¶ï¼š<br>é¦–å…ˆåŒæ­¥å…ƒæ•°æ®ï¼Œå†é€šè¿‡å…ƒæ•°æ®è·å–ç›¸åº”partæ•°æ®ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä»¬å€Ÿç”¨ ReplicatedMergeTree åŒæ­¥é€šé“ï¼Œç„¶åå†åšå‡æ³•ï¼ŒåŒæ­¥å®Œå…ƒæ•°æ®åè·³è¿‡ part æ•°æ®çš„åŒæ­¥ï¼Œå› ä¸ºç£ç›˜æ•°æ®åªéœ€ä¸€ä¸ª server åšæ›´æ–°(éœ€è¦ fsync è¯­ä¹‰)å³å¯ã€‚</p><p>æ ¸å¿ƒä»£ç ï¼š<br>MergeTreeData::renameTempPartAndReplace</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if (!share_storage)</span><br><span class="line">    part-&gt;renameTo(part_name, true);</span><br></pre></td></tr></table></figure><h2 id="3-æ¼”ç¤ºdemo"><a href="#3-æ¼”ç¤ºdemo" class="headerlink" title="3. æ¼”ç¤ºdemo"></a><b>3. æ¼”ç¤ºdemo</b></h2><figure class="video_container">  <iframe src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/video/clickhouse-storage-compute.mp4" frameborder="0" allowfullscreen="true"> </iframe></figure><p>scriptï¼š</p><ol><li>é¦–å…ˆèµ· 2 ä¸ª clickhouse-serverï¼Œå®ƒä»¬éƒ½æŒ‚è½½åŒä¸€ä»½æ•°æ® <code>&lt;path&gt;/home/bohu/work/cluster/d1/datas/&lt;/path&gt;</code></li><li>é€šè¿‡ clickhouse-server1(port 9101) å†™å…¥ä¸€æ¡è®°å½•:(111, 3333)</li><li>é€šè¿‡ clickhouse-server2(port 9102) è¿›è¡ŒæŸ¥è¯¢æ­£å¸¸</li><li>é€šè¿‡ clickhouse-server2(port 9102) truncate è¡¨</li><li>é€šè¿‡ clickhouse-server1(port 9101) æŸ¥è¯¢æ­£å¸¸</li></ol><h2 id="4-ä»£ç å®ç°"><a href="#4-ä»£ç å®ç°" class="headerlink" title="4. ä»£ç å®ç°"></a><b>4. ä»£ç å®ç°</b></h2><p><a href="https://github.com/BohuTANG/ClickHouse/commit/f67d98ef408fda1a359e4fb17848619ef1f6e59b">åŸå‹</a><br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œåªå®ç°äº†å†™å…¥æ•°æ®åŒæ­¥ï¼Œè€Œä¸”æ˜¯éå¸¸ tricky çš„æ–¹å¼ã€‚</p><p>ç”±äº DDL æ²¡æœ‰å®ç°ï¼Œæ‰€ä»¥åœ¨ zookeeper ä¸Šçš„æ³¨å†Œæ–¹å¼ä¹Ÿæ¯”è¾ƒ trickyï¼Œdemo é‡Œçš„ replicas éƒ½æ˜¯æ‰‹å·¥æ³¨å†Œçš„ã€‚</p><h2 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5. æ€»ç»“"></a><b>5. æ€»ç»“</b></h2><p>æœ¬æ–‡æä¾›ä¸€ä¸ªæ€è·¯ï¼Œç®—æ˜¯æŠ›ç –å¼•ç‰ï¼ŒåŒæ—¶ä¹ŸæœŸå¾…æ›´åŠ ç³»ç»Ÿçš„å·¥ç¨‹å®ç°ã€‚</p><p>ClickHouse æš‚æ—¶è¿˜ä¸æ”¯æŒ Distributed Query åŠŸèƒ½ï¼Œå¦‚æœè¿™ä¸ªèƒ½åŠ›æ”¯æŒï¼ŒClickHouse å­˜å‚¨è®¡ç®—åˆ†ç¦»å°±æ˜¯ä¸€ä¸ªå¨åŠ›æ— æ¯”çš„å°æ°¢å¼¹ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;img src=&quot;https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/clickhouse-map-2020-replicatedmergetree.png&quot; align=&quot;center&quot; style=&quot;z</summary>
      
    
    
    
    
    <category term="clickhouse" scheme="https://bohutang.me/tags/clickhouse/"/>
    
    <category term="replicatedmergetree" scheme="https://bohutang.me/tags/replicatedmergetree/"/>
    
    <category term="storage" scheme="https://bohutang.me/tags/storage/"/>
    
    <category term="compute" scheme="https://bohutang.me/tags/compute/"/>
    
    <category term="ClickHouseå’Œä»–çš„æœ‹å‹ä»¬" scheme="https://bohutang.me/tags/ClickHouse%E5%92%8C%E4%BB%96%E7%9A%84%E6%9C%8B%E5%8F%8B%E4%BB%AC/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆ13ï¼‰ReplicatedMergeTreeè¡¨å¼•æ“åŠåŒæ­¥æœºåˆ¶</title>
    <link href="https://bohutang.me/2020/09/13/clickhouse-and-friends-replicated-merge-tree/"/>
    <id>https://bohutang.me/2020/09/13/clickhouse-and-friends-replicated-merge-tree/</id>
    <published>2020-09-12T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.053Z</updated>
    
    <content type="html"><![CDATA[<img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/clickhouse-map-2020-replicatedmergetree.png" align="center" style="zoom:50%;" /><p><b>æœ€åæ›´æ–°: 2020-09-13</b></p><p>åœ¨ MySQL é‡Œï¼Œä¸ºäº†ä¿è¯é«˜å¯ç”¨ä»¥åŠæ•°æ®å®‰å…¨æ€§ä¼šé‡‡å–ä¸»ä»æ¨¡å¼ï¼Œæ•°æ®é€šè¿‡ binlog æ¥è¿›è¡ŒåŒæ­¥ã€‚</p><p>åœ¨ ClickHouse é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ReplicatedMergeTree å¼•æ“ï¼Œæ•°æ®åŒæ­¥é€šè¿‡ zookeeper å®Œæˆã€‚</p><p>æœ¬æ–‡å…ˆä»æ­å»ºä¸€ä¸ªå¤š replica é›†ç¾¤å¼€å§‹ï¼Œç„¶åä¸€çª¥åº•å±‚çš„æœºåˆ¶ï¼Œç®€å•åƒä¸¤å£ã€‚</p><h2 id="1-é›†ç¾¤æ­å»º"><a href="#1-é›†ç¾¤æ­å»º" class="headerlink" title="1. é›†ç¾¤æ­å»º"></a><b>1. é›†ç¾¤æ­å»º</b></h2><p>æ­å»ºä¸€ä¸ª 2 replica æµ‹è¯•é›†ç¾¤ï¼Œç”±äºæ¡ä»¶æœ‰é™ï¼Œè¿™é‡Œåœ¨åŒä¸€å°ç‰©ç†æœºä¸Šèµ· clickhouse-server(2ä¸ª replica) + zookeeper(1ä¸ª)ï¼Œä¸ºäº†é¿å…ç«¯å£å†²çªï¼Œä¸¤ä¸ª replica ç«¯å£ä¼šæœ‰æ‰€ä¸åŒã€‚</p><h3 id="1-1-zookeeper"><a href="#1-1-zookeeper" class="headerlink" title="1.1 zookeeper"></a><b>1.1 zookeeper</b></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run  -p 2181:2181 --name some-zookeeper --restart always -d zookeeper</span><br></pre></td></tr></table></figure><h3 id="1-2-replicaé›†ç¾¤"><a href="#1-2-replicaé›†ç¾¤" class="headerlink" title="1.2 replicaé›†ç¾¤"></a><b>1.2 replicaé›†ç¾¤</b></h3><p>replica-1 config.xml:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;zookeeper&gt;</span><br><span class="line">   &lt;node index=&quot;1&quot;&gt;</span><br><span class="line">      &lt;host&gt;172.17.0.2&lt;/host&gt;</span><br><span class="line">      &lt;port&gt;2181&lt;/port&gt;</span><br><span class="line">   &lt;/node&gt;</span><br><span class="line">&lt;/zookeeper&gt;</span><br><span class="line"></span><br><span class="line">&lt;remote_servers&gt;</span><br><span class="line">   &lt;mycluster_1&gt;</span><br><span class="line">      &lt;shard_1&gt;</span><br><span class="line">         &lt;internal_replication&gt;true&lt;/internal_replication&gt;</span><br><span class="line">         &lt;replica&gt;</span><br><span class="line">            &lt;host&gt;s1&lt;/host&gt;</span><br><span class="line">            &lt;port&gt;9000&lt;/port&gt;</span><br><span class="line">         &lt;/replica&gt;</span><br><span class="line">         &lt;replica&gt;</span><br><span class="line">            &lt;host&gt;s2&lt;/host&gt;</span><br><span class="line">            &lt;port&gt;9001&lt;/port&gt;</span><br><span class="line">         &lt;/replica&gt;</span><br><span class="line">      &lt;/shard_1&gt;</span><br><span class="line">   &lt;/mycluster_1&gt;</span><br><span class="line">&lt;/remote_servers&gt;</span><br><span class="line"></span><br><span class="line">&lt;macros&gt;</span><br><span class="line">   &lt;cluster&gt;mycluster_1&lt;/cluster&gt;</span><br><span class="line">   &lt;shard&gt;1&lt;/shard&gt;</span><br><span class="line">   &lt;replica&gt;s1&lt;/replica&gt;</span><br><span class="line">&lt;/macros&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;tcp_port&gt;9101&lt;/tcp_port&gt;</span><br><span class="line">&lt;interserver_http_port&gt;9009&lt;/interserver_http_port&gt;</span><br><span class="line">&lt;path&gt;/cluster/d1/datas/&lt;/path&gt;</span><br></pre></td></tr></table></figure><p>replica-2 config.xml:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;zookeeper&gt;</span><br><span class="line">   &lt;node index=&quot;1&quot;&gt;</span><br><span class="line">      &lt;host&gt;172.17.0.2&lt;/host&gt;</span><br><span class="line">      &lt;port&gt;2181&lt;/port&gt;</span><br><span class="line">   &lt;/node&gt;</span><br><span class="line">&lt;/zookeeper&gt;</span><br><span class="line"></span><br><span class="line">&lt;remote_servers&gt;</span><br><span class="line">   &lt;mycluster_1&gt;</span><br><span class="line">      &lt;shard_1&gt;</span><br><span class="line">         &lt;internal_replication&gt;true&lt;/internal_replication&gt;</span><br><span class="line">         &lt;replica&gt;</span><br><span class="line">            &lt;host&gt;s1&lt;/host&gt;</span><br><span class="line">            &lt;port&gt;9000&lt;/port&gt;</span><br><span class="line">         &lt;/replica&gt;</span><br><span class="line">         &lt;replica&gt;</span><br><span class="line">            &lt;host&gt;s2&lt;/host&gt;</span><br><span class="line">            &lt;port&gt;9001&lt;/port&gt;</span><br><span class="line">         &lt;/replica&gt;</span><br><span class="line">      &lt;/shard_1&gt;</span><br><span class="line">   &lt;/mycluster_1&gt;</span><br><span class="line">&lt;/remote_servers&gt;</span><br><span class="line"></span><br><span class="line">&lt;macros&gt;</span><br><span class="line">   &lt;cluster&gt;mycluster_1&lt;/cluster&gt;</span><br><span class="line">   &lt;shard&gt;1&lt;/shard&gt;</span><br><span class="line">   &lt;replica&gt;s2&lt;/replica&gt;</span><br><span class="line">&lt;/macros&gt;</span><br><span class="line"></span><br><span class="line">&lt;tcp_port&gt;9102&lt;/tcp_port&gt;</span><br><span class="line">&lt;interserver_http_port&gt;9010&lt;/interserver_http_port&gt;</span><br><span class="line">&lt;path&gt;/cluster/d2/datas/&lt;/path&gt;</span><br></pre></td></tr></table></figure><h3 id="1-3-åˆ›å»ºæµ‹è¯•è¡¨"><a href="#1-3-åˆ›å»ºæµ‹è¯•è¡¨" class="headerlink" title="1.3 åˆ›å»ºæµ‹è¯•è¡¨"></a><b>1.3 åˆ›å»ºæµ‹è¯•è¡¨</b></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE default.rtest1 ON CLUSTER &#x27;mycluster_1&#x27;</span><br><span class="line">(</span><br><span class="line">    `id` Int64,</span><br><span class="line">    `p` Int16</span><br><span class="line">)</span><br><span class="line">ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/replicated/test&#x27;, &#x27;&#123;replica&#125;&#x27;)</span><br><span class="line">PARTITION BY p</span><br><span class="line">ORDER BY id</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="1-4-æŸ¥çœ‹-zookeeper"><a href="#1-4-æŸ¥çœ‹-zookeeper" class="headerlink" title=" 1.4 æŸ¥çœ‹ zookeeperÂ "></a><b> 1.4 æŸ¥çœ‹ zookeeperÂ </b></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it some-zookeeper bash</span><br><span class="line">./bin/zkCli.sh</span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 17] ls /clickhouse/tables/replicated/test/replicas</span><br><span class="line">[s1, s2]</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ª replica éƒ½å·²ç»æ³¨å†Œåˆ° zookeeperã€‚</p><h2 id="2-åŒæ­¥åŸç†"><a href="#2-åŒæ­¥åŸç†" class="headerlink" title=" 2. åŒæ­¥åŸç†Â "></a><b> 2. åŒæ­¥åŸç†Â </b></h2><p>å¦‚æœåœ¨ replica-1 ä¸Šæ‰§è¡Œäº†ä¸€æ¡å†™å…¥:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replica-1&gt; INSERT INTO rtest VALUES(33,33);</span><br></pre></td></tr></table></figure><p>æ•°æ®æ˜¯å¦‚ä½•åŒæ­¥åˆ° replica-2 çš„å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">s1.  replica-1&gt; StorageReplicatedMergeTree::write --&gt; ReplicatedMergeTreeBlockOutputStream::write(const Block &amp; block)</span><br><span class="line">s2.  replica-1&gt; storage.writer.writeTempPartï¼Œå†™å…¥æœ¬åœ°ç£ç›˜</span><br><span class="line">s3.  replica-1&gt; ReplicatedMergeTreeBlockOutputStream::commitPart</span><br><span class="line">s4.  replica-1&gt; StorageReplicatedMergeTree::getCommitPartOpï¼Œæäº¤LogEntryåˆ°zookeeperï¼Œä¿¡æ¯åŒ…æ‹¬:</span><br><span class="line">    ReplicatedMergeTreeLogEntry &#123;</span><br><span class="line">     type: GET_PART,</span><br><span class="line">     source_replica: replica-1,</span><br><span class="line">     new_part_name: part-&gt;name,</span><br><span class="line">     new_part_type: part-&gt;getType</span><br><span class="line">    &#125;</span><br><span class="line">s5.  replica-1&gt; zkutil::makeCreateRequest(zookeeper_path + &quot;/log/log-0000000022&quot;)ï¼Œæ›´æ–°log_pointeråˆ°zookeeper</span><br><span class="line"></span><br><span class="line">s6.  replica-2&gt; StorageReplicatedMergeTree::queueUpdatingTask()ï¼Œå®šæ—¶pullä»»åŠ¡</span><br><span class="line">s7.  replica-2&gt; ReplicatedMergeTreeQueue::pullLogsToQueue ï¼Œæ‹‰å–</span><br><span class="line">s8.  replica-2&gt; zookeeper-&gt;get(replica_path + &quot;/log_pointer&quot;) ï¼Œå‘zookeeperè·å–å½“å‰replicaå·²ç»åŒæ­¥çš„ä½ç‚¹</span><br><span class="line">s9.  replica-2&gt; zookeeper-&gt;getChildrenWatch(zookeeper_path + &quot;/log&quot;) ï¼Œå‘zookeeperè·å–æ‰€æœ‰çš„LogEntryä¿¡æ¯</span><br><span class="line">s10. replica-2&gt; æ ¹æ®åŒæ­¥ä½ç‚¹log_pointerä»æ‰€æœ‰LogEntryä¸­ç­›é€‰éœ€è¦åŒæ­¥çš„LogEntryï¼Œå†™åˆ°queue</span><br><span class="line">s11. replica-2&gt; StorageReplicatedMergeTree::queueTaskï¼Œæ¶ˆè´¹queueä»»åŠ¡</span><br><span class="line">s12. replica-2&gt; StorageReplicatedMergeTree::executeLogEntry(LogEntry &amp; entry)ï¼Œæ ¹æ®LogEntry typeæ‰§è¡Œæ¶ˆè´¹</span><br><span class="line">s13. replica-2&gt; StorageReplicatedMergeTree::executeFetch(LogEntry &amp; entry) </span><br><span class="line">s14. replica-2&gt; StorageReplicatedMergeTree::fetchPartï¼Œä»replica-1çš„interserver_http_portä¸‹è½½partç›®å½•æ•°æ®</span><br><span class="line">s15. replica-2&gt; MergeTreeData::renameTempPartAndReplaceï¼ŒæŠŠæ–‡ä»¶å†™å…¥æœ¬åœ°å¹¶æ›´æ–°å†…å­˜metaä¿¡æ¯</span><br><span class="line">s16. replica-2&gt; æ•°æ®åŒæ­¥å®Œæˆ</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥è¿›å…¥ zookeeper docker å†…éƒ¨ç›´æ¥æŸ¥çœ‹æŸä¸ª LogEntry:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 85] get /clickhouse/tables/replicated/test/log/log-0000000022</span><br><span class="line">format version: 4</span><br><span class="line">create_time: 2020-09-13 16:39:05</span><br><span class="line">source replica: s1</span><br><span class="line">block_id: 33_2673203974107464807_7670041793554220344</span><br><span class="line">get</span><br><span class="line">33_2_2_0</span><br></pre></td></tr></table></figure><h2 id="3-æ€»ç»“"><a href="#3-æ€»ç»“" class="headerlink" title="3. æ€»ç»“"></a><b>3. æ€»ç»“</b></h2><p>æœ¬æ–‡ä»¥å†™å…¥ä¸ºä¾‹ï¼Œä»åº•å±‚åˆ†æäº† ClickHouse ReplicatedMergeTree çš„å·¥ä½œåŸç†ï¼Œé€»è¾‘å¹¶ä¸å¤æ‚ã€‚</p><p>ä¸åŒ replica çš„æ•°æ®åŒæ­¥éœ€è¦ zookeeper(ç›®å‰ç¤¾åŒºæœ‰äººåœ¨åšetcdçš„é›†æˆ <a href="https://github.com/ClickHouse/ClickHouse/pull/10376">pr#10376</a>)åšå…ƒæ•°æ®åè°ƒï¼Œæ˜¯ä¸€ä¸ªè®¢é˜…&#x2F;æ¶ˆè´¹æ¨¡å‹ï¼Œæ¶‰åŠå…·ä½“æ•°æ®ç›®å½•è¿˜éœ€è¦å»ç›¸åº”çš„ replica é€šè¿‡ interserver_http_port ç«¯å£è¿›è¡Œä¸‹è½½ã€‚</p><p>replica çš„åŒæ­¥éƒ½æ˜¯ä»¥æ–‡ä»¶ç›®å½•ä¸ºå•ä½ï¼Œè¿™æ ·å°±å¸¦æ¥ä¸€ä¸ªå¥½å¤„ï¼šæˆ‘ä»¬<b>å¯ä»¥è½»æ¾å®ç° ClickHouse çš„å­˜å‚¨è®¡ç®—åˆ†ç¦»</b>ï¼Œå¤šä¸ª clickhouse-server å¯ä»¥åŒæ—¶æŒ‚è½½åŒä¸€ä»½æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œè€Œä¸”è¿™äº› server æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯å¯å†™ï¼Œè™å“¥å·²ç»å®ç°äº†ä¸€ä¸ªå¯ä»¥ work çš„åŸå‹ï¼Œè¯¦æƒ…è¯·å‚è€ƒä¸‹ç¯‡ <a href="/2020/09/18/clickhouse-and-friends-compute-storage/">&lt;å­˜å‚¨è®¡ç®—åˆ†ç¦»æ–¹æ¡ˆä¸å®ç°&gt;</a>ã€‚</p><h2 id="4-å‚è€ƒ"><a href="#4-å‚è€ƒ" class="headerlink" title="4. å‚è€ƒ"></a><b>4. å‚è€ƒ</b></h2><p>[1]  <a href="https://github.com/ClickHouse/ClickHouse/blob/f37814b36754bf11b52bd9c77d0e15f4d1825033/src/Storages/StorageReplicatedMergeTree.cpp">StorageReplicatedMergeTree.cpp</a><br>[2] <a href="https://github.com/ClickHouse/ClickHouse/blob/f37814b36754bf11b52bd9c77d0e15f4d1825033/src/Storages/MergeTree/ReplicatedMergeTreeBlockOutputStream.cpp">ReplicatedMergeTreeBlockOutputStream.cpp</a><br>[3] <a href="https://github.com/ClickHouse/ClickHouse/blob/f37814b36754bf11b52bd9c77d0e15f4d1825033/src/Storages/MergeTree/ReplicatedMergeTreeLogEntry.cpp">ReplicatedMergeTreeLogEntry.cpp</a><br>[4] <a href="https://github.com/ClickHouse/ClickHouse/blob/f37814b36754bf11b52bd9c77d0e15f4d1825033/src/Storages/MergeTree/ReplicatedMergeTreeQueue.cpp">ReplicatedMergeTreeQueue.cpp</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;img src=&quot;https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/clickhouse-map-2020-replicatedmergetree.png&quot; align=&quot;center&quot; style=&quot;z</summary>
      
    
    
    
    
    <category term="clickhouse" scheme="https://bohutang.me/tags/clickhouse/"/>
    
    <category term="replicatedmergetree" scheme="https://bohutang.me/tags/replicatedmergetree/"/>
    
    <category term="ClickHouseå’Œä»–çš„æœ‹å‹ä»¬" scheme="https://bohutang.me/tags/ClickHouse%E5%92%8C%E4%BB%96%E7%9A%84%E6%9C%8B%E5%8F%8B%E4%BB%AC/"/>
    
    <category term="zookeeper" scheme="https://bohutang.me/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆ12ï¼‰ç¥å¥‡çš„ç‰©åŒ–è§†å›¾(Materialized View)ä¸åŸç†</title>
    <link href="https://bohutang.me/2020/08/31/clickhouse-and-friends-materialized-view/"/>
    <id>https://bohutang.me/2020/08/31/clickhouse-and-friends-materialized-view/</id>
    <published>2020-08-30T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.051Z</updated>
    
    <content type="html"><![CDATA[<img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/clickhouse-map-2020-materializeview.png" align="center" style="zoom:50%;" /><p><b>æœ€åæ›´æ–°: 2020-08-31</b></p><p>åœ¨ ClickHouse é‡Œï¼Œç‰©åŒ–è§†å›¾(Materialized View)å¯ä»¥è¯´æ˜¯ä¸€ä¸ªç¥å¥‡ä¸”å¼ºå¤§çš„ä¸œè¥¿ï¼Œç”¨é€”åˆ«å…·ä¸€æ ¼ã€‚</p><p>æœ¬æ–‡ä»åº•å±‚æœºåˆ¶è¿›è¡Œåˆ†æï¼Œçœ‹çœ‹ ClickHouse çš„ Materalized View æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œä»¥æ–¹ä¾¿æ›´å¥½çš„ä½¿ç”¨å®ƒã€‚</p><h2 id="ä»€ä¹ˆæ˜¯ç‰©åŒ–è§†å›¾"><a href="#ä»€ä¹ˆæ˜¯ç‰©åŒ–è§†å›¾" class="headerlink" title="ä»€ä¹ˆæ˜¯ç‰©åŒ–è§†å›¾"></a><b>ä»€ä¹ˆæ˜¯ç‰©åŒ–è§†å›¾</b></h2><p>å¯¹å¤§éƒ¨åˆ†äººæ¥è¯´ï¼Œç‰©åŒ–è§†å›¾è¿™ä¸ªæ¦‚å¿µä¼šæ¯”è¾ƒæŠ½è±¡ï¼Œç‰©åŒ–ï¼Ÿè§†å›¾ï¼Ÿã€‚ã€‚ã€‚</p><p>ä¸ºäº†æ›´å¥½çš„ç†è§£å®ƒï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªåœºæ™¯ã€‚</p><p>å‡è®¾ä½ æ˜¯ *hub ä¸€ä¸ªâ€œå¹¸ç¦â€çš„å°ç¨‹åºå‘˜ï¼ŒæŸå¤©äº§å“ç»ç†æœ‰ä¸ªéœ€æ±‚ï¼šå®æ—¶ç»Ÿè®¡æ¯å°æ—¶è§†é¢‘ä¸‹è½½é‡ã€‚</p><p>ç”¨æˆ·ä¸‹è½½æ˜ç»†è¡¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">clickhouse&gt; SELECT * FROM download LIMIT 10;</span><br><span class="line">+---------------------+--------+--------+</span><br><span class="line">| when                | userid | bytes  |</span><br><span class="line">+---------------------+--------+--------+</span><br><span class="line">| 2020-08-31 18:22:06 |     19 | 530314 |</span><br><span class="line">| 2020-08-31 18:22:06 |     19 | 872957 |</span><br><span class="line">| 2020-08-31 18:22:06 |     19 | 107047 |</span><br><span class="line">| 2020-08-31 18:22:07 |     19 | 214876 |</span><br><span class="line">| 2020-08-31 18:22:07 |     19 | 820943 |</span><br><span class="line">| 2020-08-31 18:22:07 |     19 | 693959 |</span><br><span class="line">| 2020-08-31 18:22:08 |     19 | 882151 |</span><br><span class="line">| 2020-08-31 18:22:08 |     19 | 644223 |</span><br><span class="line">| 2020-08-31 18:22:08 |     19 | 199800 |</span><br><span class="line">| 2020-08-31 18:22:09 |     19 | 511439 |</span><br><span class="line"></span><br><span class="line">... ....</span><br></pre></td></tr></table></figure><p>è®¡ç®—æ¯å°æ—¶ä¸‹è½½é‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">clickhouse&gt; SELECT toStartOfHour(when) AS hour, userid, count() as downloads, sum(bytes) AS bytes FROM download GROUP BY userid, hour ORDER BY userid, hour;</span><br><span class="line">+---------------------+--------+-----------+------------+</span><br><span class="line">| hour                | userid | downloads | bytes      |</span><br><span class="line">+---------------------+--------+-----------+------------+</span><br><span class="line">| 2020-08-31 18:00:00 |     19 |      6822 | 3378623036 |</span><br><span class="line">| 2020-08-31 19:00:00 |     19 |     10800 | 5424173178 |</span><br><span class="line">| 2020-08-31 20:00:00 |     19 |     10800 | 5418656068 |</span><br><span class="line">| 2020-08-31 21:00:00 |     19 |     10800 | 5404309443 |</span><br><span class="line">| 2020-08-31 22:00:00 |     19 |     10800 | 5354077456 |</span><br><span class="line">| 2020-08-31 23:00:00 |     19 |     10800 | 5390852563 |</span><br><span class="line">| 2020-09-01 00:00:00 |     19 |     10800 | 5369839540 |</span><br><span class="line">| 2020-09-01 01:00:00 |     19 |     10800 | 5384161012 |</span><br><span class="line">| 2020-09-01 02:00:00 |     19 |     10800 | 5404581759 |</span><br><span class="line">| 2020-09-01 03:00:00 |     19 |      6778 | 3399557322 |</span><br><span class="line">+---------------------+--------+-----------+------------+</span><br><span class="line">10 rows in set (0.13 sec)</span><br></pre></td></tr></table></figure><p>å¾ˆå®¹æ˜“å˜›ï¼Œä¸è¿‡æœ‰ä¸ªé—®é¢˜ï¼š<br>æ¯æ¬¡éƒ½è¦ä»¥ <code>download</code> è¡¨ä¸ºåŸºç¡€æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œ*hub æ•°æ®é‡å¤ªå¤§ï¼Œæ— æ³•å¿å—ã€‚</p><p>æƒ³åˆ°ä¸€ä¸ªåŠæ³•ï¼šå¦‚æœå¯¹ <code>download</code> è¿›è¡Œé¢„èšåˆï¼ŒæŠŠç»“æœä¿å­˜åˆ°ä¸€ä¸ªæ–°è¡¨ <code>download_hour_mv</code>ï¼Œå¹¶éšç€ <code>download</code> å¢é‡å®æ—¶æ›´æ–°ï¼Œæ¯æ¬¡å»æŸ¥è¯¢<code>download_hour_mv</code> ä¸å°±å¯ä»¥äº†ã€‚</p><p>è¿™ä¸ªæ–°è¡¨å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªç‰©åŒ–è§†å›¾ï¼Œå®ƒåœ¨ ClickHouse æ˜¯ä¸€ä¸ªæ™®é€šè¡¨ã€‚</p><h2 id="åˆ›å»ºç‰©åŒ–è§†å›¾"><a href="#åˆ›å»ºç‰©åŒ–è§†å›¾" class="headerlink" title="åˆ›å»ºç‰©åŒ–è§†å›¾"></a><b>åˆ›å»ºç‰©åŒ–è§†å›¾</b></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">clickhouse&gt; CREATE MATERIALIZED VIEW download_hour_mv</span><br><span class="line">ENGINE = SummingMergeTree</span><br><span class="line">PARTITION BY toYYYYMM(hour) ORDER BY (userid, hour)</span><br><span class="line">AS SELECT</span><br><span class="line">  toStartOfHour(when) AS hour,</span><br><span class="line">  userid,</span><br><span class="line">  count() as downloads,</span><br><span class="line">  sum(bytes) AS bytes</span><br><span class="line">FROM download WHERE when &gt;= toDateTime(&#x27;2020-09-01 04:00:00&#x27;)</span><br><span class="line">GROUP BY userid, hour</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¯­å¥ä¸»è¦åšäº†ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªå¼•æ“ä¸º <code>SummingMergeTree</code> çš„ç‰©åŒ–è§†å›¾ <code>download_hour_mv</code></li><li>ç‰©åŒ–è§†å›¾çš„æ•°æ®æ¥æºäº <code>download</code> è¡¨ï¼Œå¹¶æ ¹æ® <code>select</code> è¯­å¥ä¸­çš„è¡¨è¾¾å¼è¿›è¡Œç›¸åº”â€œç‰©åŒ–â€æ“ä½œ</li><li>é€‰å–ä¸€ä¸ªæœªæ¥æ—¶é—´(å½“å‰æ—¶é—´æ˜¯ <code>2020-08-31 18:00:00</code>)ä½œä¸ºå¼€å§‹ç‚¹ <code>WHERE when &gt;= toDateTime(&#39;2020-09-01 04:00:00&#39;)</code>ï¼Œè¡¨ç¤ºåœ¨<code>2020-09-01 04:00:00</code> ä¹‹åçš„æ•°æ®æ‰ä¼šè¢«åŒæ­¥åˆ° <code>download_hour_mv</code></li></ul><p>è¿™æ ·ï¼Œç›®å‰ <code>download_hour_mv</code> æ˜¯ä¸€ä¸ªç©ºè¡¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clickhouse&gt; SELECT * FROM download_hour_mv ORDER BY userid, hour;</span><br><span class="line">Empty set (0.02 sec)</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šå®˜æ–¹æœ‰ <a href="https://clickhouse.tech/docs/en/sql-reference/statements/create/view/#materialized">POPULATE</a> å…³é”®å­—ï¼Œä½†æ˜¯ä¸å»ºè®®ä½¿ç”¨ï¼Œå› ä¸ºè§†å›¾åˆ›å»ºæœŸé—´ <code>download</code> å¦‚æœæœ‰å†™å…¥æ•°æ®ä¼šä¸¢å¤±ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åŠ ä¸€ä¸ª <code>WHERE</code> ä½œä¸ºæ•°æ®åŒæ­¥ç‚¹çš„åŸå› ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•è®©æºè¡¨æ•°æ®å¯ä»¥ä¸€è‡´æ€§çš„åŒæ­¥åˆ° <code>download_hour_mv</code> å‘¢ï¼Ÿ</p><h2 id="ç‰©åŒ–å…¨é‡æ•°æ®"><a href="#ç‰©åŒ–å…¨é‡æ•°æ®" class="headerlink" title="ç‰©åŒ–å…¨é‡æ•°æ®"></a><b>ç‰©åŒ–å…¨é‡æ•°æ®</b></h2><p>åœ¨<code>2020-09-01 04:00:00</code>ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªå¸¦ <code>WHERE</code> å¿«ç…§çš„<code>INSERT INTO SELECT...</code> å¯¹ <code>download</code> å†å²æ•°æ®è¿›è¡Œç‰©åŒ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">clickhouse&gt; INSERT INTO download_hour_mv</span><br><span class="line">SELECT</span><br><span class="line">  toStartOfHour(when) AS hour,</span><br><span class="line">  userid,</span><br><span class="line">  count() as downloads,</span><br><span class="line">  sum(bytes) AS bytes</span><br><span class="line">FROM download WHERE when &lt; toDateTime(&#x27;2020-09-01 04:00:00&#x27;)</span><br><span class="line">GROUP BY userid, hour</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ç‰©åŒ–è§†å›¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">clickhouse&gt; SELECT * FROM download_hour_mv ORDER BY hour, userid, downloads DESC;</span><br><span class="line">+---------------------+--------+-----------+------------+</span><br><span class="line">| hour                | userid | downloads | bytes      |</span><br><span class="line">+---------------------+--------+-----------+------------+</span><br><span class="line">| 2020-08-31 18:00:00 |     19 |      6822 | 3378623036 |</span><br><span class="line">| 2020-08-31 19:00:00 |     19 |     10800 | 5424173178 |</span><br><span class="line">| 2020-08-31 20:00:00 |     19 |     10800 | 5418656068 |</span><br><span class="line">| 2020-08-31 21:00:00 |     19 |     10800 | 5404309443 |</span><br><span class="line">| 2020-08-31 22:00:00 |     19 |     10800 | 5354077456 |</span><br><span class="line">| 2020-08-31 23:00:00 |     19 |     10800 | 5390852563 |</span><br><span class="line">| 2020-09-01 00:00:00 |     19 |     10800 | 5369839540 |</span><br><span class="line">| 2020-09-01 01:00:00 |     19 |     10800 | 5384161012 |</span><br><span class="line">| 2020-09-01 02:00:00 |     19 |     10800 | 5404581759 |</span><br><span class="line">| 2020-09-01 03:00:00 |     19 |      6778 | 3399557322 |</span><br><span class="line">+---------------------+--------+-----------+------------+</span><br><span class="line">10 rows in set (0.05 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ•°æ®å·²ç»â€œç‰©åŒ–â€åˆ° <code>download_hour_mv</code>ã€‚</p><h2 id="ç‰©åŒ–å¢é‡æ•°æ®"><a href="#ç‰©åŒ–å¢é‡æ•°æ®" class="headerlink" title="ç‰©åŒ–å¢é‡æ•°æ®"></a><b>ç‰©åŒ–å¢é‡æ•°æ®</b></h2><p>å†™ä¸€äº›æ•°æ®åˆ° <code>download</code>è¡¨:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">clickhouse&gt; INSERT INTO download</span><br><span class="line">       SELECT</span><br><span class="line">         toDateTime(&#x27;2020-09-01 04:00:00&#x27;) + number*(1/3) as when,</span><br><span class="line">         19,</span><br><span class="line">         rand() % 1000000</span><br><span class="line">       FROM system.numbers</span><br><span class="line">       LIMIT 10;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ç‰©åŒ–è§†å›¾ <code>download_hour_mv</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">clickhouse&gt; SELECT * FROM download_hour_mv ORDER BY hour, userid, downloads;</span><br><span class="line">+---------------------+--------+-----------+------------+</span><br><span class="line">| hour                | userid | downloads | bytes      |</span><br><span class="line">+---------------------+--------+-----------+------------+</span><br><span class="line">| 2020-08-31 18:00:00 |     19 |      6822 | 3378623036 |</span><br><span class="line">| 2020-08-31 19:00:00 |     19 |     10800 | 5424173178 |</span><br><span class="line">| 2020-08-31 20:00:00 |     19 |     10800 | 5418656068 |</span><br><span class="line">| 2020-08-31 21:00:00 |     19 |     10800 | 5404309443 |</span><br><span class="line">| 2020-08-31 22:00:00 |     19 |     10800 | 5354077456 |</span><br><span class="line">| 2020-08-31 23:00:00 |     19 |     10800 | 5390852563 |</span><br><span class="line">| 2020-09-01 00:00:00 |     19 |     10800 | 5369839540 |</span><br><span class="line">| 2020-09-01 01:00:00 |     19 |     10800 | 5384161012 |</span><br><span class="line">| 2020-09-01 02:00:00 |     19 |     10800 | 5404581759 |</span><br><span class="line">| 2020-09-01 03:00:00 |     19 |      6778 | 3399557322 |</span><br><span class="line">| 2020-09-01 04:00:00 |     19 |        10 |    5732600 |</span><br><span class="line">+---------------------+--------+-----------+------------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€åä¸€æ¡æ•°æ®å°±æ˜¯æˆ‘ä»¬å¢é‡çš„ä¸€ä¸ªç‰©åŒ–èšåˆï¼Œå·²ç»å®æ—¶åŒæ­¥ï¼Œè¿™æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p><h2 id="ç‰©åŒ–è§†å›¾åŸç†"><a href="#ç‰©åŒ–è§†å›¾åŸç†" class="headerlink" title="ç‰©åŒ–è§†å›¾åŸç†"></a><b>ç‰©åŒ–è§†å›¾åŸç†</b></h2><p>ClickHouse çš„ç‰©åŒ–è§†å›¾åŸç†å¹¶ä¸å¤æ‚ï¼Œåœ¨ <code>download</code> è¡¨æœ‰æ–°çš„æ•°æ®å†™å…¥æ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°æœ‰ç‰©åŒ–è§†å›¾è·Ÿå®ƒå…³è”ï¼Œä¼šé’ˆå¯¹è¿™æ‰¹å†™å…¥çš„æ•°æ®è¿›è¡Œç‰©åŒ–æ“ä½œã€‚</p><p>æ¯”å¦‚ä¸Šé¢æ–°å¢æ•°æ®æ˜¯é€šè¿‡ä»¥ä¸‹ SQL ç”Ÿæˆçš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">clickhouse&gt; SELECT</span><br><span class="line">    -&gt;          toDateTime(&#x27;2020-09-01 04:00:00&#x27;) + number*(1/3) as when,</span><br><span class="line">    -&gt;          19,</span><br><span class="line">    -&gt;          rand() % 1000000</span><br><span class="line">    -&gt;        FROM system.numbers</span><br><span class="line">    -&gt;        LIMIT 10;</span><br><span class="line">+---------------------+------+-------------------------+</span><br><span class="line">| when                | 19   | modulo(rand(), 1000000) |</span><br><span class="line">+---------------------+------+-------------------------+</span><br><span class="line">| 2020-09-01 04:00:00 |   19 |                  870495 |</span><br><span class="line">| 2020-09-01 04:00:00 |   19 |                  322270 |</span><br><span class="line">| 2020-09-01 04:00:00 |   19 |                  983422 |</span><br><span class="line">| 2020-09-01 04:00:01 |   19 |                  759708 |</span><br><span class="line">| 2020-09-01 04:00:01 |   19 |                  975636 |</span><br><span class="line">| 2020-09-01 04:00:01 |   19 |                  365507 |</span><br><span class="line">| 2020-09-01 04:00:02 |   19 |                  865569 |</span><br><span class="line">| 2020-09-01 04:00:02 |   19 |                  975742 |</span><br><span class="line">| 2020-09-01 04:00:02 |   19 |                   85827 |</span><br><span class="line">| 2020-09-01 04:00:03 |   19 |                  992779 |</span><br><span class="line">+---------------------+------+-------------------------+</span><br><span class="line">10 rows in set (0.02 sec)</span><br></pre></td></tr></table></figure><p>ç‰©åŒ–è§†å›¾æ‰§è¡Œçš„è¯­å¥ç±»ä¼¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO download_hour_mv</span><br><span class="line">SELECT</span><br><span class="line">  toStartOfHour(when) AS hour,</span><br><span class="line">  userid,</span><br><span class="line">  count() as downloads,</span><br><span class="line">  sum(bytes) AS bytes</span><br><span class="line">FROM [æ–°å¢çš„10æ¡æ•°æ®] WHERE when &gt;= toDateTime(&#x27;2020-09-01 04:00:00&#x27;)</span><br><span class="line">GROUP BY userid, hour</span><br></pre></td></tr></table></figure><p>ä»£ç å¯¼èˆªï¼š</p><ol><li><p>æ·»åŠ è§†å›¾ OutputStreamï¼Œ <a href="https://github.com/ClickHouse/ClickHouse/blob/cb4644ea6d04b3d5900868b4f8d686a03082379a/src/Interpreters/InterpreterInsertQuery.cpp#L313">InterpreterInsertQuery.cpp</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (table-&gt;noPushingToViews() &amp;&amp; !no_destination)</span><br><span class="line">    out = table-&gt;write(query_ptr, metadata_snapshot, context);</span><br><span class="line">else</span><br><span class="line">    out = std::make_shared&lt;PushingToViewsBlockOutputStream&gt;(table, metadata_snapshot, context, query_ptr, no_destination);</span><br></pre></td></tr></table></figure></li><li><p>æ„é€  Insert ï¼Œ <a href="https://github.com/ClickHouse/ClickHouse/blob/cb4644ea6d04b3d5900868b4f8d686a03082379a/src/DataStreams/PushingToViewsBlockOutputStream.cpp#L85">PushingToViewsBlockOutputStream.cpp</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ASTPtr insert_query_ptr(insert.release());</span><br><span class="line">InterpreterInsertQuery interpreter(insert_query_ptr, *insert_context);</span><br><span class="line">BlockIO io = interpreter.execute();</span><br><span class="line">out = io.out;</span><br></pre></td></tr></table></figure></li><li><p>ç‰©åŒ–æ–°å¢æ•°æ®ï¼š<a href="https://github.com/ClickHouse/ClickHouse/blob/cb4644ea6d04b3d5900868b4f8d686a03082379a/src/DataStreams/PushingToViewsBlockOutputStream.cpp#L331">PushingToViewsBlockOutputStream.cpp</a></p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Context local_context = *select_context;</span><br><span class="line">local_context.addViewSource(</span><br><span class="line">    StorageValues::create(</span><br><span class="line">        storage-&gt;getStorageID(), metadata_snapshot-&gt;getColumns(), block, storage-&gt;getVirtuals()));</span><br><span class="line">select.emplace(view.query, local_context, SelectQueryOptions());</span><br><span class="line">in = std::make_shared&lt;MaterializingBlockInputStream&gt;(select-&gt;execute().getInputStream()</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><b>æ€»ç»“</b></h2><p>ç‰©åŒ–è§†å›¾çš„ç”¨é€”è¾ƒå¤šã€‚</p><p>æ¯”å¦‚å¯ä»¥è§£å†³è¡¨ç´¢å¼•é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ç‰©åŒ–è§†å›¾åˆ›å»ºå¦å¤–ä¸€ç§ç‰©ç†åºï¼Œæ¥æ»¡è¶³æŸäº›æ¡ä»¶ä¸‹çš„æŸ¥è¯¢é—®é¢˜ã€‚</p><p>è¿˜æœ‰å°±æ˜¯é€šè¿‡ç‰©åŒ–è§†å›¾çš„å®æ—¶åŒæ­¥æ•°æ®èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥åšåˆ°æ›´åŠ çµæ´»çš„è¡¨ç»“æ„å˜æ›´ã€‚</p><p>æ›´å¼ºå¤§çš„åœ°æ–¹æ˜¯å®ƒå¯ä»¥å€ŸåŠ© MergeTree å®¶æ—å¼•æ“(SummingMergeTreeã€Aggregatingmergetreeç­‰)ï¼Œå¾—åˆ°ä¸€ä¸ªå®æ—¶çš„é¢„èšåˆï¼Œæ»¡è¶³å¿«é€ŸæŸ¥è¯¢ã€‚</p><p>åŸç†æ˜¯æŠŠå¢é‡çš„æ•°æ®æ ¹æ® <code>AS SELECT ...</code> å¯¹å…¶è¿›è¡Œå¤„ç†å¹¶å†™å…¥åˆ°ç‰©åŒ–è§†å›¾è¡¨ï¼Œç‰©åŒ–è§†å›¾æ˜¯ä¸€ç§æ™®é€šè¡¨ï¼Œå¯ä»¥ç›´æ¥è¯»å–å’Œå†™å…¥ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;img src=&quot;https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/clickhouse-map-2020-materializeview.png&quot; align=&quot;center&quot; style=&quot;zoom:</summary>
      
    
    
    
    
    <category term="clickhouse" scheme="https://bohutang.me/tags/clickhouse/"/>
    
    <category term="ClickHouseå’Œä»–çš„æœ‹å‹ä»¬" scheme="https://bohutang.me/tags/ClickHouse%E5%92%8C%E4%BB%96%E7%9A%84%E6%9C%8B%E5%8F%8B%E4%BB%AC/"/>
    
    <category term="materialized view" scheme="https://bohutang.me/tags/materialized-view/"/>
    
    <category term="ç‰©åŒ–è§†å›¾" scheme="https://bohutang.me/tags/%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆ11ï¼‰MySQLå®æ—¶å¤åˆ¶ä¹‹GTIDæ¨¡å¼</title>
    <link href="https://bohutang.me/2020/08/26/clickhouse-and-friends-mysql-gtid-replication/"/>
    <id>https://bohutang.me/2020/08/26/clickhouse-and-friends-mysql-gtid-replication/</id>
    <published>2020-08-25T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.051Z</updated>
    
    <content type="html"><![CDATA[<img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/clickhouse-map-2020-materialzemysql.png" align="center" style="zoom:50%;" /><p><b>æœ€åæ›´æ–°: 2020-09-03</b></p><p> <a href="/2020/07/26/clickhouse-and-friends-mysql-replication/">MySQLå®æ—¶å¤åˆ¶åŸç†ç¯‡</a></p><p>å‡ å¤©å‰ ClickHouse å®˜æ–¹å‘å¸ƒäº† <a href="https://github.com/ClickHouse/ClickHouse/releases/tag/v20.8.1.4447-testing">v20.8.1.4447-testing</a>ï¼Œè¿™ä¸ªç‰ˆæœ¬å·²ç»åŒ…å«äº† MaterializeMySQL å¼•æ“ï¼Œå®ç°äº† ClickHouse å®æ—¶å¤åˆ¶ MySQL æ•°æ®çš„èƒ½åŠ›ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥é€šè¿‡å®˜æ–¹å®‰è£…åŒ…æ¥åšä½“éªŒï¼Œå®‰è£…æ–¹å¼å‚è€ƒ: <a href="https://clickhouse.tech/#quick-start">https://clickhouse.tech/#quick-start</a>ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¦é€‰æ‹© testing åˆ†æ”¯ã€‚</p><h2 id="åŸºäºä½ç‚¹åŒæ­¥"><a href="#åŸºäºä½ç‚¹åŒæ­¥" class="headerlink" title="åŸºäºä½ç‚¹åŒæ­¥"></a><b>åŸºäºä½ç‚¹åŒæ­¥</b></h2><p>MaterializeMySQL åœ¨ v20.8.1.4447-testing ç‰ˆæœ¬æ˜¯åŸºäº binlog ä½ç‚¹æ¨¡å¼è¿›è¡ŒåŒæ­¥çš„ã€‚</p><p>æ¯æ¬¡æ¶ˆè´¹å®Œä¸€æ‰¹ binlog eventï¼Œå°±ä¼šè®°å½• event çš„ä½ç‚¹ä¿¡æ¯åˆ° .metadata æ–‡ä»¶:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Version:1</span><br><span class="line">Binlog File:mysql-bin.000002</span><br><span class="line">Binlog Position:328</span><br><span class="line">Data Version:1</span><br></pre></td></tr></table></figure><p>è¿™æ ·å½“ ClickHouse å†æ¬¡å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæŠŠ {â€˜mysql-bin.000002â€™, 328} äºŒå…ƒç»„é€šè¿‡åè®®å‘ŠçŸ¥ MySQL Serverï¼ŒMySQL ä»è¿™ä¸ªä½ç‚¹å¼€å§‹å‘é€æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s1&gt; ClickHouse å‘é€ &#123;&#x27;mysql-bin.000002&#x27;, 328&#125; ä½ç‚¹ä¿¡æ¯ç»™ MySQL</span><br><span class="line">s2&gt; MySQL æ‰¾åˆ°æœ¬åœ° mysql-bin.000002 æ–‡ä»¶å¹¶å®šä½åˆ° 328 åç§»ä½ç½®ï¼Œè¯»å–ä¸‹ä¸€ä¸ª event å‘é€ç»™ ClickHouse</span><br><span class="line">s3&gt; ClickHouse æ¥æ”¶ binlog event å¹¶æ›´æ–° .metadataä½ç‚¹</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥ä¸é”™å“¦ï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼š<br>å¦‚æœ MySQL Server æ˜¯ä¸€ä¸ªé›†ç¾¤(æ¯”å¦‚ï¼‘ä¸»ï¼’ä»)ï¼Œé€šè¿‡ VIP å¯¹å¤–æœåŠ¡ï¼ŒMaterializeMySQL çš„ host æŒ‡å‘çš„æ˜¯è¿™ä¸ª vipã€‚<br>å½“é›†ç¾¤ä¸»ä»å‘ç”Ÿåˆ‡æ¢åï¼Œ{binlog-name, binlog-position} äºŒå…ƒç»„å…¶å®æ˜¯ä¸å‡†ç¡®çš„ï¼Œå› ä¸ºé›†ç¾¤é‡Œä¸»ä» binlog ä¸ä¸€å®šæ˜¯å®Œå…¨ä¸€è‡´çš„(binlog å¯ä»¥åš reset æ“ä½œ)ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s1&gt; ClickHouse å‘é€ &#123;&#x27;mysql-bin.000002&#x27;, 328&#125; ç»™é›†ç¾¤æ–°ä¸» MySQL</span><br><span class="line">s2&gt; æ–°ä¸» MySQL å‘ç°æœ¬åœ°æ²¡æœ‰ mysql-bin.000002 æ–‡ä»¶ï¼Œå› ä¸ºå®ƒåšè¿‡ reset master æ“ä½œï¼Œbinlog æ–‡ä»¶æ˜¯ mysql-bin.000001</span><br><span class="line">... oops ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼€å‘äº† GTID åŒæ­¥æ¨¡å¼ï¼ŒåºŸå¼ƒäº†ä¸å®‰å…¨çš„ä½ç‚¹åŒæ­¥æ¨¡å¼ï¼Œç›®å‰å·²è¢« upstream merged <a href="https://github.com/ClickHouse/ClickHouse/pull/13820">#PR13820</a>ï¼Œä¸‹ä¸€ä¸ª testing ç‰ˆæœ¬å³å¯ä½“éªŒã€‚</p><p>ç€æ€¥çš„è¯å¯ä»¥è‡ªå·±ç¼–è¯‘æˆ–é€šè¿‡ <a href="https://clickhouse-builds.s3.yandex.net/0/2b8ad576cc3892d2d760f3f8b670adf17db0c2a0/clickhouse_build_check/report.html">ClickHouse Build Check for master-20.9.1</a> ä¸‹è½½å®‰è£…ã€‚</p><h2 id="åŸºäºGTIDåŒæ­¥"><a href="#åŸºäºGTIDåŒæ­¥" class="headerlink" title="åŸºäºGTIDåŒæ­¥"></a><b>åŸºäºGTIDåŒæ­¥</b></h2><p>GTID æ˜¯ MySQL å¤åˆ¶å¢å¼ºç‰ˆï¼Œä» MySQL 5.6 ç‰ˆæœ¬å¼€å§‹æ”¯æŒï¼Œç›®å‰å·²ç»æ˜¯ MySQL ä¸»æµå¤åˆ¶æ¨¡å¼ã€‚</p><p>å®ƒä¸ºæ¯ä¸ª event åˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€IDå’Œåºå·ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨å…³å¿ƒ MySQL é›†ç¾¤ä¸»ä»æ‹“æ‰‘ç»“æ„ï¼Œç›´æ¥å‘ŠçŸ¥ MySQL è¿™ä¸ª GTID å³å¯ï¼Œ.metadataå˜ä¸º:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Version:2</span><br><span class="line">Executed GTID:f4aee41e-e36f-11ea-8b37-0242ac110002:1-5</span><br><span class="line">Data Version:1</span><br></pre></td></tr></table></figure><p><code>f4aee41e-e36f-11ea-8b37-0242ac110002</code> æ˜¯ç”Ÿæˆ eventçš„ä¸»æœºUUIDï¼Œ<code>1-5</code>æ˜¯å·²ç»åŒæ­¥çš„eventåŒºé—´ã€‚</p><p>è¿™æ ·æµç¨‹å°±å˜ä¸º:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s1&gt; ClickHouse å‘é€ GTID:f4aee41e-e36f-11ea-8b37-0242ac110002:1-5 ç»™ MySQL</span><br><span class="line">s2&gt; MySQL æ ¹æ® GTID:f4aee41e-e36f-11ea-8b37-0242ac110002:1-5 æ‰¾åˆ°æœ¬åœ°ä½ç‚¹ï¼Œè¯»å–ä¸‹ä¸€ä¸ª event å‘é€ç»™ ClickHouse</span><br><span class="line">s3&gt; ClickHouse æ¥æ”¶ binlog event å¹¶æ›´æ–° .metadata GTIDä¿¡æ¯</span><br></pre></td></tr></table></figure><h2 id="MySQLå¼€å¯GTID"><a href="#MySQLå¼€å¯GTID" class="headerlink" title="Â MySQLå¼€å¯GTID"></a><b>Â MySQLå¼€å¯GTID</b></h2><p>é‚£ä¹ˆï¼ŒMySQL ä¾§æ€ä¹ˆå¼€å¯ GTID å‘¢ï¼Ÿå¢åŠ ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°å³å¯:</p><p><code>--gtid-mode=ON --enforce-gtid-consistency</code></p><p>æ¯”å¦‚å¯åŠ¨ä¸€ä¸ªå¯ç”¨ GTID çš„ MySQL dockerï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -e MYSQL_ROOT_PASSWORD=123 mysql:5.7 mysqld --datadir=/var/lib/mysql --server-id=1 --log-bin=/var/lib/mysql/mysql-bin.log --gtid-mode=ON --enforce-gtid-consistency</span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a><b>æ³¨æ„äº‹é¡¹</b></h2><p>å¯ç”¨ GTID å¤åˆ¶æ¨¡å¼åï¼Œmetadata Version ä¼šå˜ä¸º 2ï¼Œä¹Ÿå°±æ˜¯è€ç‰ˆæœ¬å¯åŠ¨æ—¶ä¼šç›´æ¥æŠ¥é”™ï¼Œdatabase éœ€è¦é‡å»ºã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><b>æ€»ç»“</b></h2><p>MaterializeMySQL å¼•æ“è¿˜å¤„äºä¸åœè¿­ä»£ä¸­ï¼Œå¯¹äºå®ƒæˆ‘ä»¬æœ‰ä¸€ä¸ªåˆæ­¥çš„è§„åˆ’ï¼š</p><ul><li><p><b>ç¨³å®šæ€§ä¿è¯</b><br>è¿™å—éœ€è¦æ›´å¤šæµ‹è¯•ï¼Œæ›´å¤šè¯•ç”¨åé¦ˆ</p></li><li><p><b>ç´¢å¼•ä¼˜åŒ–</b><br>OLTP ç´¢å¼•ä¸€èˆ¬ä¸æ˜¯ä¸º OLAP è®¾è®¡ï¼Œç›®å‰ç´¢å¼•è½¬æ¢è¿˜æ˜¯ä¾èµ– MySQL è¡¨ç»“æ„ï¼Œéœ€è¦æ›´åŠ æ™ºèƒ½åŒ–</p></li><li><p><b>å¯è§‚æµ‹æ€§</b><br>åœ¨ ClickHouse ä¾§å¯ä»¥æ–¹ä¾¿çš„æŸ¥çœ‹å½“å‰åŒæ­¥ä¿¡æ¯ï¼Œç±»ä¼¼ MySQL <code>show slave status</code></p></li><li><p><b>æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ</b><br>éœ€è¦æä¾›æ–¹å¼å¯ä»¥æ ¡éªŒ MySQL å’Œ ClickHouse æ•°æ®ä¸€è‡´æ€§</p></li></ul><p>MaterializeMySQL å·²ç»æ˜¯ç¤¾åŒºåŠŸèƒ½ï¼Œä»ç„¶æœ‰ä¸å°‘çš„å·¥ä½œè¦åšã€‚æœŸå¾…æ›´å¤šçš„åŠ›é‡åŠ å…¥ï¼Œæˆ‘ä»¬çš„å¾é€”ä¸æ­¢æ˜Ÿè¾°å¤§æµ·ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;img src=&quot;https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/clickhouse-map-2020-materialzemysql.png&quot; align=&quot;center&quot; style=&quot;zoom:</summary>
      
    
    
    
    
    <category term="clickhouse" scheme="https://bohutang.me/tags/clickhouse/"/>
    
    <category term="ClickHouseå’Œä»–çš„æœ‹å‹ä»¬" scheme="https://bohutang.me/tags/ClickHouse%E5%92%8C%E4%BB%96%E7%9A%84%E6%9C%8B%E5%8F%8B%E4%BB%AC/"/>
    
    <category term="MySQL" scheme="https://bohutang.me/tags/MySQL/"/>
    
    <category term="replication" scheme="https://bohutang.me/tags/replication/"/>
    
    <category term="GTID" scheme="https://bohutang.me/tags/GTID/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆ10ï¼‰MergeTree Write-Ahead Log</title>
    <link href="https://bohutang.me/2020/08/18/clickhouse-and-friends-merge-tree-wal/"/>
    <id>https://bohutang.me/2020/08/18/clickhouse-and-friends-merge-tree-wal/</id>
    <published>2020-08-17T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.051Z</updated>
    
    <content type="html"><![CDATA[<p><b>æœ€åæ›´æ–°: 2020-09-18</b></p><p>æ•°æ®åº“ç³»ç»Ÿä¸ºäº†æé«˜å†™å…¥æ€§èƒ½ï¼Œä¼šæŠŠæ•°æ®å…ˆå†™åˆ°å†…å­˜ï¼Œç­‰â€œæ”’â€åˆ°ä¸€å®šç¨‹åº¦åå†å›å†™åˆ°ç£ç›˜ï¼Œæ¯”å¦‚ MySQL çš„ buffer pool æœºåˆ¶ã€‚</p><p>å› ä¸ºæ•°æ®å…ˆå†™åˆ°å†…å­˜ï¼Œä¸ºäº†æ•°æ®çš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª Write-Ahead Log (WAL) æ¥ä¿è¯å†…å­˜æ•°æ®çš„å®‰å…¨æ€§ã€‚</p><p>ä»Šå¤©æˆ‘ä»¬æ¥çœ‹çœ‹ ClickHouse æ–°å¢çš„ <a href="https://github.com/ClickHouse/ClickHouse/pull/8290">MergeTreeWriteAheadLog</a> æ¨¡å—ï¼Œå®ƒåˆ°åº•è§£å†³äº†ä»€ä¹ˆé—®é¢˜ã€‚</p><h2 id="é«˜é¢‘å†™é—®é¢˜"><a href="#é«˜é¢‘å†™é—®é¢˜" class="headerlink" title="é«˜é¢‘å†™é—®é¢˜"></a><b>é«˜é¢‘å†™é—®é¢˜</b></h2><p>å¯¹äº ClickHouse MergeTree å¼•æ“ï¼Œæ¯æ¬¡å†™å…¥(å³ä½¿ï¼‘æ¡æ•°æ®)éƒ½ä¼šåœ¨ç£ç›˜ç”Ÿæˆä¸€ä¸ªåˆ†åŒºç›®å½•(part)ï¼Œç­‰ç€ merge çº¿ç¨‹åˆå¹¶ã€‚</p><p>å¦‚æœæœ‰å¤šä¸ªå®¢æˆ·ç«¯ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯å†™å…¥çš„æ•°æ®é‡è¾ƒå°‘ã€æ¬¡æ•°è¾ƒé¢‘ç¹çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šå¼•å‘ <code>DB::Exception: Too many parts</code> é”™è¯¯ã€‚</p><p>è¿™æ ·å°±å¯¹å®¢æˆ·ç«¯æœ‰ä¸€å®šçš„è¦æ±‚ï¼Œæ¯”å¦‚éœ€è¦åš batch å†™å…¥ã€‚</p><p>æˆ–è€…ï¼Œå†™å…¥åˆ° Buffer å¼•æ“ï¼Œå®šæ—¶çš„åˆ·å› MergeTreeï¼Œç¼ºç‚¹æ˜¯åœ¨å®•æœºæ—¶å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ã€‚</p><h2 id="MergeTree-WAL"><a href="#MergeTree-WAL" class="headerlink" title="MergeTree WAL"></a><b>MergeTree WAL</b></h2><h3 id="1-é»˜è®¤æ¨¡å¼"><a href="#1-é»˜è®¤æ¨¡å¼" class="headerlink" title="1. é»˜è®¤æ¨¡å¼"></a><b>1. é»˜è®¤æ¨¡å¼</b></h3><p>æˆ‘ä»¬å…ˆçœ‹çœ‹åœ¨æ²¡æœ‰ WAL æƒ…å†µä¸‹ï¼ŒMergeTree æ˜¯å¦‚ä½•å†™å…¥çš„ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/mergetree-part-raw.png" align="center" style="zoom:50%;" /><p>æ¯æ¬¡å†™å…¥ MergeTree éƒ½ä¼šç›´æ¥åœ¨ç£ç›˜ä¸Šåˆ›å»ºåˆ†åŒºç›®å½•ï¼Œå¹¶ç”Ÿæˆåˆ†åŒºæ•°æ®ï¼Œè¿™ç§æ¨¡å¼å…¶å®å°±æ˜¯ WAL + æ•°æ®çš„èåˆã€‚</p><p>å¾ˆæ˜¾ç„¶ï¼Œè¿™ç§æ¨¡å¼ä¸é€‚åˆé¢‘ç¹å†™æ“ä½œçš„æƒ…å†µï¼Œå¦åˆ™ä¼šç”Ÿæˆéå¸¸å¤šçš„åˆ†åŒºç›®å½•å’Œæ–‡ä»¶ï¼Œå¼•å‘ <code>Too many parts</code> é”™è¯¯ã€‚</p><h3 id="2-WALæ¨¡å¼"><a href="#2-WALæ¨¡å¼" class="headerlink" title="2. WALæ¨¡å¼"></a><b>2. WALæ¨¡å¼</b></h3><p>è®¾ç½®SETTINGS: <code>min_rows_for_compact_part=2</code>ï¼Œåˆ†åˆ«æ‰§è¡Œï¼’æ¡å†™ SQLï¼Œæ•°æ®ä¼šå…ˆå†™åˆ° wal.bin æ–‡ä»¶ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/mergetree-part-wal.png" align="center" style="zoom:50%;" /><p>å½“æ»¡è¶³  <code>min_rows_for_compact_part=2</code> åï¼Œmerger çº¿ç¨‹è§¦å‘åˆå¹¶æ“ä½œï¼Œç”Ÿæˆ  <code>1_1_2_1</code> åˆ†åŒºï¼Œä¹Ÿå°±æ˜¯å®Œæˆäº† wal.bin é‡Œçš„ <code>1_1_1_0</code> å’Œ <code>1_2_2_0</code> ä¸¤ä¸ªåˆ†åŒºçš„åˆå¹¶æ“ä½œã€‚å½“æˆ‘ä»¬æ‰§è¡Œç¬¬ä¸‰æ¡ SQL å†™å…¥:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into default.mt(a,b,c) values(1,3,3)</span><br></pre></td></tr></table></figure><p>æ•°æ®å—(åˆ†åŒº)ä¼šç»§ç»­è¿½åŠ åˆ° wal.bin å°¾éƒ¨ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/mergetree-part-wal-merge.png" align="center" style="zoom:50%;" /><p>æ­¤æ—¶ï¼Œ3 æ¡æ•°æ®åˆ†å¸ƒåœ¨ä¸¤ä¸ªåœ°æ–¹ï¼šåˆ†åŒº <code>1_1_2_1</code>ï¼Œ wal.bin é‡Œçš„ <code>1_3_3_0</code>ã€‚</p><p>è¿™æ ·å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå½“æˆ‘ä»¬æ‰§è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œæ•°æ®æ˜¯æ€ä¹ˆåˆå¹¶çš„å‘¢ï¼Ÿ</p><p>MergeTree ä½¿ç”¨å…¨å±€ç»“æ„ <code>data_parts_indexes</code> ç»´æŠ¤åˆ†åŒºä¿¡æ¯ï¼Œå½“æœåŠ¡å¯åŠ¨çš„æ—¶å€™ï¼Œ<code> MergeTreeData::loadDataParts</code>æ–¹æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. data_parts_indexes.insert(1_1_2_1)</span><br><span class="line">2. è¯»å– wal.binï¼Œé€šè¿‡ getActiveContainingPart åˆ¤æ–­åˆ†åŒºæ˜¯å¦å·²ç»mergeåˆ°ç£ç›˜ï¼š1_1_1_0 å·²ç»å­˜åœ¨, 1_2_2_0 å·²ç»å­˜åœ¨ï¼Œdata_parts_indexes.insert(1_3_3_0)</span><br><span class="line">3. data_parts_indexes:&#123;1_1_2_1,1_3_3_0&#125; </span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå®ƒæ€»æ˜¯èƒ½ç»´æŠ¤å…¨å±€çš„åˆ†åŒºä¿¡æ¯ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><b>æ€»ç»“</b></h2><p>WAL åŠŸèƒ½åœ¨ <a href="https://github.com/ClickHouse/ClickHouse/pull/8290">PRï¼ƒ8290</a> å®ç°ï¼Œmaster åˆ†æ”¯å·²ç»é»˜è®¤å¼€å¯ã€‚</p><p>MergeTree é€šè¿‡ WAL æ¥ä¿æŠ¤å®¢æˆ·ç«¯çš„é«˜é¢‘ã€å°‘é‡å†™æœºåˆ¶ï¼Œå‡å°‘æœåŠ¡ç«¯ç›®å½•å’Œæ–‡ä»¶æ•°é‡ï¼Œè®©å®¢æˆ·ç«¯æ“ä½œå°½å¯èƒ½ç®€å•ã€é«˜æ•ˆã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;b&gt;æœ€åæ›´æ–°: 2020-09-18&lt;/b&gt;&lt;/p&gt;
&lt;p&gt;æ•°æ®åº“ç³»ç»Ÿä¸ºäº†æé«˜å†™å…¥æ€§èƒ½ï¼Œä¼šæŠŠæ•°æ®å…ˆå†™åˆ°å†…å­˜ï¼Œç­‰â€œæ”’â€åˆ°ä¸€å®šç¨‹åº¦åå†å›å†™åˆ°ç£ç›˜ï¼Œæ¯”å¦‚ MySQL çš„ buffer pool æœºåˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;å› ä¸ºæ•°æ®å…ˆå†™åˆ°å†…å­˜ï¼Œä¸ºäº†æ•°æ®çš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª Write</summary>
      
    
    
    
    
    <category term="clickhouse" scheme="https://bohutang.me/tags/clickhouse/"/>
    
    <category term="ClickHouseå’Œä»–çš„æœ‹å‹ä»¬" scheme="https://bohutang.me/tags/ClickHouse%E5%92%8C%E4%BB%96%E7%9A%84%E6%9C%8B%E5%8F%8B%E4%BB%AC/"/>
    
    <category term="mergetree" scheme="https://bohutang.me/tags/mergetree/"/>
    
    <category term="WAL" scheme="https://bohutang.me/tags/WAL/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆ9ï¼‰MySQLå®æ—¶å¤åˆ¶ä¸å®ç°</title>
    <link href="https://bohutang.me/2020/07/26/clickhouse-and-friends-mysql-replication/"/>
    <id>https://bohutang.me/2020/07/26/clickhouse-and-friends-mysql-replication/</id>
    <published>2020-07-25T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.052Z</updated>
    
    <content type="html"><![CDATA[<img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/clickhouse-map-2020-materialzemysql.png" align="center" style="zoom:50%;" /><p><b>æœ€åæ›´æ–°: 2020-09-08</b></p><p>å¾ˆå¤šäººçœ‹åˆ°æ ‡é¢˜è¿˜ä»¥ä¸ºè‡ªå·±èµ°é”™äº†å¤œåœºï¼Œå…¶å®æ²¡æœ‰ã€‚</p><p>ClickHouse  å¯ä»¥æŒ‚è½½ä¸º MySQL çš„ä¸€ä¸ªä»åº“ ï¼Œå…ˆå…¨é‡å†å¢é‡çš„å®æ—¶åŒæ­¥ MySQL æ•°æ®ï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥è¯´æ˜¯ä»Šå¹´æœ€äº®çœ¼ã€æœ€åˆšéœ€çš„åŠŸèƒ½ï¼ŒåŸºäºå®ƒæˆ‘ä»¬å¯ä»¥è½»æ¾çš„æ‰“é€ ä¸€å¥—ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆï¼Œè®© OLTP å’Œ OLAP çš„èåˆä»æ­¤ä¸å†å¤´ç–¼ã€‚</p><p>ç›®å‰æ”¯æŒ MySQL 5.6&#x2F;5.7&#x2F;8.0 ç‰ˆæœ¬ï¼Œå…¼å®¹ Delete&#x2F;Update è¯­å¥ï¼ŒåŠå¤§éƒ¨åˆ†å¸¸ç”¨çš„ DDL æ“ä½œã€‚<br><a href="https://github.com/ClickHouse/ClickHouse/pull/10851">ä»£ç </a>å·²ç»åˆå¹¶åˆ° upstream master åˆ†æ”¯ï¼Œé¢„è®¡åœ¨20.8ç‰ˆæœ¬ä½œä¸ºexperimental åŠŸèƒ½å‘å¸ƒã€‚</p><p>æ¯•ç«Ÿæ˜¯ä¸¤ä¸ªå¼‚æ„ç”Ÿæ€çš„èåˆï¼Œä»ç„¶æœ‰ä¸å°‘çš„å·¥ä½œè¦åšï¼ŒåŒæ—¶ä¹ŸæœŸå¾…ç€ç¤¾åŒºç”¨æˆ·çš„åé¦ˆï¼Œä»¥åŠ é€Ÿè¿­ä»£ã€‚</p><h2 id="ä»£ç è·å–"><a href="#ä»£ç è·å–" class="headerlink" title="ä»£ç è·å–"></a><b>ä»£ç è·å–</b></h2><p>è·å– <a href="https://github.com/ClickHouse/ClickHouse">clickhouse&#x2F;master</a> ä»£ç ç¼–è¯‘å³å¯ï¼Œæ–¹æ³•è§ <a href="/2020/06/05/clickhouse-and-friends-development/">ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆ1ï¼‰ç¼–è¯‘ã€å¼€å‘ã€æµ‹è¯•</a>â€¦</p><h2 id="MySQL-Master"><a href="#MySQL-Master" class="headerlink" title=" MySQL Master"></a><b> MySQL Master</b></h2><p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¼€å¯ binlog çš„ MySQL ä½œä¸º master:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -e MYSQL_ROOT_PASSWORD=123 mysql:5.7 mysqld --datadir=/var/lib/mysql --server-id=1 --log-bin=/var/lib/mysql/mysql-bin.log --gtid-mode=ON --enforce-gtid-consistency</span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ•°æ®åº“å’Œè¡¨ï¼Œå¹¶å†™å…¥æ•°æ®:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database ckdb;</span><br><span class="line">mysql&gt; use ckdb;</span><br><span class="line">mysql&gt; create table t1(a int not null primary key, b int);</span><br><span class="line">mysql&gt; insert into t1 values(1,1),(2,2);</span><br><span class="line">mysql&gt; select * from t1;</span><br><span class="line">+---+------+</span><br><span class="line">| a | b    |</span><br><span class="line">+---+------+</span><br><span class="line">| 1 |    1 |</span><br><span class="line">| 2 |    2 |</span><br><span class="line">+---+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ClickHouse-Slave"><a href="#ClickHouse-Slave" class="headerlink" title="ClickHouse Slave "></a><b>ClickHouse Slave </b></h2><p>ç›®å‰ä»¥ database ä¸ºå•ä½è¿›è¡Œå¤åˆ¶ï¼Œä¸åŒçš„ database å¯ä»¥æ¥è‡ªä¸åŒçš„ MySQL masterï¼Œè¿™æ ·å°±å¯ä»¥å®ç°å¤šä¸ª MySQL æºæ•°æ®åŒæ­¥åˆ°ä¸€ä¸ª ClickHouse åš OLAP åˆ†æåŠŸèƒ½ã€‚</p><p>é¦–å…ˆå¼€å¯ä½“éªŒå¼€å…³:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clickhouse :) SET allow_experimental_database_materialize_mysql=1;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªå¤åˆ¶é€šé“ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">clickhouse :) CREATE DATABASE ckdb ENGINE = MaterializeMySQL(&#x27;172.17.0.2:3306&#x27;, &#x27;ckdb&#x27;, &#x27;root&#x27;, &#x27;123&#x27;);</span><br><span class="line">clickhouse :) use ckdb;</span><br><span class="line">clickhouse :) show tables;</span><br><span class="line">â”Œâ”€nameâ”€â”</span><br><span class="line">â”‚ t1   â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">clickhouse :) select * from t1;</span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”</span><br><span class="line">â”‚ 1 â”‚ 1 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”</span><br><span class="line">â”‚ 2 â”‚ 2 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">2 rows in set. Elapsed: 0.017 sec. </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>çœ‹ä¸‹ ClickHouse çš„åŒæ­¥ä½ç‚¹ï¼š<br>cat ckdatas&#x2F;metadata&#x2F;ckdb&#x2F;.metadata</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Version:1</span><br><span class="line">Binlog File:mysql-bin.000001</span><br><span class="line">Binlog Position:913</span><br><span class="line">Data Version:0</span><br></pre></td></tr></table></figure><h2 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a><b>Delete</b></h2><p>é¦–å…ˆåœ¨ MySQL Master ä¸Šæ‰§è¡Œä¸€ä¸ªåˆ é™¤æ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; delete from t1 where a=1;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ ClickHouse Slave ä¾§æŸ¥çœ‹è®°å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">clickhouse :) select * from t1;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM t1</span><br><span class="line"></span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”</span><br><span class="line">â”‚ 2 â”‚ 2 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">1 rows in set. Elapsed: 0.032 sec.</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶çš„ metadata é‡Œ Data Version å·²ç»é€’å¢åˆ° 2:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat ckdatas/metadata/ckdb/.metadata </span><br><span class="line">Version:1</span><br><span class="line">Binlog File:mysql-bin.000001</span><br><span class="line">Binlog Position:1171</span><br><span class="line">Data Version:2</span><br></pre></td></tr></table></figure><h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a><b>Update</b></h2><p>MySQL Master:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t1;</span><br><span class="line">+---+------+</span><br><span class="line">| a | b    |</span><br><span class="line">+---+------+</span><br><span class="line">| 2 |    2 |</span><br><span class="line">+---+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update t1 set b=b+1;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t1;</span><br><span class="line">+---+------+</span><br><span class="line">| a | b    |</span><br><span class="line">+---+------+</span><br><span class="line">| 2 |    3 |</span><br><span class="line">+---+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ClickHouse Slave:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">clickhouse :) select * from t1;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM t1</span><br><span class="line"></span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”</span><br><span class="line">â”‚ 2 â”‚ 3 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">1 rows in set. Elapsed: 0.023 sec.</span><br></pre></td></tr></table></figure><h2 id="æ€§èƒ½æµ‹è¯•"><a href="#æ€§èƒ½æµ‹è¯•" class="headerlink" title="æ€§èƒ½æµ‹è¯•"></a><b>æ€§èƒ½æµ‹è¯•</b></h2><h3 id="æµ‹è¯•ç¯å¢ƒ"><a href="#æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a><b>æµ‹è¯•ç¯å¢ƒ</b></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MySQL          8C16G äº‘ä¸»æœº, 192.168.0.3ï¼ŒåŸºç¡€æ•°æ® 10188183 æ¡è®°å½•</span><br><span class="line">ClickHouse     8C16G äº‘ä¸»æœº, 192.168.0.4</span><br><span class="line">benchyou       8C8G  äº‘ä¸»æœº,  192.168.0.5, 256å¹¶å‘å†™, https://github.com/xelabs/benchyou</span><br></pre></td></tr></table></figure><p>æ€§èƒ½æµ‹è¯•è·Ÿç¡¬ä»¶ç¯å¢ƒæœ‰è¾ƒå¤§å…³ç³»ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯äº‘ä¸»æœºæ¨¡å¼ï¼Œæ•°æ®ä¾›å‚è€ƒã€‚</p><h3 id="å…¨é‡æ€§èƒ½"><a href="#å…¨é‡æ€§èƒ½" class="headerlink" title="å…¨é‡æ€§èƒ½"></a><b>å…¨é‡æ€§èƒ½</b></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">8c16G-vm :) create database sbtest engine=MaterializeMySQL(&#x27;192.168.0.3:3306&#x27;, &#x27;sbtest&#x27;, &#x27;test&#x27;, &#x27;123&#x27;);</span><br><span class="line"></span><br><span class="line">8c16G-vm :) watch lv1;</span><br><span class="line"></span><br><span class="line">WATCH lv1</span><br><span class="line"></span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚       0 â”‚ 2020-07-29 06:36:04 â”‚        1 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 1113585 â”‚ 2020-07-29 06:36:05 â”‚        2 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 2227170 â”‚ 2020-07-29 06:36:07 â”‚        3 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 3340755 â”‚ 2020-07-29 06:36:10 â”‚        4 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 4454340 â”‚ 2020-07-29 06:36:13 â”‚        5 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 5567925 â”‚ 2020-07-29 06:36:16 â”‚        6 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 6681510 â”‚ 2020-07-29 06:36:18 â”‚        7 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 7795095 â”‚ 2020-07-29 06:36:22 â”‚        8 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 8908680 â”‚ 2020-07-29 06:36:25 â”‚        9 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€â”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 10022265 â”‚ 2020-07-29 06:36:28 â”‚       10 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€â”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 10188183 â”‚ 2020-07-29 06:36:28 â”‚       11 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â† Progress: 11.00 rows, 220.00 B (0.16 rows/s., 3.17 B/s.) </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¡¬ä»¶ç¯å¢ƒä¸‹ï¼Œå…¨é‡åŒæ­¥æ€§èƒ½å¤§æ¦‚æ˜¯ <b>424507&#x2F;s</b>ï¼Œ<b>42w</b> äº‹åŠ¡æ¯ç§’ã€‚<br>å› ä¸ºå…¨é‡çš„æ•°æ®ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–æˆå¹¶è¡Œï¼ŒåŠ é€ŸåŒæ­¥ã€‚<br>å…¨é‡çš„æ€§èƒ½ç›´æ¥å†³å®š ClickHouse slave åæ‰åé‡å»ºçš„é€Ÿåº¦ï¼Œå¦‚æœä½ çš„ MySQL æœ‰<b> 10 äº¿</b>æ¡æ•°æ®ï¼Œå¤§æ¦‚<b> 40 åˆ†é’Ÿ</b>å°±å¯ä»¥é‡å»ºå®Œæˆã€‚</p><h3 id="å¢é‡æ€§èƒ½-å®æ—¶åŒæ­¥"><a href="#å¢é‡æ€§èƒ½-å®æ—¶åŒæ­¥" class="headerlink" title="å¢é‡æ€§èƒ½(å®æ—¶åŒæ­¥)"></a><b>å¢é‡æ€§èƒ½(å®æ—¶åŒæ­¥)</b></h3><p>åœ¨å½“å‰é…ç½®ä¸‹ï¼ŒClickHouse slave å•çº¿ç¨‹å›æ”¾æ¶ˆè´¹èƒ½åŠ›å¤§äº MySQL master 256 å¹¶å‘ä¸‹ç”Ÿäº§èƒ½åŠ›ï¼Œé€šè¿‡æµ‹è¯•å¯ä»¥çœ‹åˆ°å®ƒä»¬ä¿æŒ<b>å®æ—¶åŒæ­¥</b>ã€‚</p><p>benchyou å‹æµ‹æ•°æ®ï¼Œ<b>2.1w</b> äº‹åŠ¡&#x2F;ç§’(MySQL åœ¨å½“å‰ç¯å¢ƒä¸‹TPSä¸Šä¸å»):</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">./bin/benchyou --mysql-host=192.168.0.3 --mysql-user=test --mysql-password=123 --oltp-tables-count=1 --write-threads=256 --read-threads=0</span><br><span class="line"></span><br><span class="line">time            thds               tps     wtps    rtps</span><br><span class="line">[13s]        [r:0,w:256,u:0,d:0]  19962    19962   0    </span><br><span class="line"></span><br><span class="line">time            thds               tps     wtps    rtps</span><br><span class="line">[14s]        [r:0,w:256,u:0,d:0]  20415    20415   0 </span><br><span class="line"></span><br><span class="line">time            thds               tps     wtps    rtps</span><br><span class="line">[15s]        [r:0,w:256,u:0,d:0]  21131    21131   0</span><br><span class="line"></span><br><span class="line">time            thds               tps     wtps    rtps</span><br><span class="line">[16s]        [r:0,w:256,u:0,d:0]  21606    21606   0</span><br><span class="line"></span><br><span class="line">time            thds               tps     wtps    rtps</span><br><span class="line">[17s]        [r:0,w:256,u:0,d:0]  22505    22505   0  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ClickHouse ä¾§å•çº¿ç¨‹å›æ”¾èƒ½åŠ›ï¼Œ<b>2.1w</b> äº‹åŠ¡&#x2F;ç§’ï¼Œå®æ—¶åŒæ­¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚  150732 â”‚ 2020-07-30 05:17:15 â”‚       17 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚  155477 â”‚ 2020-07-30 05:17:16 â”‚       18 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚  160222 â”‚ 2020-07-30 05:17:16 â”‚       19 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚  164967 â”‚ 2020-07-30 05:17:16 â”‚       20 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚  169712 â”‚ 2020-07-30 05:17:16 â”‚       21 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚  174457 â”‚ 2020-07-30 05:17:16 â”‚       22 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚  179202 â”‚ 2020-07-30 05:17:17 â”‚       23 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚  183947 â”‚ 2020-07-30 05:17:17 â”‚       24 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚  188692 â”‚ 2020-07-30 05:17:17 â”‚       25 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚  193437 â”‚ 2020-07-30 05:17:17 â”‚       26 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€count()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚  198182 â”‚ 2020-07-30 05:17:17 â”‚       27 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h2 id="å®ç°æœºåˆ¶"><a href="#å®ç°æœºåˆ¶" class="headerlink" title="å®ç°æœºåˆ¶"></a><b>å®ç°æœºåˆ¶</b></h2><p>åœ¨æ¢è®¨æœºåˆ¶ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦äº†è§£ä¸‹ MySQL çš„ binlog event ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. MYSQL_QUERY_EVENTã€€ã€€ã€€ã€€-- DDL</span><br><span class="line">2. MYSQL_WRITE_ROWS_EVENTã€€-- insertæ•°æ®</span><br><span class="line">3. MYSQL_UPDATE_ROWS_EVENT -- updateæ•°æ®</span><br><span class="line">4. MYSQL_DELETE_ROWS_EVENT -- deleteæ•°æ®</span><br></pre></td></tr></table></figure><p>å½“ä¸€ä¸ªäº‹åŠ¡æäº¤åï¼ŒMySQL ä¼šæŠŠæ‰§è¡Œçš„ SQL å¤„ç†æˆç›¸åº”çš„ binlog eventï¼Œå¹¶æŒä¹…åŒ–åˆ° binlog æ–‡ä»¶ã€‚</p><p>binlog æ˜¯ MySQL å¯¹å¤–è¾“å‡ºçš„é‡è¦é€”å¾„ï¼Œåªè¦ä½ å®ç° MySQL Replication Protocolï¼Œå°±å¯ä»¥æµå¼çš„æ¶ˆè´¹MySQL ç”Ÿäº§çš„ binlog eventï¼Œå…·ä½“åè®®è§ <a href="https://dev.mysql.com/doc/internals/en/replication-protocol.html">Replication Protocol</a>ã€‚</p><p>ç”±äºå†å²åŸå› ï¼Œåè®®ç¹çè€Œè¯¡å¼‚ï¼Œè¿™ä¸æ˜¯æœ¬æ–‡é‡ç‚¹ã€‚</p><p>å¯¹äº ClickHouse æ¶ˆè´¹ MySQL binlog æ¥è¯´ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ï¼“ä¸ªéš¾ç‚¹ï¼š</p><ul><li>DDL å…¼å®¹</li><li>Delete&#x2F;Update æ”¯æŒ</li><li>Query è¿‡æ»¤</li></ul><h3 id="DDL"><a href="#DDL" class="headerlink" title="DDL"></a><b>DDL</b></h3><p>DDL å…¼å®¹èŠ±è´¹äº†å¤§é‡çš„ä»£ç å»å®ç°ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹çœ‹ MySQL çš„è¡¨å¤åˆ¶åˆ° ClickHouse åä¼šå˜æˆä»€ä¹ˆæ ·å­ã€‚</p><p>MySQL master:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table t1\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: t1</span><br><span class="line">Create Table: CREATE TABLE `t1` (</span><br><span class="line">  `a` int(11) NOT NULL,</span><br><span class="line">  `b` int(11) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`a`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1</span><br></pre></td></tr></table></figure><p> ClickHouse slave:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ATTACH TABLE t1</span><br><span class="line">(</span><br><span class="line">    `a` Int32,</span><br><span class="line">    `b` Nullable(Int32),</span><br><span class="line">    `_sign` Int8,</span><br><span class="line">    `_version` UInt64</span><br><span class="line">)</span><br><span class="line">ENGINE = ReplacingMergeTree(_version)</span><br><span class="line">PARTITION BY intDiv(a, 4294967)</span><br><span class="line">ORDER BY tuple(a)</span><br><span class="line">SETTINGS index_granularity = 8192</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼š</p><ul><li>é»˜è®¤å¢åŠ äº† 2 ä¸ªéšè—å­—æ®µï¼š_sign(-1åˆ é™¤, 1å†™å…¥) å’Œ _version(æ•°æ®ç‰ˆæœ¬) </li><li>å¼•æ“è½¬æ¢æˆäº† ReplacingMergeTreeï¼Œä»¥ _version ä½œä¸º column version</li><li>åŸä¸»é”®å­—æ®µ a ä½œä¸ºæ’åºå’Œåˆ†åŒºé”®</li></ul><p>è¿™åªæ˜¯ä¸€ä¸ªè¡¨çš„å¤åˆ¶ï¼Œå…¶ä»–è¿˜æœ‰éå¸¸å¤šçš„DDLå¤„ç†ï¼Œæ¯”å¦‚å¢åŠ åˆ—ã€ç´¢å¼•ç­‰ï¼Œæ„Ÿå…´è¶£å¯ä»¥è§‚æ‘© Parsers&#x2F;MySQL ä¸‹ä»£ç ã€‚</p><h3 id="ç´¢å¼•è½¬æ¢"><a href="#ç´¢å¼•è½¬æ¢" class="headerlink" title="ç´¢å¼•è½¬æ¢"></a><b>ç´¢å¼•è½¬æ¢</b></h3><p>MySQL å¯¹åº”çš„ä¸»é”®&#x2F;ç´¢å¼•å¦‚ä½•å¯¹åº”åˆ° MaterializeMySQL è¡¨ç»“æ„å‘¢ï¼Ÿ</p><p>é¦–å…ˆé’ˆå¯¹ MySQL å»ºè¡¨è¯­å¥è¿›è¡Œkeyæ‰«æï¼Œ<a href="https://github.com/ClickHouse/ClickHouse/blob/1076a42cf599c7eedd7d0cda2246f9afaf6434a4/src/Interpreters/MySQL/InterpretersMySQLDDLQuery.cpp#L157">InterpretersMySQLDDLQuery::getKeys</a>ï¼š</p><ol><li>æ‰«æ unique_key</li><li>æ‰«æ primary_key</li><li>æ‰«æ auto_increment</li></ol><p>å…¶æ¬¡æ ¹æ® key æŒ‰ç…§ä»¥ä¸‹é¡ºåºç”Ÿæˆ OrderBy tuple è¡¨è¾¾å¼ï¼Œ<a href="https://github.com/ClickHouse/ClickHouse/blob/1076a42cf599c7eedd7d0cda2246f9afaf6434a4/src/Interpreters/MySQL/InterpretersMySQLDDLQuery.cpp#L288">InterpretersMySQLDDLQuery::getOrderByPolicy</a>ï¼š</p><ol><li>primary_key[not increment]</li><li>key[not increment]</li><li>unique[not increment]</li><li>unique[increment]</li><li>key[increment]</li><li>primary_key[increment]</li></ol><p>ClickHouse çš„ç‰©ç†åºç›®å‰åªæœ‰ä¸€ç§(å¤šç‰©ç†åºæœ‰ä¸€å®šçš„è§„åˆ’)ï¼Œæ˜¯æœ‰ OrderBy å†³å®šï¼Œæ‰€ä»¥ MaterializeMySQL ç´¢å¼•å¦‚æœåˆ©ç”¨ä¸ä½³ï¼Œå¯ä»¥ä½¿ç”¨ç‰©åŒ–è§†å›¾å»ºç«‹æ–°çš„ç‰©ç†åºè§£å†³ã€‚</p><h3 id="Updateå’ŒDelete"><a href="#Updateå’ŒDelete" class="headerlink" title="Updateå’ŒDelete"></a><b>Updateå’ŒDelete</b></h3><p>å½“æˆ‘ä»¬åœ¨ MySQL master æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; delete from t1 where a=1;</span><br><span class="line">mysql&gt; update t1 set b=b+1;</span><br></pre></td></tr></table></figure><p>ClickHouse t1æ•°æ®ï¼ˆæŠŠ  _sign å’Œ _version ä¸€å¹¶æŸ¥è¯¢ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">clickhouse :) select a,b,_sign, _version from t1;</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    a,</span><br><span class="line">    b,</span><br><span class="line">    _sign,</span><br><span class="line">    _version</span><br><span class="line">FROM t1</span><br><span class="line"></span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”¬â”€_signâ”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 1 â”‚ 1 â”‚     1 â”‚        1 â”‚</span><br><span class="line">â”‚ 2 â”‚ 2 â”‚     1 â”‚        1 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”¬â”€_signâ”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 1 â”‚ 1 â”‚    -1 â”‚        2 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”¬â”€_signâ”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 2 â”‚ 3 â”‚     1 â”‚        3 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>æ ¹æ®è¿”å›ç»“æœï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ç”± 3 ä¸ª part ç»„æˆã€‚</p><p>part1 ç”± <code>mysql&gt; insert into t1 values(1,1),(2,2)</code> ç”Ÿæˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”¬â”€_signâ”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 1 â”‚ 1 â”‚     1 â”‚        1 â”‚</span><br><span class="line">â”‚ 2 â”‚ 2 â”‚     1 â”‚        1 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>part2 ç”± <code>mysql&gt; delete from t1 where a=1</code> ç”Ÿæˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”¬â”€_signâ”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 1 â”‚ 1 â”‚    -1 â”‚        2 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">è¯´æ˜ï¼š</span><br><span class="line">_sign = -1è¡¨æ˜å¤„äºåˆ é™¤çŠ¶æ€</span><br></pre></td></tr></table></figure><p>part3 ç”± <code> update t1 set b=b+1</code> ç”Ÿæˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”¬â”€_signâ”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 2 â”‚ 3 â”‚     1 â”‚        3 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ final æŸ¥è¯¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">clickhouse :) select a,b,_sign,_version from t1 final;</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    a,</span><br><span class="line">    b,</span><br><span class="line">    _sign,</span><br><span class="line">    _version</span><br><span class="line">FROM t1</span><br><span class="line">FINAL</span><br><span class="line"></span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”¬â”€_signâ”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 1 â”‚ 1 â”‚    -1 â”‚        2 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”¬â”€_signâ”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 2 â”‚ 3 â”‚     1 â”‚        3 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">2 rows in set. Elapsed: 0.016 sec. </span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° ReplacingMergeTree å·²ç»æ ¹æ® _version å’Œ OrderBy å¯¹è®°å½•è¿›è¡Œå»é‡ã€‚</p><h3 id="Query"><a href="#Query" class="headerlink" title="Query"></a><b>Query</b></h3><p>MySQL master:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t1;</span><br><span class="line">+---+------+</span><br><span class="line">| a | b    |</span><br><span class="line">+---+------+</span><br><span class="line">| 2 |    3 |</span><br><span class="line">+---+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ClickHouse slave:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">clickhouse :) select * from t1;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM t1</span><br><span class="line"></span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”</span><br><span class="line">â”‚ 2 â”‚ 3 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">clickhouse :) select *,_sign,_version from t1;</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    *,</span><br><span class="line">    _sign,</span><br><span class="line">    _version</span><br><span class="line">FROM t1</span><br><span class="line"></span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”¬â”€_signâ”€â”¬â”€_versionâ”€â”</span><br><span class="line">â”‚ 1 â”‚ 1 â”‚    -1 â”‚        2 â”‚</span><br><span class="line">â”‚ 2 â”‚ 3 â”‚     1 â”‚        3 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">è¯´æ˜ï¼šè¿™é‡Œè¿˜æœ‰ä¸€æ¡åˆ é™¤è®°å½•ï¼Œ_signä¸º-1</span><br></pre></td></tr></table></figure><p>MaterializeMySQL è¢«å®šä¹‰æˆä¸€ç§å­˜å‚¨å¼•æ“ï¼Œæ‰€ä»¥åœ¨è¯»å–çš„æ—¶å€™ï¼Œä¼šæ ¹æ® _sign çŠ¶æ€è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯-1åˆ™æ˜¯å·²ç»åˆ é™¤ï¼Œè¿›è¡Œè¿‡æ»¤ã€‚</p><h2 id="å¹¶è¡Œå›æ”¾"><a href="#å¹¶è¡Œå›æ”¾" class="headerlink" title="å¹¶è¡Œå›æ”¾"></a><b>å¹¶è¡Œå›æ”¾</b></h2><p>ä¸ºä»€ä¹ˆ MySQL éœ€è¦å¹¶è¡Œå›æ”¾ï¼Ÿ</p><p>å‡è®¾ MySQL master æœ‰ 1024 ä¸ªå¹¶å‘åŒæ—¶å†™å…¥ã€æ›´æ–°æ•°æ®ï¼Œç¬é—´äº§ç”Ÿå¤§é‡çš„ binlog event ï¼ŒMySQL slave ä¸Šåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ª event æ¥ç€ä¸€ä¸ª event å¼å›æ”¾ï¼Œäºæ˜¯ MySQL å®ç°äº†å¹¶è¡Œå›æ”¾åŠŸèƒ½ï¼</p><p>é‚£ä¹ˆï¼ŒMySQL slave å›æ”¾æ—¶èƒ½å¦å®Œå…¨(æˆ–æ¥è¿‘)æ¨¡æ‹Ÿå‡º master å½“æ—¶çš„ 1024 å¹¶å‘è¡Œä¸ºå‘¢ï¼Ÿ</p><p>è¦æƒ³å¹¶è¡Œé¦–å…ˆè¦è§£å†³çš„å°±æ˜¯ä¾èµ–é—®é¢˜ï¼šæˆ‘ä»¬éœ€è¦ master æ ‡è®°å‡ºå“ªäº› event å¯ä»¥å¹¶è¡Œï¼Œå“ªäº› event æœ‰å…ˆåå…³ç³»ï¼Œå› ä¸ºå®ƒæ˜¯ç¬¬ä¸€ç°åœºã€‚</p><p>MySQL é€šè¿‡åœ¨ binlog é‡Œå¢åŠ :</p><ul><li>last_committedï¼Œç›¸åŒåˆ™å¯ä»¥å¹¶è¡Œ</li><li>sequece_numberï¼Œè¾ƒå°å…ˆæ‰§è¡Œï¼Œæè¿°å…ˆåä¾èµ–</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">last_committed=3   sequece_number=4   -- event1</span><br><span class="line">last_committed=4   sequece_number=5   -- event2</span><br><span class="line">last_committed=4   sequece_number=6   -- event3</span><br><span class="line">last_committed=5   sequece_number=7   -- event4</span><br></pre></td></tr></table></figure><p>event2 å’Œ event3 åˆ™å¯ä»¥å¹¶è¡Œï¼Œevent4 éœ€è¦ç­‰å¾…å‰é¢ event å®Œæˆæ‰å¯ä»¥å›æ”¾ã€‚<br>ä»¥ä¸Šåªæ˜¯ä¸€ä¸ªå¤§ä½“åŸç†ï¼Œç›®å‰ MySQL æœ‰ï¼“ç§å¹¶è¡Œæ¨¡å¼å¯ä»¥é€‰æ‹©ï¼š</p><ol><li>åŸºäº database å¹¶è¡Œ</li><li>åŸºäº group commit å¹¶è¡Œ</li><li>åŸºäºä¸»é”®ä¸å†²çªçš„ write set å¹¶è¡Œ</li></ol><p>æœ€å¤§ç¨‹åº¦ä¸Šè®© MySQL slaveåŠ é€Ÿå›æ”¾ï¼Œæ•´å¥—æœºåˆ¶è¿˜æ˜¯å¼‚å¸¸å¤æ‚çš„ã€‚</p><p>å›åˆ° ClickHouse slave é—®é¢˜ï¼Œæˆ‘ä»¬é‡‡ç”¨çš„å•çº¿ç¨‹å›æ”¾ï¼Œå»¶è¿Ÿå·²ç»ä¸æ˜¯ä¸»è¦é—®é¢˜ï¼Œè¿™æ˜¯ç”±å®ƒä»¬çš„æœºåˆ¶å†³å®šçš„ï¼š<br>MySQL slave å›æ”¾æ—¶ï¼Œéœ€è¦æŠŠ binlog event è½¬æ¢æˆ  SQLï¼Œç„¶åæ¨¡æ‹Ÿ master çš„å†™å…¥ï¼Œè¿™ç§é€»è¾‘å¤åˆ¶æ˜¯å¯¼è‡´æ€§èƒ½ä½ä¸‹çš„æœ€é‡è¦åŸå› ã€‚<br>è€Œ ClickHouse åœ¨å›æ”¾ä¸Šï¼Œç›´æ¥æŠŠ binlog event è½¬æ¢æˆ åº•å±‚ block ç»“æ„ï¼Œç„¶åç›´æ¥å†™å…¥åº•å±‚çš„å­˜å‚¨å¼•æ“ï¼Œæ¥è¿‘äºç‰©ç†å¤åˆ¶ï¼Œå¯ä»¥ç†è§£ä¸ºæŠŠ binlog event ç›´æ¥å›æ”¾åˆ° InnoDB çš„ pageã€‚</p><h2 id="è¯»å–æœ€æ–°"><a href="#è¯»å–æœ€æ–°" class="headerlink" title="è¯»å–æœ€æ–°"></a><b>è¯»å–æœ€æ–°</b></h2><p>è™½ç„¶ ClickHouse slave å›æ”¾éå¸¸å¿«ï¼Œæ¥è¿‘äºå®æ—¶ï¼Œå¦‚ä½•åœ¨ClickHouse slaveä¸Šæ€»æ˜¯è¯»å–åˆ°æœ€æ–°çš„æ•°æ®å‘¢ï¼Ÿ</p><p>å…¶å®éå¸¸ç®€å•ï¼Œå€ŸåŠ© MySQL binlog GTID ç‰¹æ€§ï¼Œæ¯æ¬¡è¯»çš„æ—¶å€™ï¼Œæˆ‘ä»¬è·Ÿ ï½aster åšä¸€æ¬¡ executed_gtid åŒæ­¥ï¼Œç„¶åç­‰å¾…è¿™äº› executed_gtid å›æ”¾å®Œæ¯•å³å¯ã€‚</p><h2 id="æ•°æ®ä¸€è‡´æ€§"><a href="#æ•°æ®ä¸€è‡´æ€§" class="headerlink" title="æ•°æ®ä¸€è‡´æ€§"></a><b>æ•°æ®ä¸€è‡´æ€§</b></h2><p>å¯¹ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œæˆ‘ä»¬æ€ä¹ˆéªŒè¯ MySQL master çš„æ•°æ®å’Œ ClickHouse slave çš„æ•°æ®ä¸€è‡´æ€§å‘¢ï¼Ÿ</p><p>è¿™å—åˆæ­¥æƒ³æ³•æ˜¯æä¾›ä¸€ä¸ªå…¼å®¹ MySQL checksum ç®—æ³•çš„å‡½æ•°ï¼Œæˆ‘ä»¬åªéœ€å¯¹æ¯”ä¸¤è¾¹çš„ checksum å€¼å³å¯ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><b>æ€»ç»“</b></h2><p>ClickHouse å®æ—¶å¤åˆ¶åŒæ­¥ MySQL æ•°æ®æ˜¯ upstream 2020 çš„ä¸€ä¸ª roadmapï¼Œåœ¨æ•´ä½“æ„æ¶ä¸Šæ¯”è¾ƒæœ‰æŒ‘æˆ˜ä¸€ç›´æ— äººæ¥å•ï¼ŒæŒ‘æˆ˜ä¸»è¦æ¥è‡ªä¸¤æ–¹é¢ï¼š</p><ul><li>å¯¹ MySQL å¤åˆ¶é€šé“ä¸åè®®éå¸¸ç†Ÿæ‚‰</li><li>å¯¹ ClickHouse æ•´ä½“æœºåˆ¶éå¸¸ç†Ÿæ‚‰</li></ul><p>è¿™æ ·ï¼Œåœ¨ä¸¤ä¸ªæœ¬æ¥æœ‰ç‚¹é¥è¿œçš„å±±å¤´ä¸­é—´æ¶èµ·äº†ä¸€åº§é«˜é€Ÿï¼Œè¿™æ¡ <a href="https://github.com/ClickHouse/ClickHouse/pull/10851">10851å·</a> é«˜é€Ÿç”± zhang1024(ClickHouseä¾§) å’Œ BohuTANG(MySQLå¤åˆ¶) ä¸¤ä¸ªä¿®è·¯å·¥è”åˆæ‰¿å»ºï¼Œç›®å‰å·²ç»åˆå¹¶åˆ° upstream åˆ†æ”¯ã€‚</p><p>å…³äºåŒæ­¥ MySQL çš„æ•°æ®ï¼Œç›®å‰å¤§å®¶çš„æ–¹æ¡ˆåŸºæœ¬éƒ½æ˜¯åœ¨ä¸­é—´å®‰ç½®ä¸€ä¸ª binlog æ¶ˆè´¹å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·å¯¹ event è¿›è¡Œè§£æï¼Œç„¶åå†è½¬æ¢æˆ ClickHouse çš„ SQL è¯­å¥ï¼Œå†™åˆ° ClickHouse serverï¼Œé“¾è·¯è¾ƒé•¿ï¼Œæ€§èƒ½æŸè€—è¾ƒå¤§ã€‚</p><p> <a href="https://github.com/ClickHouse/ClickHouse/pull/10851">10851å·</a> é«˜é€Ÿæ˜¯åœ¨ ClickHouse å†…éƒ¨å®ç°ä¸€å¥— binlog æ¶ˆè´¹æ–¹æ¡ˆï¼Œç„¶åæ ¹æ® event è§£ææˆ ClickHouse å†…éƒ¨çš„ block ç»“æ„ï¼Œå†ç›´æ¥å›å†™åˆ°åº•å±‚å­˜å‚¨å¼•æ“ï¼Œå‡ ä¹æ˜¯æœ€é«˜æ•ˆçš„ä¸€ç§å®ç°æ–¹å¼ï¼Œå®ç°ä¸ MySQL å®æ—¶åŒæ­¥çš„èƒ½åŠ›ï¼Œè®©åˆ†ææ›´æ¥è¿‘ç°å®ã€‚</p><p>åŸºäº database çº§çš„å¤åˆ¶ï¼Œå®ç°äº†å¤šæºå¤åˆ¶çš„åŠŸèƒ½ï¼Œå¦‚æœå¤åˆ¶é€šé“åæ‰ï¼Œæˆ‘ä»¬åªéœ€åœ¨ ClickHouse ä¾§åˆ æ‰ database å†é‡å»ºä¸€æ¬¡å³å¯ï¼Œéå¸¸å¿«é€Ÿã€æ–¹ä¾¿ï¼ŒOLTP+OLAP å°±æ˜¯è¿™ä¹ˆç®€å•ï¼</p><p>è¦æƒ³å¯Œï¼Œå…ˆä¿®è·¯ï¼</p><p><a href="/3030/12/12/clickhouse-and-friends-mysql-replication-materializemysql/">ã€ç½®é¡¶ã€‘ClickHouse MaterializeMySQLå®æ—¶åŒæ­¥MySQLæ±‡æ€»</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;img src=&quot;https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/clickhouse-map-2020-materialzemysql.png&quot; align=&quot;center&quot; style=&quot;zoom:</summary>
      
    
    
    
    
    <category term="clickhouse" scheme="https://bohutang.me/tags/clickhouse/"/>
    
    <category term="ClickHouseå’Œä»–çš„æœ‹å‹ä»¬" scheme="https://bohutang.me/tags/ClickHouse%E5%92%8C%E4%BB%96%E7%9A%84%E6%9C%8B%E5%8F%8B%E4%BB%AC/"/>
    
    <category term="MySQL" scheme="https://bohutang.me/tags/MySQL/"/>
    
    <category term="replication" scheme="https://bohutang.me/tags/replication/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆï¼˜ï¼‰çº¯æ‰‹å·¥æ‰“é€ çš„SQLè§£æå™¨</title>
    <link href="https://bohutang.me/2020/07/25/clickhouse-and-friends-parser/"/>
    <id>https://bohutang.me/2020/07/25/clickhouse-and-friends-parser/</id>
    <published>2020-07-24T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.052Z</updated>
    
    <content type="html"><![CDATA[<p>ç°å®ç”Ÿæ´»ä¸­çš„ç‰©å“ä¸€æ—¦è¢«æ ‡è®°ä¸ºâ€œçº¯æ‰‹å·¥æ‰“é€ â€ï¼Œç»™äººçš„ç¬¬ä¸€æ„Ÿè§‰å°±æ˜¯â€œä¸Šä¹˜ä¹‹å“â€ï¼Œä¸€ä¸ªå­—â€œè´µâ€ï¼Œæ¯”å¦‚åŒ—äº¬è€å¸ƒé‹ã€‚</p><p>ä½†æ˜¯åœ¨è®¡ç®—æœºä¸–ç•Œé‡Œï¼Œå¦‚æœæœ‰äººå‘Šè¯‰ä½  ClickHouse çš„ SQL è§£æå™¨æ˜¯çº¯æ‰‹å·¥æ‰“é€ çš„ï¼Œæ˜¯ä¸æ˜¯å¾ˆæƒŠè®¶ï¼<br>è¿™ä¸ªé—®é¢˜å¼•èµ·äº†ä¸å°‘ç½‘å‹çš„å…³æ³¨ï¼Œæ‰€ä»¥æœ¬ç¯‡èŠèŠ ClickHouse çš„çº¯æ‰‹å·¥è§£æå™¨ï¼Œçœ‹çœ‹å®ƒä»¬çš„åº•å±‚å·¥ä½œæœºåˆ¶åŠä¼˜ç¼ºç‚¹ã€‚</p><p>æ¯ç‡¥å…ˆä»ä¸€ä¸ª SQL å¼€å§‹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT a,b FROM t1</span><br></pre></td></tr></table></figure><h2 id="token"><a href="#token" class="headerlink" title="tokenÂ "></a><b>tokenÂ </b></h2><p>é¦–å…ˆå¯¹ SQL é‡Œçš„å­—ç¬¦é€ä¸ªåšåˆ¤æ–­ï¼Œç„¶åæ ¹æ®å…¶å…³è”æ€§åš token åˆ†å‰²ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/parser.png" align="center" style="zoom:40%;" /><p>æ¯”å¦‚è¿ç»­çš„ WordCharï¼Œé‚£å®ƒå°±æ˜¯ BareWordï¼Œè§£æå‡½æ•°åœ¨ <a href="https://github.com/ClickHouse/ClickHouse/blob/558f9c76306ffc4e6add8fd34c2071b64e914103/src/Parsers/Lexer.cpp#L61">Lexer::nextTokenImpl()</a>ï¼Œè§£æè°ƒç”¨æ ˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DB::Lexer::nextTokenImpl() Lexer.cpp:63</span><br><span class="line">DB::Lexer::nextToken() Lexer.cpp:52</span><br><span class="line">DB::Tokens::operator[](unsigned long) TokenIterator.h:36</span><br><span class="line">DB::TokenIterator::get() TokenIterator.h:62</span><br><span class="line">DB::TokenIterator::operator-&gt;() TokenIterator.h:64</span><br><span class="line">DB::tryParseQuery(DB::IParser&amp;, char const*&amp;, char const*, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;&amp;, bool, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, bool, unsigned long, unsigned long) parseQuery.cpp:224</span><br><span class="line">DB::parseQueryAndMovePosition(DB::IParser&amp;, char const*&amp;, char const*, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, bool, unsigned long, unsigned long) parseQuery.cpp:314</span><br><span class="line">DB::parseQuery(DB::IParser&amp;, char const*, char const*, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, unsigned long, unsigned long) parseQuery.cpp:332</span><br><span class="line">DB::executeQueryImpl(const char *, const char *, DB::Context &amp;, bool, DB::QueryProcessingStage::Enum, bool, DB::ReadBuffer *) executeQuery.cpp:272</span><br><span class="line">DB::executeQuery(DB::ReadBuffer&amp;, DB::WriteBuffer&amp;, bool, DB::Context&amp;, std::__1::function&lt;void (std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;)&gt;) executeQuery.cpp:731</span><br><span class="line">DB::MySQLHandler::comQuery(DB::ReadBuffer&amp;) MySQLHandler.cpp:313</span><br><span class="line">DB::MySQLHandler::run() MySQLHandler.cpp:150 </span><br></pre></td></tr></table></figure><h2 id="ast"><a href="#ast" class="headerlink" title="ast"></a><b>ast</b></h2><p> token æ˜¯æœ€åŸºç¡€çš„å…ƒç»„ï¼Œä»–ä»¬ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³è”ï¼Œåªæ˜¯ä¸€å †ç”Ÿå†·çš„è¯ç»„ä¸ç¬¦å·ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€å¯¹å…¶è¿›è¡Œ<b>è¯­æ³•è§£æ</b>ï¼Œè®©è¿™äº› token ä¹‹é—´å»ºç«‹ä¸€å®šçš„å…³ç³»ï¼Œè¾¾åˆ°ä¸€ä¸ªå¯æè¿°çš„æ´»åŠ›ã€‚</p><p>ClickHouse åœ¨è§£æ¯ä¸€ä¸ª token çš„æ—¶å€™ï¼Œä¼šæ ¹æ®å½“å‰çš„ token è¿›è¡ŒçŠ¶æ€ç©ºé—´è¿›è¡Œé¢„åˆ¤(parse è¿”å› true åˆ™è¿›å…¥å­çŠ¶æ€ç©ºé—´ç»§ç»­)ï¼Œç„¶åå†³å®šçŠ¶æ€è·³è½¬ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN  -- TokenType::BareWord</span><br></pre></td></tr></table></figure><p>é€»è¾‘é¦–å…ˆä¼šè¿›å…¥Parsers&#x2F;ParserQuery.cpp çš„ <a href="https://github.com/ClickHouse/ClickHouse/blob/558f9c76306ffc4e6add8fd34c2071b64e914103/src/Parsers/ParserQuery.cpp#L26">ParserQuery::parseImpl</a> æ–¹æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bool res = query_with_output_p.parse(pos, node, expected)</span><br><span class="line">    || insert_p.parse(pos, node, expected)</span><br><span class="line">    || use_p.parse(pos, node, expected)</span><br><span class="line">    || set_role_p.parse(pos, node, expected)</span><br><span class="line">    || set_p.parse(pos, node, expected)</span><br><span class="line">    || system_p.parse(pos, node, expected)</span><br><span class="line">    || create_user_p.parse(pos, node, expected)</span><br><span class="line">    || create_role_p.parse(pos, node, expected)</span><br><span class="line">    || create_quota_p.parse(pos, node, expected)</span><br><span class="line">    || create_row_policy_p.parse(pos, node, expected)</span><br><span class="line">    || create_settings_profile_p.parse(pos, node, expected)</span><br><span class="line">    || drop_access_entity_p.parse(pos, node, expected)</span><br><span class="line">    || grant_p.parse(pos, node, expected);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šå¯¹æ‰€æœ‰ query ç±»å‹è¿›è¡Œ parse æ–¹æ³•çš„è°ƒç”¨ï¼Œç›´åˆ°æœ‰åˆ†æ”¯è¿”å› trueã€‚</p><p>æˆ‘ä»¬æ¥çœ‹<b>ç¬¬ä¸€å±‚</b> query_with_output_p.parse <a href="https://github.com/ClickHouse/ClickHouse/blob/558f9c76306ffc4e6add8fd34c2071b64e914103/src/Parsers/ParserQueryWithOutput.cpp#L31">Parsers&#x2F;ParserQueryWithOutput.cpp</a>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bool parsed =</span><br><span class="line">       explain_p.parse(pos, query, expected)</span><br><span class="line">    || select_p.parse(pos, query, expected)</span><br><span class="line">    || show_create_access_entity_p.parse(pos, query, expected)</span><br><span class="line">    || show_tables_p.parse(pos, query, expected)</span><br><span class="line">    || table_p.parse(pos, query, expected)</span><br><span class="line">    || describe_table_p.parse(pos, query, expected)</span><br><span class="line">    || show_processlist_p.parse(pos, query, expected)</span><br><span class="line">    || create_p.parse(pos, query, expected)</span><br><span class="line">    || alter_p.parse(pos, query, expected)</span><br><span class="line">    || rename_p.parse(pos, query, expected)</span><br><span class="line">    || drop_p.parse(pos, query, expected)</span><br><span class="line">    || check_p.parse(pos, query, expected)</span><br><span class="line">    || kill_query_p.parse(pos, query, expected)</span><br><span class="line">    || optimize_p.parse(pos, query, expected)</span><br><span class="line">    || watch_p.parse(pos, query, expected)</span><br><span class="line">    || show_access_p.parse(pos, query, expected)</span><br><span class="line">    || show_access_entities_p.parse(pos, query, expected)</span><br><span class="line">    || show_grants_p.parse(pos, query, expected)</span><br><span class="line">    || show_privileges_p.parse(pos, query, expected</span><br></pre></td></tr></table></figure><p>è·³è¿›<b>ç¬¬äºŒå±‚</b> explain_p.parse <a href="https://github.com/ClickHouse/ClickHouse/blob/558f9c76306ffc4e6add8fd34c2071b64e914103/src/Parsers/ParserExplainQuery.cpp#L10">ParserExplainQuery::parseImpl</a>çŠ¶æ€ç©ºé—´ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">bool ParserExplainQuery::parseImpl(Pos &amp; pos, ASTPtr &amp; node, Expected &amp; expected)</span><br><span class="line">&#123;</span><br><span class="line">    ASTExplainQuery::ExplainKind kind;</span><br><span class="line">    bool old_syntax = false;</span><br><span class="line"></span><br><span class="line">    ParserKeyword s_ast(&quot;AST&quot;);</span><br><span class="line">    ParserKeyword s_analyze(&quot;ANALYZE&quot;);</span><br><span class="line">    ParserKeyword s_explain(&quot;EXPLAIN&quot;);</span><br><span class="line">    ParserKeyword s_syntax(&quot;SYNTAX&quot;);</span><br><span class="line">    ParserKeyword s_pipeline(&quot;PIPELINE&quot;);</span><br><span class="line">    ParserKeyword s_plan(&quot;PLAN&quot;);</span><br><span class="line"></span><br><span class="line">    ... ...</span><br><span class="line">    else if (s_explain.ignore(pos, expected))</span><br><span class="line">    &#123;</span><br><span class="line">       ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ...</span><br><span class="line">    </span><br><span class="line">    ParserSelectWithUnionQuery select_p;</span><br><span class="line">    ASTPtr query;</span><br><span class="line">    if (!select_p.parse(pos, query, expected))</span><br><span class="line">        return false;</span><br><span class="line">    ... ...</span><br></pre></td></tr></table></figure><p>s_explain.ignore æ–¹æ³•ä¼šè¿›è¡Œä¸€ä¸ª keyword è§£æï¼Œè§£æå‡º ast node:</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN -- keyword</span><br></pre></td></tr></table></figure><p>è·ƒè¿›<b>ç¬¬ä¸‰å±‚</b> select_p.parse <a href="https://github.com/ClickHouse/ClickHouse/blob/558f9c76306ffc4e6add8fd34c2071b64e914103/src/Parsers/ParserSelectWithUnionQuery.cpp#L26">ParserSelectWithUnionQuery::parseImpl</a>çŠ¶æ€ç©ºé—´ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bool ParserSelectWithUnionQuery::parseImpl(Pos &amp; pos, ASTPtr &amp; node, Expected &amp; expected)</span><br><span class="line">&#123;</span><br><span class="line">    ASTPtr list_node;</span><br><span class="line"></span><br><span class="line">    ParserList parser(std::make_unique&lt;ParserUnionQueryElement&gt;(), std::make_unique&lt;ParserKeyword&gt;(&quot;UNION ALL&quot;), false);</span><br><span class="line">    if (!parser.parse(pos, list_node, expected))</span><br><span class="line">        return false;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>parser.parse é‡Œåˆè°ƒç”¨<b>ç¬¬å››å±‚</b> <a href="https://github.com/ClickHouse/ClickHouse/blob/558f9c76306ffc4e6add8fd34c2071b64e914103/src/Parsers/ParserSelectQuery.cpp#L24">ParserSelectQuery::parseImpl</a> çŠ¶æ€ç©ºé—´ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">bool ParserSelectQuery::parseImpl(Pos &amp; pos, ASTPtr &amp; node, Expected &amp; expected)</span><br><span class="line">&#123;</span><br><span class="line">    auto select_query = std::make_shared&lt;ASTSelectQuery&gt;();</span><br><span class="line">    node = select_query;</span><br><span class="line"></span><br><span class="line">    ParserKeyword s_select(&quot;SELECT&quot;);</span><br><span class="line">    ParserKeyword s_distinct(&quot;DISTINCT&quot;);</span><br><span class="line">    ParserKeyword s_from(&quot;FROM&quot;);</span><br><span class="line">    ParserKeyword s_prewhere(&quot;PREWHERE&quot;);</span><br><span class="line">    ParserKeyword s_where(&quot;WHERE&quot;);</span><br><span class="line">    ParserKeyword s_group_by(&quot;GROUP BY&quot;);</span><br><span class="line">    ParserKeyword s_with(&quot;WITH&quot;);</span><br><span class="line">    ParserKeyword s_totals(&quot;TOTALS&quot;);</span><br><span class="line">    ParserKeyword s_having(&quot;HAVING&quot;);</span><br><span class="line">    ParserKeyword s_order_by(&quot;ORDER BY&quot;);</span><br><span class="line">    ParserKeyword s_limit(&quot;LIMIT&quot;);</span><br><span class="line">    ParserKeyword s_settings(&quot;SETTINGS&quot;);</span><br><span class="line">    ParserKeyword s_by(&quot;BY&quot;);</span><br><span class="line">    ParserKeyword s_rollup(&quot;ROLLUP&quot;);</span><br><span class="line">    ParserKeyword s_cube(&quot;CUBE&quot;);</span><br><span class="line">    ParserKeyword s_top(&quot;TOP&quot;);</span><br><span class="line">    ParserKeyword s_with_ties(&quot;WITH TIES&quot;);</span><br><span class="line">    ParserKeyword s_offset(&quot;OFFSET&quot;);</span><br><span class="line"></span><br><span class="line">    ParserNotEmptyExpressionList exp_list(false);</span><br><span class="line">    ParserNotEmptyExpressionList exp_list_for_with_clause(false);</span><br><span class="line">    ParserNotEmptyExpressionList exp_list_for_select_clause(true);  </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">            if (!exp_list_for_select_clause.parse(pos, select_expression_list, expected))</span><br><span class="line">            return false;</span><br></pre></td></tr></table></figure><p><b>ç¬¬äº”å±‚</b> exp_list_for_select_clause.parse <a href="https://github.com/ClickHouse/ClickHouse/blob/558f9c76306ffc4e6add8fd34c2071b64e914103/src/Parsers/ExpressionListParsers.cpp#L520">ParserExpressionList::parseImpl</a>çŠ¶æ€ç©ºé—´ç»§ç»­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bool ParserExpressionList::parseImpl(Pos &amp; pos, ASTPtr &amp; node, Expected &amp; expected)</span><br><span class="line">&#123;</span><br><span class="line">    return ParserList(</span><br><span class="line">        std::make_unique&lt;ParserExpressionWithOptionalAlias&gt;(allow_alias_without_as_keyword),</span><br><span class="line">        std::make_unique&lt;ParserToken&gt;(TokenType::Comma))</span><br><span class="line">        .parse(pos, node, expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€¦ â€¦ å†™ä¸ä¸‹å»ä¸ªé¸Ÿï¼</p><p>å¯ä»¥å‘ç°ï¼Œast parser çš„æ—¶å€™ï¼Œé¢„å…ˆæ„é€ å¥½çŠ¶æ€ç©ºé—´ï¼Œæ¯”å¦‚ select çš„çŠ¶æ€ç©ºé—´:</p><ol><li>expression list</li><li>from tables</li><li>where</li><li>group by</li><li>with â€¦</li><li>order by</li><li>limit</li></ol><p>åœ¨ä¸€ä¸ªçŠ¶æ€ç©ºé—´å…§ï¼Œè¿˜å¯ä»¥æ ¹æ® parse è¿”å›çš„ bool åˆ¤æ–­æ˜¯å¦ç»§ç»­è¿›å…¥å­çŠ¶æ€ç©ºé—´ï¼Œä¸€ç›´é€’å½’è§£æå‡ºæ•´ä¸ª astã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><b>æ€»ç»“</b></h2><p>æ‰‹å·¥ parser çš„å¥½å¤„æ˜¯ä»£ç æ¸…æ™°ç®€æ´ï¼Œæ¯ä¸ªç»†èŠ‚å¯é˜²å¯æ§ï¼Œä»¥åŠå‹å¥½çš„é”™è¯¯å¤„ç†ï¼Œæ”¹åŠ¨èµ·æ¥ä¸ä¼šä¸€å‘åŠ¨å…¨èº«ã€‚<br>ç¼ºç‚¹æ˜¯æ‰‹å·¥æˆæœ¬å¤ªé«˜ï¼Œéœ€è¦å¤§é‡çš„æµ‹è¯•æ¥ä¿è¯å…¶æ­£ç¡®æ€§ï¼Œè¿˜éœ€è¦ä¸€äº›fuzzæ¥ä¿è¯å¯é æ€§ã€‚<br>å¥½åœ¨ClickHouse å·²ç»å®ç°çš„æ¯”è¾ƒå…¨é¢ï¼Œå³ä½¿æœ‰æ–°çš„éœ€æ±‚ï¼Œåœ¨ç°æœ‰åŸºç¡€ä¸Šä¿®ä¿®è¡¥è¡¥å³å¯ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ç°å®ç”Ÿæ´»ä¸­çš„ç‰©å“ä¸€æ—¦è¢«æ ‡è®°ä¸ºâ€œçº¯æ‰‹å·¥æ‰“é€ â€ï¼Œç»™äººçš„ç¬¬ä¸€æ„Ÿè§‰å°±æ˜¯â€œä¸Šä¹˜ä¹‹å“â€ï¼Œä¸€ä¸ªå­—â€œè´µâ€ï¼Œæ¯”å¦‚åŒ—äº¬è€å¸ƒé‹ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯åœ¨è®¡ç®—æœºä¸–ç•Œé‡Œï¼Œå¦‚æœæœ‰äººå‘Šè¯‰ä½  ClickHouse çš„ SQL è§£æå™¨æ˜¯çº¯æ‰‹å·¥æ‰“é€ çš„ï¼Œæ˜¯ä¸æ˜¯å¾ˆæƒŠè®¶ï¼&lt;br&gt;è¿™ä¸ªé—®é¢˜å¼•èµ·äº†ä¸å°‘ç½‘å‹çš„å…³æ³¨ï¼Œæ‰€ä»¥æœ¬ç¯‡</summary>
      
    
    
    
    
    <category term="clickhouse" scheme="https://bohutang.me/tags/clickhouse/"/>
    
    <category term="ClickHouseå’Œä»–çš„æœ‹å‹ä»¬" scheme="https://bohutang.me/tags/ClickHouse%E5%92%8C%E4%BB%96%E7%9A%84%E6%9C%8B%E5%8F%8B%E4%BB%AC/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆ6ï¼‰MergeTreeå­˜å‚¨ç»“æ„</title>
    <link href="https://bohutang.me/2020/06/26/clickhouse-and-friends-merge-tree-disk-layout/"/>
    <id>https://bohutang.me/2020/06/26/clickhouse-and-friends-merge-tree-disk-layout/</id>
    <published>2020-06-25T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.051Z</updated>
    
    <content type="html"><![CDATA[<p><b>æœ€åæ›´æ–°: 2020-09-28</b></p><p>ä¸Šç¯‡çš„ <a href="/2020/06/20/clickhouse-and-friends-merge-tree-algo/">å­˜å‚¨å¼•æ“æŠ€æœ¯è¿›åŒ–ä¸MergeTree</a> ä»‹ç»äº†å­˜å‚¨ç®—æ³•çš„æ¼”è¿›ã€‚</p><p>å­˜å‚¨å¼•æ“æ˜¯ä¸€ä¸ªæ•°æ®åº“çš„åº•ç›˜ï¼Œä¸€å®šè¦ç¨³å’ŒåŠ¨åŠ›æ¾æ¹ƒã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¸€èµ·æ¥æ¢ç´¢ä¸‹ ClickHouse MergeTree åˆ—å¼å­˜å‚¨å¼•æ“ï¼Œè§£æ„ä¸‹è¿™å°â€œè·‘è½¦â€æœ€é‡è¦çš„éƒ¨ä»¶ã€‚</p><p>æ‰€æœ‰çš„å­˜å‚¨å¼•æ“ï¼Œæ— è®ºç²¾è‰¯ä¸ç²—åˆ¶æ»¥é€ ï¼Œæœ€ç»ˆéƒ½æ˜¯è¦æŠŠæ•°æ®å›å†™åˆ°ç£ç›˜ï¼Œæ¥æ»¡è¶³å­˜å‚¨å’Œç´¢å¼•ç›®çš„ã€‚</p><p>ç£ç›˜æ–‡ä»¶çš„æ„é€ å¯ä»¥è¯´æ˜¯ç®—æ³•çš„ç‰©ç†ä½“ç°ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥é€šè¿‡è¿™äº›å­˜å‚¨ç»“æ„åæ¨å‡ºå…¶ç®—æ³•å®ç°ã€‚</p><p>æ‰€ä»¥ï¼Œè¦æƒ³æ·±å…¥äº†è§£ä¸€ä¸ªå­˜å‚¨å¼•æ“ï¼Œæœ€å¥½çš„å…¥æ‰‹ç‚¹æ˜¯å®ƒçš„ç£ç›˜å­˜å‚¨ç»“æ„ï¼Œç„¶åå†åè§‚å®ƒçš„è¯»ã€å†™æœºåˆ¶å°±ä¼šæœ‰ä¸€ç§æ°´åˆ°æ¸ æˆçš„æ„Ÿè§‰ã€‚</p><p>å¦‚æœè¿™ä¸ªåˆ†æé¡ºåºæåäº†ï¼Œä¼šæœ‰ä¸€ç§ç”Ÿç¡¬çš„æ„Ÿè§‰ï¼Œç½‘ä¸Šå¤§éƒ¨åˆ†æ•™ç¨‹éƒ½æ˜¯è¿™ç§â€œç”Ÿç¡¬â€å¼æ•™å­¦ï¼Œæœ¬æ–‡å°†ç›´å‡»çµé­‚ä»æœ€åº•å±‚è°ˆèµ·ï¼Œå½»åº•ææ˜ç™½ï¼”ä¸ªé—®é¢˜ï¼š</p><ol><li><p>MergeTree æœ‰å“ªäº›æ–‡ä»¶ï¼Ÿ</p></li><li><p>MergeTree æ•°æ®å¦‚ä½•åˆ†å¸ƒï¼Ÿ</p></li><li><p>MergeTree ç´¢å¼•å¦‚ä½•ç»„ç»‡ï¼Ÿ</p></li><li><p>MergeTree å¦‚ä½•åˆ©ç”¨ç´¢å¼•åŠ é€Ÿï¼Ÿ</p></li></ol><p>è¯ä¸å¤šè¯´ï¼Œä¸Šè¡¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE default.mt</span><br><span class="line">(</span><br><span class="line">    `a` Int32,</span><br><span class="line">    `b` Int32,</span><br><span class="line">    `c` Int32,</span><br><span class="line">    INDEX `idx_c` (c) TYPE minmax GRANULARITY 1</span><br><span class="line">)</span><br><span class="line">ENGINE = MergeTree</span><br><span class="line">PARTITION BY a </span><br><span class="line">ORDER BY b</span><br><span class="line">SETTINGS index_granularity=3</span><br></pre></td></tr></table></figure><p>é€ ç‚¹æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert into default.mt(a,b,c) values(1,1,1);</span><br><span class="line">insert into default.mt(a,b,c) values(5,2,2),(5,3,3);</span><br><span class="line">insert into default.mt(a,b,c) values(3,10,4),(3,9,5),(3,8,6),(3,7,7),(3,6,8),(3,5,9),(3,4,10);</span><br></pre></td></tr></table></figure><h2 id="ç£ç›˜æ–‡ä»¶"><a href="#ç£ç›˜æ–‡ä»¶" class="headerlink" title="ç£ç›˜æ–‡ä»¶"></a><b>ç£ç›˜æ–‡ä»¶</b></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls ckdatas/data/default/mt/</span><br><span class="line">1_4_4_0  3_6_6_0  5_5_5_0  detached  format_version.txt</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œç”Ÿæˆäº† 3 ä¸ªæ•°æ®ç›®å½•ï¼Œæ¯ä¸ªç›®å½•åœ¨ ClickHouse é‡Œç§°ä½œä¸€ä¸ªåˆ†åŒº(part)ï¼Œç›®å½•åçš„å‰ç¼€æ­£æ˜¯æˆ‘ä»¬å†™å…¥æ—¶å­—æ®µ a çš„å€¼: 1,3,5ï¼Œå› ä¸ºè¡¨åˆ†åŒºæ˜¯è¿™æ ·å®šä½çš„ï¼š<code>PARTITION BY a </code>ã€‚</p><p>ç°åœ¨æˆ‘ä»¬çœ‹çœ‹ a&#x3D;3 åˆ†åŒºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls ckdatas/data/default/mt/3_6_6_0/</span><br><span class="line">a.bin  a.mrk2  b.bin  b.mrk2  c.bin  checksums.txt  c.mrk2  columns.txt  count.txt  minmax_a.idx  partition.dat  primary.idx  skp_idx_idx_c.idx  skp_idx_idx_c.mrk2</span><br></pre></td></tr></table></figure><ul><li>*.bin æ˜¯åˆ—æ•°æ®æ–‡ä»¶ï¼ŒæŒ‰ä¸»é”®æ’åº(ORDER BY)ï¼Œè¿™é‡Œæ˜¯æŒ‰ç…§å­—æ®µ b è¿›è¡Œæ’åº</li><li>*.mrk2 mark æ–‡ä»¶ï¼Œç›®çš„æ˜¯å¿«é€Ÿå®šä½ bin æ–‡ä»¶æ•°æ®ä½ç½®</li><li>minmax_a.idx åˆ†åŒºé”® min-max ç´¢å¼•æ–‡ä»¶ï¼Œç›®çš„æ˜¯åŠ é€Ÿåˆ†åŒºé”® a æŸ¥æ‰¾</li><li>primay.idx ä¸»é”®ç´¢å¼•æ–‡ä»¶ï¼Œç›®çš„æ˜¯åŠ é€Ÿä¸»é”® b æŸ¥æ‰¾</li><li>skp_idx_idx_c.* å­—æ®µ c ç´¢å¼•æ–‡ä»¶ï¼Œç›®çš„æ˜¯åŠ é€Ÿ c çš„æŸ¥æ‰¾</li></ul><p>åœ¨ç£ç›˜ä¸Šï¼ŒMergeTree åªæœ‰ä¸€ç§ç‰©ç†æ’åºï¼Œå°±æ˜¯ ORDER BY çš„ä¸»é”®åºï¼Œå…¶ä»–æ–‡ä»¶(æ¯”å¦‚ .mrk&#x2F;.idx)æ˜¯ä¸€ç§é€»è¾‘åŠ é€Ÿï¼Œå›´ç»•ä»…æœ‰çš„ä¸€ä»½ç‰©ç†æ’åºï¼Œè¦è§£å†³çš„é—®é¢˜æ˜¯ï¼š</p><p><b>åœ¨ä»¥å­—æ®µ b ç‰©ç†æ’åºä¸Šï¼Œå¦‚ä½•å®ç°å­—æ®µ aã€å­—æ®µ c çš„å¿«é€ŸæŸ¥æ‰¾ï¼Ÿ</b></p><p>MergeTree å¼•æ“æ¦‚æ‹¬èµ·æ¥å¾ˆç®€å•ï¼š<br>æ•´ä¸ªæ•°æ®é›†é€šè¿‡åˆ†åŒºå­—æ®µè¢«åˆ’åˆ†ä¸ºå¤šä¸ªç‰©ç†åˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå…§åˆé€šè¿‡é€»è¾‘æ–‡ä»¶å›´ç»•ä»…æœ‰çš„ä¸€ç§ç‰©ç†æ’åºè¿›è¡ŒåŠ é€ŸæŸ¥æ‰¾ã€‚</p><h2 id="å­˜å‚¨ç»“æ„"><a href="#å­˜å‚¨ç»“æ„" class="headerlink" title="å­˜å‚¨ç»“æ„"></a><b>å­˜å‚¨ç»“æ„</b></h2><h3 id="æ•°æ®æ–‡ä»¶"><a href="#æ•°æ®æ–‡ä»¶" class="headerlink" title="æ•°æ®æ–‡ä»¶"></a><b>æ•°æ®æ–‡ä»¶</b></h3><p>å¯¹äºå•ä¸ªç‰©ç†åˆ†åŒºå…§çš„å­˜å‚¨ç»“æ„ï¼Œé¦–å…ˆè¦æ˜ç¡®ä¸€ç‚¹ï¼ŒMergeTree çš„æ•°æ®åªæœ‰ä¸€ä»½ï¼š*.binã€‚</p><p>a.bin æ˜¯å­—æ®µ a çš„æ•°æ®ï¼Œb.bin æ˜¯å­—æ®µ b çš„æ•°æ®ï¼Œc.bin æ˜¯å­—æ®µ c çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶ç†Ÿæ‚‰çš„åˆ—å­˜å‚¨ã€‚</p><p>å„ä¸ª bin æ–‡ä»¶ä»¥ b.binæ’åºå¯¹é½ï¼ˆb æ˜¯æ’åºé”®ï¼‰ï¼Œå¦‚å›¾ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/merge-tree-bin-without-granule.png" align="center" style="zoom:45%;" /><p>è¿™æ ·ä¼šæœ‰ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„é—®é¢˜ï¼š<br>å¦‚æœ *.bin æ–‡ä»¶è¾ƒå¤§ï¼Œå³ä½¿è¯»å–ä¸€è¡Œæ•°æ®ï¼Œä¹Ÿè¦åŠ è½½æ•´ä¸ª bin æ–‡ä»¶ï¼Œæµªè´¹äº†å¤§é‡çš„ IOï¼Œæ²¡æ³•å¿ã€‚</p><h3 id="granule"><a href="#granule" class="headerlink" title="granule"></a><b>granule</b></h3><p>é«˜ã€é»‘ç§‘æŠ€æ¥äº†ï¼ŒClickHouse MergeTree æŠŠ bin æ–‡ä»¶æ ¹æ®é¢—ç²’åº¦(GRANULARITY)åˆ’åˆ†ä¸ºå¤šä¸ªé¢—ç²’(granule)ï¼Œæ¯ä¸ª granule å•ç‹¬å‹ç¼©å­˜å‚¨ã€‚</p><p><code>SETTINGS index_granularity=3 </code>  è¡¨ç¤ºæ¯ ï¼“ è¡Œæ•°æ®ä¸ºä¸€ä¸ª granuleï¼Œåˆ†åŒºç›®å‰åªæœ‰ ï¼— æ¡æ•°æ®ï¼Œæ‰€ä»¥è¢«åˆ’åˆ†æˆ 3 ä¸ª granule(ä¸‰ä¸ªè‰²å—)ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/merge-tree-bin-granule.png" align="center" style="zoom:50%;" /><p>ä¸ºæ–¹ä¾¿è¯»å–æŸä¸ª granuleï¼Œä½¿ç”¨ *.mrk æ–‡ä»¶è®°å½•æ¯ä¸ª granule çš„ offsetï¼Œæ¯ä¸ª granule çš„ header é‡Œä¼šè®°å½•ä¸€äº›å…ƒä¿¡æ¯ï¼Œç”¨äºè¯»å–è§£æ:</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/merge-tree-bin-marker.png" align="center" style="zoom:50%;" /><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ® ï½ark æ–‡ä»¶ï¼Œç›´æ¥å®šä½åˆ°æƒ³è¦çš„ granuleï¼Œç„¶åå¯¹è¿™ä¸ªå•ç‹¬çš„ granule è¿›è¡Œè¯»å–ã€æ ¡éªŒã€‚</p><p>ç›®å‰ï¼Œæˆ‘ä»¬è¿˜æœ‰ç¼ºå°‘ä¸€ç§æ˜ å°„ï¼šæ¯ä¸ª mark ä¸å­—æ®µå€¼ä¹‹é—´çš„å¯¹åº”ï¼Œå“ªäº›å€¼åŒºé—´è½åœ¨ mark0ï¼Œå“ªäº›è½åœ¨ mark1 â€¦ï¼Ÿ</p><p>æœ‰äº†è¿™ä¸ªæ˜ å°„ï¼Œå°±å¯ä»¥å®ç°æœ€å°åŒ–è¯»å– granule æ¥åŠ é€ŸæŸ¥è¯¢ï¼š</p><ol><li>æ ¹æ®æŸ¥è¯¢æ¡ä»¶ç¡®å®šéœ€è¦å“ªäº› mark</li><li>æ ¹æ® mark è¯»å–ç›¸åº”çš„ granule</li></ol><h3 id="å­˜å‚¨æ’åº"><a href="#å­˜å‚¨æ’åº" class="headerlink" title="å­˜å‚¨æ’åº"></a><b>å­˜å‚¨æ’åº</b></h3><p>åœ¨äº†è§£ MergeTree ç´¢å¼•æœºåˆ¶ä¹‹å‰ï¼Œéœ€è¦æ˜ç™½ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ol><li><p>åªæœ‰ä¸€ä»½å…¨é‡æ•°æ®ï¼Œå­˜å‚¨åœ¨ *.bin æ–‡ä»¶</p></li><li><p>*.bin æŒ‰ç…§ ORDER BY å­—æ®µé™åºå­˜å‚¨</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/merge-tree-bin-orderby-sort.png" align="center" style="zoom:45%;" /></li></ol><h3 id="ç¨€ç–ç´¢å¼•"><a href="#ç¨€ç–ç´¢å¼•" class="headerlink" title="ç¨€ç–ç´¢å¼•"></a><b>ç¨€ç–ç´¢å¼•</b></h3><p>å› ä¸ºæ•°æ®åªæœ‰ä¸€ä»½ä¸”åªæœ‰ä¸€ç§ç‰©ç†æ’åºï¼ŒMergeTreeåœ¨ç´¢å¼•è®¾è®¡ä¸Šé€‰æ‹©äº†ç®€å•ã€é«˜æ•ˆçš„ç¨€ç–ç´¢å¼•æ¨¡å¼ã€‚</p><p>ä»€ä¹ˆæ˜¯ç¨€ç–ç´¢å¼•å‘¢ï¼Ÿå°±æ˜¯ä»å·²ç»æ’åºçš„å…¨é‡æ•°æ®é‡Œï¼Œé—´éš”æ€§çš„é€‰å–ä¸€äº›ç‚¹ï¼Œå¹¶è®°å½•è¿™äº›ç‚¹å±äºå“ªä¸ª markã€‚</p><h4 id="1-primary-index"><a href="#1-primary-index" class="headerlink" title="1. primary index"></a><b>1. primary index</b></h4><p>ä¸»é”®ç´¢å¼•ï¼Œå¯é€šè¿‡<code>[PRIMARY KEY expr]</code>æŒ‡å®šï¼Œé»˜è®¤æ˜¯ ORDER BY å­—æ®µå€¼ã€‚</p><p>æ³¨æ„ ClickHouse primary index è·Ÿ MySQL primary key ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µã€‚</p><p>åœ¨ç¨€ç–ç‚¹çš„é€‰æ‹©ä¸Šï¼Œå–æ¯ä¸ª granule æœ€å°å€¼ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/merge-tree-primary-key.png" align="center" style="zoom:45%;" /><h4 id="2-skipping-index"><a href="#2-skipping-index" class="headerlink" title="2. skipping index"></a><b>2. skipping index</b></h4><p>æ™®é€šç´¢å¼•ã€‚</p><p><code>INDEX</code>idx_c<code> (c) TYPE minmax GRANULARITY 1</code> é’ˆå¯¹å­—æ®µ c åˆ›å»ºä¸€ä¸ª minmax æ¨¡å¼ç´¢å¼•ã€‚</p><p><code>GRANULARITY</code> æ˜¯ç¨€ç–ç‚¹é€‰æ‹©ä¸Šçš„ granule é¢—ç²’åº¦ï¼Œ<code>GRANULARITY 1</code> è¡¨ç¤ºæ¯ 1 ä¸ª granule é€‰å–ä¸€ä¸ªï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/merge-tree-skipping-index-g1.png" align="center" style="zoom:40%;" /><p>å¦‚æœå®šä¹‰ä¸º<code>GRANULARITY 2</code> ï¼Œåˆ™ 2 ä¸ª granule é€‰å–ä¸€ä¸ªï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/merge-tree-skipping-index-g2.png" align="center" style="zoom:40%;" /><h4 id="3-partition-minmax-index"><a href="#3-partition-minmax-index" class="headerlink" title="3. partition minmax index"></a><b>3. partition minmax index</b></h4><p>é’ˆå¯¹åˆ†åŒºé”®ï¼ŒMergeTree è¿˜ä¼šåˆ›å»ºä¸€ä¸ª min&#x2F;max ç´¢å¼•ï¼Œæ¥åŠ é€Ÿåˆ†åŒºé€‰æ‹©ã€‚</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/merge-tree-minmax-idx.png" align="center" style="zoom:40%;" /><h4 id="4-å…¨æ™¯å›¾"><a href="#4-å…¨æ™¯å›¾" class="headerlink" title="4. å…¨æ™¯å›¾ "></a><b>4. å…¨æ™¯å›¾ </b></h4><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/merge-tree-layout.png" align="center" style="zoom:95%;" /><h2 id="æŸ¥è¯¢ä¼˜åŒ–"><a href="#æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–"></a><b>æŸ¥è¯¢ä¼˜åŒ–</b></h2><p>ç°åœ¨ç†Ÿæ‚‰äº† MergeTree çš„å­˜å‚¨ç»“æ„ï¼Œæˆ‘ä»¬é€šè¿‡å‡ ä¸ªæŸ¥è¯¢æ¥ä½“éªŒä¸‹ã€‚</p><h3 id="1-åˆ†åŒºé”®æŸ¥è¯¢"><a href="#1-åˆ†åŒºé”®æŸ¥è¯¢" class="headerlink" title="1. åˆ†åŒºé”®æŸ¥è¯¢"></a><b>1. åˆ†åŒºé”®æŸ¥è¯¢</b></h3><p>è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from default.mt where a=3</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ä¼šç›´æ¥æ ¹æ® <code>a=3</code> å®šä½åˆ°å•ä¸ªåˆ†åŒº:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;Debug&gt; InterpreterSelectQuery: MergeTreeWhereOptimizer: condition &quot;a = 3&quot; moved to PREWHERE</span><br><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): Key condition: unknown</span><br><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): MinMax index condition: (column 0 in [3, 3])</span><br><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): Selected 1 parts by a, 1 parts by key, 3 marks by primary key, 3 marks to read from 1 ranges</span><br><span class="line">â”Œâ”€aâ”€â”¬â”€â”€bâ”€â”¬â”€â”€câ”€â”</span><br><span class="line">â”‚ 3 â”‚  4 â”‚ 10 â”‚</span><br><span class="line">â”‚ 3 â”‚  5 â”‚  9 â”‚</span><br><span class="line">â”‚ 3 â”‚  6 â”‚  8 â”‚</span><br><span class="line">â”‚ 3 â”‚  7 â”‚  7 â”‚</span><br><span class="line">â”‚ 3 â”‚  8 â”‚  6 â”‚</span><br><span class="line">â”‚ 3 â”‚  9 â”‚  5 â”‚</span><br><span class="line">â”‚ 3 â”‚ 10 â”‚  4 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="2-ä¸»é”®ç´¢å¼•æŸ¥è¯¢"><a href="#2-ä¸»é”®ç´¢å¼•æŸ¥è¯¢" class="headerlink" title="2. ä¸»é”®ç´¢å¼•æŸ¥è¯¢"></a><b>2. ä¸»é”®ç´¢å¼•æŸ¥è¯¢</b></h3><p>è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from default.mt where b=5</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ä¼šå…ˆä» 3 ä¸ªåˆ†åŒºè¯»å– prmary.idxï¼Œç„¶åå®šä½åˆ°åªæœ‰ä¸€ä¸ªåˆ†åŒºç¬¦åˆæ¡ä»¶ï¼Œæ‰¾åˆ°è¦è¯»å–çš„ mark:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): Key condition: (column 0 in [5, 5])</span><br><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): MinMax index condition: unknown</span><br><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): Selected 3 parts by a, 1 parts by key, 1 marks by primary key, 1 marks to read from 1 ranges</span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”¬â”€câ”€â”</span><br><span class="line">â”‚ 3 â”‚ 5 â”‚ 9 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="3-ç´¢å¼•æŸ¥è¯¢"><a href="#3-ç´¢å¼•æŸ¥è¯¢" class="headerlink" title="3. ç´¢å¼•æŸ¥è¯¢"></a><b>3. ç´¢å¼•æŸ¥è¯¢</b></h3><p>è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from default.mt where c=5</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ä¼šå…ˆä» 3 ä¸ªåˆ†åŒºè¯»å– prmary.idx å’Œ skp_idx_idx_c.idx è¿›è¡Œ granule è¿‡æ»¤ï¼ˆæ²¡ç”¨çš„ drop æ‰ï¼‰ï¼Œç„¶åå®šä½åˆ°åªæœ‰ 3_x_x_x åˆ†åŒºçš„ä¸€ä¸ª granule ç¬¦åˆæ¡ä»¶:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;Debug&gt; InterpreterSelectQuery: MergeTreeWhereOptimizer: condition &quot;b = 5&quot; moved to PREWHERE</span><br><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): Key condition: unknown</span><br><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): MinMax index condition: unknown</span><br><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): Index `idx_c` has dropped 1 / 1 granules.</span><br><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): Index `idx_c` has dropped 1 / 1 granules.</span><br><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): Index `idx_c` has dropped 2 / 3 granules.</span><br><span class="line">&lt;Debug&gt; default.mt (SelectExecutor): Selected 3 parts by a, 1 parts by key, 5 marks by primary key, 1 marks to read from 1 ranges</span><br><span class="line">â”Œâ”€aâ”€â”¬â”€bâ”€â”¬â”€câ”€â”</span><br><span class="line">â”‚ 3 â”‚ 9 â”‚ 5 â”‚</span><br><span class="line">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><b>æ€»ç»“</b></h2><p>æœ¬æ–‡ä»ç£ç›˜å­˜å‚¨ç»“æ„å…¥æ‰‹ï¼Œåˆ†æ ClickHouse MergeTree çš„å­˜å‚¨ã€ç´¢å¼•è®¾è®¡ã€‚</p><p>åªæœ‰äº†è§£äº†è¿™äº›åº•å±‚æœºåˆ¶ï¼Œæˆ‘ä»¬æ‰å¥½å¯¹è‡ªå·±çš„ SQL å’Œè¡¨ç»“æ„è¿›è¡Œä¼˜åŒ–ï¼Œä½¿å…¶æ‰§è¡Œæ›´åŠ é«˜æ•ˆã€‚</p><p>ClickHouse MergeTree è®¾è®¡ç®€å•ã€é«˜æ•ˆï¼Œå®ƒé¦–è¦è§£å†³çš„é—®é¢˜æ˜¯ï¼šåœ¨ä¸€ç§ç‰©ç†æ’åºä¸Šï¼Œå¦‚ä½•å®ç°å¿«é€ŸæŸ¥æ‰¾ã€‚</p><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼ŒClickHouseä½¿ç”¨ç¨€ç–ç´¢å¼•æ¥è§£å†³ã€‚</p><p>åœ¨å®˜æ–¹ roadmap ä¸Šï¼Œåˆ—ä¸¾äº†ä¸€ä¸ªæœ‰æ„æ€çš„ç´¢å¼•æ–¹å‘ï¼šZ-Order Indexingï¼Œç›®çš„æ˜¯æŠŠå¤šä¸ªç»´åº¦ç¼–ç åˆ°ä¸€ç»´å­˜å‚¨ï¼Œå½“æˆ‘ä»¬ç»™å‡ºå¤šç»´åº¦æ¡ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥å¿«é€Ÿå®šä½åˆ°è¿™ä¸ªæ¡ä»¶ç‚¹é›†çš„ç©ºé—´ä½ç½®ï¼Œç›®å‰ ClickHouse é’ˆå¯¹è¿™ä¸ªç´¢å¼•è®¾è®¡æš‚æ— è¿›å±•ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;b&gt;æœ€åæ›´æ–°: 2020-09-28&lt;/b&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šç¯‡çš„ &lt;a href=&quot;/2020/06/20/clickhouse-and-friends-merge-tree-algo/&quot;&gt;å­˜å‚¨å¼•æ“æŠ€æœ¯è¿›åŒ–ä¸MergeTree&lt;/a&gt; ä»‹ç»äº†å­˜å‚¨ç®—æ³•çš„æ¼”è¿›ã€‚&lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="clickhouse" scheme="https://bohutang.me/tags/clickhouse/"/>
    
    <category term="ClickHouseå’Œä»–çš„æœ‹å‹ä»¬" scheme="https://bohutang.me/tags/ClickHouse%E5%92%8C%E4%BB%96%E7%9A%84%E6%9C%8B%E5%8F%8B%E4%BB%AC/"/>
    
    <category term="lsm" scheme="https://bohutang.me/tags/lsm/"/>
    
    <category term="mergetree" scheme="https://bohutang.me/tags/mergetree/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆ5ï¼‰å­˜å‚¨å¼•æ“æŠ€æœ¯è¿›åŒ–ä¸MergeTree</title>
    <link href="https://bohutang.me/2020/06/20/clickhouse-and-friends-merge-tree-algo/"/>
    <id>https://bohutang.me/2020/06/20/clickhouse-and-friends-merge-tree-algo/</id>
    <published>2020-06-19T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.051Z</updated>
    
    <content type="html"><![CDATA[<p>21 ä¸–çºªçš„ç¬¬äºŒä¸ª 10 å¹´ï¼Œè™å“¥å·²ç»åœ¨å­˜å‚¨å¼•æ“ä¸€çº¿å¥‹æˆ˜è¿‘ 10 å¹´ï¼Œç”±äºå¼ºå¤§çš„å…´è¶£é©±åŠ¨ï¼Œè¿™ä¹ˆå¤šå¹´æ¥å‡ ä¹ä¸æ”¾è¿‡ arXiv ä¸Šä¸å­˜å‚¨ç›¸å…³çš„æ¯ä¸€ç¯‡ paperã€‚<br>å°¤å…¶æ˜¯çœ‹åˆ°å¸¦æœ‰ draft çš„ paper æ—¶ï¼Œæœ‰ä¸€ç§ä¹ä¸å¬åˆ°â€œå®å½“â€å“æ—¶çš„æ„‰æ‚¦ã€‚<br>çœ‹paperè¿™ç©æ„å°±åƒé‰´å®ï¼Œå¤šæ•°æ˜¯â€œèµå“â€ï¼Œéœ€è¦ä½ æœ‰â€œé‰´çœŸâ€çš„æœ¬é¢†ï¼Œå¦åˆ™ä»Šå¤©æ˜¯å¼ ä¸‰çš„ç®—æ³•è¶…è¶Šxxï¼Œæ˜å„¿åˆæ˜¯ç‹äºŒçš„ç¡¬ä»¶æå‡äº†yyï¼Œè®©ä½ æ°¸è¿œè·Ÿä¸ä¸ŠèŠ‚å¥zzï¼Œæ¹®ç­åœ¨è¿™äº›æ²¡æœ‰è¥å…»çš„æŠ€æœ¯åƒåœ¾ä¸­ï¼Œæµªè´¹å¤§å¥½é’æ˜¥ã€‚</p><p>è¨€å½’æ­£ä¼ ï¼Œæ¥ä¸‹æ¥çš„3ç¯‡ï¼Œè·Ÿ ClickHouse çš„ MergeTree å¼•æ“æœ‰å…³ï¼š<br><b>ä¸Šç¯‡ä»‹ç»å­˜å‚¨å¼•æ“çš„æŠ€æœ¯æ¼”è¿›å²</b>ï¼Œä»â€è¿œå¤â€çš„ B-tree å‡ºå‘æ¨æ¼”åˆ°ç›®å‰ä¸»æµçš„æŠ€æœ¯æ¶æ„ã€‚<br><b><a href="/2020/06/26/clickhouse-and-friends-merge-tree-disk-layout/">ä¸­ç¯‡ä¼šä»å­˜å‚¨ç»“æ„ä»‹ç» MergeTree åŸç†</a></b>ï¼Œå¯¹ ClickHouse MergeTree æœ‰ä¸€ä¸ªæ·±å…¥çš„è®¤è¯†ï¼Œå¦‚ä½•åˆç†è®¾è®¡æ¥è¿›è¡Œç§‘å­¦åŠ é€Ÿã€‚<br><b>ä¸‹ç¯‡ä¼šä»MergeTreeä»£ç å‡ºå‘</b>ï¼Œçœ‹çœ‹ ClickHouse MergeTree å¦‚ä½•å®ç°è¯»ã€å†™ã€‚</p><p>æœ¬æ–‡ä¸ºä¸Šç¯‡ï¼Œå…ˆæ¥ä¸ªçƒ­èº«ï¼Œç›¸ä¿¡æœ¬ç¯‡å¤§éƒ¨åˆ†å†…å®¹å¯¹å¤§å®¶æ¥è¯´éƒ½æ¯”è¾ƒé™Œç”Ÿï¼Œå¾ˆå°‘äººå†™è¿‡ã€‚</p><h2 id="åœ°ä½"><a href="#åœ°ä½" class="headerlink" title="åœ°ä½"></a><b>åœ°ä½</b></h2><p>å­˜å‚¨å¼•æ“(äº‹åŠ¡å‹)åœ¨ä¸€ä¸ªæ•°æ®åº“(DBMS)ä¸­çš„åœ°ä½å¦‚ä½•å‘¢ï¼Ÿ</p><p>MySQL çš„å•†ä¸šæˆåŠŸå¯ä»¥è¯´å¤§éƒ¨åˆ†æ¥è‡ªäº InnoDB å¼•æ“ï¼ŒOracle æ”¶è´­ InnoDB æ¯” MySQL æ—©å¥½å‡ å¹´å‘¢ï¼<br>20å¹´å‰ï¼Œèƒ½äº²æ‰‹æ’¸ä¸€å¥— <a href="https://en.wikipedia.org/wiki/Algorithms_for_Recovery_and_Isolation_Exploiting_Semantics">ARIES (Algorithms for Recovery and Isolation Exploiting Semantics)</a> è§„èŒƒå¼•æ“ï¼Œå®åŠ›è¿˜æ˜¯ç›¸å½“éœ‡æ’¼çš„ï¼Œç›¸ä¿¡ Oracle æ”¶è´­çš„ä¸ä»…æ˜¯ InnoDB è¿™ä¸ªå¼•æ“ï¼Œæ›´é‡è¦çš„æ˜¯äººï¼Œ InnoDB ä½œè€…åœ¨å“ªé‡Œï¼Œåœ¨å¹²ä»€ä¹ˆï¼Ÿï¼<br>Fork å‡ºæ¥çš„ MariaDB è¿™ä¹ˆå¤šå¹´ä¸€ç›´æ‰¾ä¸åˆ°è‡ªå·±çš„çµé­‚ï¼Œåœ¨ Server å±‚ç£¨ç£¨è¹­è¹­å¯è°“æ˜¯æ±Ÿæ²³æ—¥ä¸‹ï¼Œåªèƒ½å››å¤„æ”¶è´­ç¢°ç¢°è¿æ°”ï¼Œå½“å¹´ TokuDB æˆ˜æ–—è¿‡çš„ commit ä¾åœ¨ï¼Œä½†è¿™äº›å·²ç»æ˜¯å†å²äº†ã€‚<br>å¦ï¼ŒWiredTiger è¢« MongoDB æ”¶è´­å¹¶ä½¿ç”¨ï¼Œå¯¹æ•´ä¸ªç”Ÿæ€æ‰€èµ·çš„ä½œç”¨ä¹Ÿæ˜¯æ— å¯ä¼°é‡çš„ï¼Œè¿™äº›å‘åŠ¨æœºå¼•æ“å¯¹äºä¸€è¾†æ±½è½¦æ˜¯éå¸¸é‡è¦çš„ã€‚</p><p>æœ‰äººé—®é“ï¼Œéƒ½å·²ç» 2020 å¹´äº†ï¼Œå¼€å‘ä¸€ä¸ªå­˜å‚¨å¼•æ“è¿˜è¿™ä¹ˆéš¾å—ï¼Ÿä¸éš¾ï¼Œä½†æ˜¯é€ å‡ºæ¥çš„æœªå¿…æœ‰ RocksDB å¥½ç”¨ï¼Ÿï¼<br>å¦‚å¤§å®¶æ‰€è§ï¼Œå¾ˆå¤šçš„åˆ†å¸ƒå¼å­˜å‚¨å¼•æ“éƒ½æ˜¯åŸºäº RocksDB ç ”å‘ï¼Œå¯è°“çŸ­æœŸå†…è¿˜ç®—æ˜æ™ºçš„é€‰æ‹©ã€‚<br>ä»å·¥ç¨‹è§’åº¦æ¥çœ‹ï¼Œä¸€ä¸ª ACID å¼•æ“è¦æ‰“ç£¨çš„ä¸œè¥¿éå¸¸ä¹‹å¤šï¼Œåˆ°å¤„å……æ–¥ç€äººåŠ›ã€é’±åŠ›ã€è€å¿ƒçš„æ¶ˆè€—ï¼Œä¸€ç§å¯èƒ½æ˜¯å†™åˆ°ä¸€åŠå°±åœæ»äº†(å¦‚ <a href="https://github.com/BohuTANG/nessDB">nessDB</a>)ï¼Œè¿˜æœ‰ä¸€ç§å¯èƒ½æ˜¯å†™ç€å†™ç€å‘ç°è·Ÿxxå¾ˆåƒï¼Œæ²ƒèŒ¨æ³•å…‹ã€‚<br>å½“ç„¶ï¼Œè¿™é‡Œå¹¶ä¸æ˜¯é¼“åŠ±å¤§å®¶éƒ½å»åŸºäº RocksDB å»æ„å»ºè‡ªå·±çš„äº§å“ï¼Œè€Œæ˜¯è¦æ ¹æ®è‡ªå·±çš„æƒ…å†µå»åšé€‰æ‹©ã€‚</p><h2 id="B-tree"><a href="#B-tree" class="headerlink" title="B-tree"></a><b>B-tree</b></h2><p>é¦–å…ˆè¦å°Šç§°ä¸€å£°å¤§çˆ·ï¼Œè¿™ä¸ªå¤§çˆ·å¹´æ–¹ 50ï¼Œç›®å‰æ”¯æ’‘ç€æ•°æ®åº“äº§ä¸šçš„åŠå£æ±Ÿå±±ã€‚</p><p>50 å¹´æ¥ä¸å˜è€Œä¸”äººä»¬è¿˜æ²¡æœ‰æ”¹å˜å®ƒçš„æ„å‘ï¼Œè¿™ä¸ªå¤§çˆ·å‰å®³çš„å¾ˆï¼<br>é‰´å®šä¸€ä¸ªç®—æ³•çš„ä¼˜åŠ£ï¼Œæœ‰ä¸€ä¸ªå­¦æ´¾å« <b>IOå¤æ‚åº¦åˆ†æ</b>ï¼Œç®€å•æ¨æ¼”çœŸå‡ä¾¿çŸ¥ã€‚<br>ä¸‹é¢å°±ç”¨æ­¤æ³•åˆ†æä¸‹ B-tree(traditional b-tree) çš„ IO å¤æ‚åº¦ï¼Œå¯¹è¯»ã€å†™ IO ä¸€ç›®äº†ç„¶ï¼ŒçœŸæ­£æ˜ç™½è¯»ä¸ºä»€ä¹ˆå¿«ï¼Œå†™ä¸ºä»€ä¹ˆæ…¢ï¼Œå¦‚ä½•ä¼˜åŒ–ã€‚<br>ä¸ºäº†å¯ä»¥æ„‰å¿«çš„é˜…è¯»ï¼Œæœ¬æ–‡ä¸ä¼šåšä»»ä½•å…¬å¼æ¨å¯¼ï¼Œå¤æ‚åº¦åˆ†ææ€ä¹ˆå¯èƒ½æ²¡æœ‰å…¬å¼å‘¢ï¼</p><h3 id="è¯»IOåˆ†æ"><a href="#è¯»IOåˆ†æ" class="headerlink" title="è¯»IOåˆ†æ"></a><b>è¯»IOåˆ†æ</b></h3><p>è¿™é‡Œæœ‰ä¸€ä¸ª 3-level çš„ B-treeï¼Œæ¯ä¸ªæ–¹å—ä»£è¡¨ä¸€ä¸ª pageï¼Œæ•°å­—ä»£è¡¨ page IDã€‚</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/btree-read.png" align="center" style="zoom:40%;" /><p>ä¸Šå›¾ B-tree ç»“æ„æ˜¯<b>å†…å­˜</b>çš„ä¸€ä¸ªè¡¨ç°å½¢å¼ï¼Œå¦‚æœæˆ‘ä»¬è¦è¯»å–çš„è®°å½•åœ¨ leaf-8ä¸Šï¼Œread-path å¦‚è“è‰²ç®­å¤´æ‰€ç¤º:<br>root-9 â€“&gt; branch-6 â€“&gt; leaf-8</p><p>ä¸‹å›¾æ˜¯ B-tree åœ¨<b>ç£ç›˜</b>ä¸Šçš„å­˜å‚¨å½¢å¼ï¼Œmeta page æ˜¯èµ·ç‚¹:<br><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/btree-read-disk.png" align="center" style="zoom:40%;" /></p><p>è¿™æ ·è¯»å–çš„éšæœº IO (å‡è®¾å†…å­˜é‡Œæ²¡æœ‰ page ç¼“å­˜ä¸” page å­˜å‚¨æ˜¯éšæœºçš„)æ€»æ•°å°±æ˜¯(è“è‰²ç®­å¤´):</p><p>1(meta-10)IO +  1(root-9)IO + 1(branch-6)IO + 1(leaf-8)IO &#x3D; 4æ¬¡ IOï¼Œè¿™é‡Œå¿½ç•¥ä¸€ç›´ç¼“å­˜çš„ meta å’Œ rootï¼Œå°±æ˜¯ <b>2</b> æ¬¡éšæœº IOã€‚<br>å¦‚æœç£ç›˜ seek æ˜¯ 1msï¼Œè¯»å–å»¶è¿Ÿå°±æ˜¯ <b>2ms</b>ã€‚</p><p>é€šè¿‡æ¨æ¼”å°±ä¼šå‘ç°ï¼ŒB-tree æ˜¯ä¸€ç§è¯»ä¼˜åŒ–(Read-Optimized)çš„æ•°æ®ç»“æ„ï¼Œæ— è®º LSM-tree è¿˜æ˜¯ Fractal-tree ç­‰åœ¨è¯»ä¸Šåªèƒ½æ¯”å®ƒæ…¢ï¼Œå› ä¸ºè¯»æ”¾å¤§(Read Amplification)é—®é¢˜ã€‚<br>å­˜å‚¨å¼•æ“ç®—æ³•å¯è°“æ—¥æ–°æœˆå¼‚ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†éƒ½æ˜¯åœ¨è·Ÿå†™ä¼˜åŒ–(Write-Optimized)åšæ–—äº‰ï¼Œé‚£æ€•æ˜¯ä¸€ä¸ªå¸¸æ•°é¡¹çš„ä¼˜åŒ–é‚£å°±æ˜¯çªç ´ï¼Œè‡ªä» Fractal-tree çªç ´åå†æ— æ¥è€…äº†ï¼</p><h3 id="å†™IOåˆ†æ"><a href="#å†™IOåˆ†æ" class="headerlink" title="å†™IOåˆ†æ"></a><b>å†™IOåˆ†æ</b></h3><p>ç°åœ¨å†™ä¸€æ¡è®°å½•åˆ° leaf-8ã€‚</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/btree-update-raw.png" align="center" style="zoom:40%;" /><p>å¯ä»¥å‘ç°ï¼Œæ¯æ¬¡å†™éƒ½éœ€è¦å…ˆè¯»å–ä¸€éï¼Œå¦‚ä¸Šå›¾è“è‰²è·¯å¾„æ‰€ç¤ºã€‚</p><p>å‡è®¾è¿™æ¬¡å†™å…¥å¯¼è‡´ root, branch éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™ç§ in-place çš„æ›´æ–°åæ˜ åˆ°ç£ç›˜ä¸Šå°±æ˜¯ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/btree-update-raw-disk.png" align="center" style="zoom:40%;" /><p>åŸºæœ¬æ˜¯ <b>2</b> æ¬¡è¯» IOå’Œå†™ <b>2</b> æ¬¡å†™ IO+WAL fsyncï¼Œç²—ç•¥ä¸º <b>4</b> æ¬¡éšæœº IOã€‚<br>é€šè¿‡åˆ†æå‘ç°ï¼ŒB-tree å¯¹å†™æ“ä½œä¸å¤ªå‹å¥½ï¼Œéšæœº IO æ¬¡æ•°è¾ƒå¤šï¼Œè€Œä¸” in-place æ›´æ–°å¿…é¡»å¢åŠ ä¸€ä¸ª page çº§çš„ WAL ä¿è¯å¤±è´¥å›æ»šï¼Œç®€ç›´æ˜¯è¦å‘½ã€‚</p><h3 id="Write-Optimized-B-tree"><a href="#Write-Optimized-B-tree" class="headerlink" title="Write-Optimized B-tree"></a><b>Write-Optimized B-tree</b></h3><p>è¯´åˆ°å†™ä¼˜åŒ–ï¼Œåœ¨æœºæ¢°ç›˜çš„å¹´ä»£ï¼Œå¤§å®¶çš„æ–¹å‘åŸºæœ¬æ˜¯æŠŠéšæœº IO è½¬æ¢ä¸ºé¡ºåº IOï¼Œå……åˆ†å‘æŒ¥ç£ç›˜çš„æœºæ¢°ä¼˜åŠ¿ï¼Œäºæ˜¯å‡ºç°ä¸€ç§ Append-only B-treeï¼š<br><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/btree-aof.png" align="center" style="zoom:40%;" /></p><ol><li>æ›´æ–°ç”Ÿæˆæ–°çš„ page(è“è‰²)</li><li>page å›å†™ç£ç›˜æ—¶ append only åˆ°æ–‡ä»¶æœ«å°¾</li><li>æ— éœ€ page WALï¼Œæ•°æ®ä¸ overwriteï¼Œæœ‰å†™æ”¾å¤§(Write Amplification)é—®é¢˜ï¼Œéœ€è¦åšç©ºæ´é‡åˆ©ç”¨æœºåˆ¶</li></ol><p>Append-only B-tree èŠ‚çœäº†å›å†™æ—¶çš„ 2 æ¬¡éšæœº IOï¼Œè½¬æ¢ä¸ºå¸¸æ•°çº§(constant)çš„1æ¬¡é¡ºåº IOï¼Œå†™æ€§èƒ½å¤§å¹…æå‡ï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ï¼š<br><b>éšæœºå˜é¡ºåºï¼Œç©ºé—´æ¢æ—¶é—´</b><br>LSM-tree, Fractal-tree ç­‰å†™ä¼˜åŒ–ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³ä¹Ÿæ˜¯è¿™ä¸ªï¼Œåªä¸è¿‡å…¶å®ç°æœºåˆ¶ä¸åŒã€‚</p><h2 id="LSM-trees"><a href="#LSM-trees" class="headerlink" title="LSM-trees"></a><b>LSM-trees</b></h2><p>éšç€ LevelDB çš„é—®ä¸–ï¼ŒLSM-tree é€æ¸è¢«å¤§å®¶æ‰€ç†ŸçŸ¥ã€‚<br>LSM-tree æ›´åƒä¸€ç§æ€æƒ³ï¼Œæ¨¡ç³Šäº† B-tree é‡Œ tree çš„ä¸¥è‚ƒæ€§ï¼Œé€šè¿‡æ–‡ä»¶ç»„ç»‡æˆä¸€ä¸ªæ›´åŠ æ¾æ•£çš„ treeã€‚<br>è¿™é‡Œä¸è°ˆä¸€ä¸ªå…·ä½“çš„ LSM-tree æ˜¯ Leveled è¿˜æ˜¯ Size-tieredï¼Œåªè°ˆå¤§ä½“æ€æƒ³ã€‚</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/lsm-tree.png" align="center" style="zoom:40%;" /><h3 id="å†™å…¥"><a href="#å†™å…¥" class="headerlink" title="å†™å…¥"></a><b>å†™å…¥</b></h3><ol><li><p>å…ˆå†™å…¥å†…å­˜çš„ C0</p></li><li><p>åå°çº¿ç¨‹æ ¹æ®è§„åˆ™(Leveled&#x2F;Sized)è¿›è¡Œ mergeï¼ŒC0 â€“&gt; C1, C1 â€“&gt; C2 â€¦ CL</p></li><li><p>å†™å…¥ C0 å³å¯è¿”å›ï¼ŒIO æ”¾åˆ°åå°çš„ Merge è¿‡ç¨‹</p></li><li><p>æ¯æ¬¡ Merge æ˜¯ç¡¬ä¼¤ï¼ŒåŠ¨ä½œå¤§å°±æŠ–ï¼ŒåŠ¨ä½œå°æ€§èƒ½ä¸å¥½ï¼Œæ¯æ¬¡ Merge çš„æ•°æ®æµå‘ä¸æ˜ç¡®</p></li><li><p>å†™æ”¾å¤§é—®é¢˜</p></li></ol><h3 id="è¯»å–"><a href="#è¯»å–" class="headerlink" title="è¯»å–"></a><b>è¯»å–</b></h3><ol><li>è¯»å– C0</li><li>è¯»å– C1 .. CL</li><li>åˆå¹¶è®°å½•è¿”å›</li><li>è¯»æ”¾å¤§é—®é¢˜</li></ol><h2 id="Fractal-tree"><a href="#Fractal-tree" class="headerlink" title="Fractal-tree"></a><b>Fractal-tree</b></h2><p>ç»ˆäºå‘å±•åˆ°äº†â€œç»ˆæâ€ä¼˜åŒ–(ç›®å‰æœ€å…ˆè¿›çš„ç´¢å¼•ç®—æ³•)ï¼ŒFractal-treeã€‚<br>å®ƒæ˜¯åœ¨ Append-only B-tree çš„åŸºç¡€ä¸Šï¼Œå¯¹æ¯ä¸ª branch èŠ‚ç‚¹å¢åŠ äº†ä¸€ä¸ª message buffer ä½œä¸ºç¼“å†²ï¼Œå¯ä»¥çœ‹åšæ˜¯ LSM-tree å’Œ Append-only B-tree å®Œç¾åˆä½“ã€‚</p><p>ç›¸å¯¹äº LSM-tree å®ƒçš„ä¼˜åŠ¿éå¸¸æ˜æ˜¾:<br>Merge æ›´åŠ æœ‰åºï¼Œæ•°æ®æµå‘éå¸¸åˆ†æ˜ï¼Œæ¶ˆé™¤äº† Merge çš„æŠ–åŠ¨é—®é¢˜ï¼Œå¤§å®¶ä¸€ç›´å¯»æ‰¾çš„ compaction é˜²æŠ–æ–¹æ¡ˆä¸€ç›´å­˜åœ¨çš„ï¼</p><p>è¿™ä¸ªé«˜ç§‘æŠ€ç›®å‰åªæœ‰ <a href="https://github.com/xelabs/tokudb">TokuDB</a> åœ¨ä½¿ç”¨ï¼Œè¿™ä¸ªç®—æ³•å¯ä»¥å¼€ç¯‡æ–°ä»‹ï¼Œè¿™é‡Œä¸åšç´¯è¿°ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒåŸå‹å®ç° <a href="https://github.com/BohuTANG/nessDB">nessDB</a>ã€‚</p><h2 id="Cache-oblivious"><a href="#Cache-oblivious" class="headerlink" title="Cache-oblivious"></a><b>Cache-oblivious</b></h2><p>è¿™ä¸ªè¯å¯¹äºå¤§éƒ¨åˆ†äººéƒ½æ˜¯é™Œç”Ÿçš„ï¼Œä¸è¿‡åˆ«æ€•ã€‚<br>åœ¨å­˜å‚¨å¼•æ“é‡Œï¼Œæœ‰ä¸€ä¸ªæ•°æ®ç»“æ„éå¸¸éå¸¸é‡è¦ï¼Œå®ƒè´Ÿè´£ page æ•°æ®æœ‰åºæ€§ç»´æŠ¤ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ª page é‡Œæ€ä¹ˆå¿«é€Ÿå®šä½åˆ°æˆ‘è¦çš„è®°å½•ã€‚<br>åœ¨ LevelDB é‡Œä½¿ç”¨ skiplistï¼Œä½†å¤§éƒ¨åˆ†å¼•æ“ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªæœ‰åºæ•°ç»„æ¥è¡¨ç¤ºï¼Œæ¯”å¦‚ [1, 2, 3, â€¦ 100]ï¼Œç„¶åä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ã€‚</p><p>å¤§æ¦‚ 10 å¹´å‰ä¸€ä½å†…æ ¸å¼€å‘è€…å‘è¡¨äº†ä¸€ç¯‡ &lt;<a href="https://queue.acm.org/detail.cfm?id=1814327">Youâ€™re Doing It Wrong</a>&gt;ï¼Œè¿™ä¸ªå°æ–‡è®²äº†ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„äº‹æƒ…:<br>æ•°æ®çš„ç»„ç»‡å½¢å¼å¯¹æ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ï¼Œå› ä¸º CPUæœ‰ cache lineã€‚</p><p>æŠ›å¼€è¿™ç¯‡æ–‡ç« ä¸è°ˆï¼Œå’±ä»¬æ¥çœ‹ä¸€å¼ â€œç¥ä»™â€å›¾ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/veb-layout.png" align="center" style="zoom:40%;" /><p>è¿™æ˜¯ä¸€ä¸ª binary-tree çš„ 4 ç§ layout è¡¨ç¤ºå½¢å¼ï¼Œé‚£ä¹ˆå“ªç§ layout å¯¹ CPU cache line æœ€å‹å¥½ï¼Ÿ</p><p>ä¹Ÿè®¸ä½ å·²ç»çŒœå¯¹äº†ï¼Œé‚£å°±æ˜¯ van Emde Boasï¼Œç®€ç§° vEBã€‚<br>å› ä¸ºå®ƒçš„ç›¸é‚»æ•°æ®â€œæ‰å †â€å­˜å‚¨ï¼Œpoint-query å’Œ range-query çš„ cache line å¯ä»¥æœ€å¤§åŒ–å…±äº«ï¼Œskiplist å¯¹ cache line æ˜¯éå¸¸ä¸å‹å¥½çš„ï¼Œè¿˜å¯ä»¥æ›´å¿«ï¼<br>å¯¹äº cache oblivious æ•°æ®ç»“æ„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„åŸå‹å®ç°: <a href="https://github.com/BohuTANG/omt">omt</a></p><h2 id="B-treeä¼˜åŒ–é­”åŠ›è±¡é™"><a href="#B-treeä¼˜åŒ–é­”åŠ›è±¡é™" class="headerlink" title="B-treeä¼˜åŒ–é­”åŠ›è±¡é™"></a><b>B-treeä¼˜åŒ–é­”åŠ›è±¡é™</b></h2><p>å†™ä¼˜åŒ–ç®—æ³•ä»åŸç”Ÿçš„ B-tree åˆ° Append-only B-tree(ä»£è¡¨ä½œ LMDB)ï¼Œåˆåˆ° LSM-tree(LevelDB&#x2F;RocksDB ç­‰)ï¼Œæœ€åè¿›åŒ–åˆ°ç›®å‰æœ€å…ˆè¿›çš„ Fractal-tree (TokuDB)ã€‚<br>è¿™äº›ç®—æ³•è€—è´¹äº†å¾ˆå¤šå¹´æ‰åœ¨å·¥ç¨‹ä¸Šå®ç°å¹¶è¢«è®¤å¯ï¼Œç ”å‘ä¸€æ¬¾å­˜å‚¨å¼•æ“ç¼ºçš„ä¸æ˜¯ç®—æ³•è€Œæ˜¯â€œé‰´å®â€çš„èƒ½åŠ›ï¼Œè¿™ä¸ªâ€œå®â€å¯èƒ½å·²ç»èººäº†å‡ åå¹´äº†ã€‚</p><p>å…¶å®ï¼Œâ€ç§‘å­¦å®¶â€ä»¬å·²ç»æ€»ç»“å‡ºä¸€ä¸ª B-tree ä¼˜åŒ–é­”åŠ›è±¡é™:</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/btree-optimal-curve.png" align="center" style="zoom:50%;" /><p>æ¨ªåæ ‡æ˜¯å†™æ€§èƒ½ï¼Œçºµåæ ‡æ˜¯è¯»æ€§èƒ½ï¼ŒB-tree å’Œ Logging æ•°æ®ç»“æ„åˆ†å¸ƒåœ¨æ›²çº¿çš„ä¸¤ä¸ªæç«¯ã€‚<br>B-tree çš„è¯»æ€§èƒ½éå¸¸å¥½ï¼Œä½†æ˜¯å†™æ€§èƒ½å·®ã€‚<br>Logging çš„å†™æ€§èƒ½éå¸¸å¥½ï¼Œä½†æ˜¯è¯»æ€§èƒ½å·®(æƒ³æƒ³æˆ‘ä»¬æ¯æ¬¡å†™éƒ½æŠŠæ•°æ®è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾ï¼Œæ˜¯ä¸æ˜¯å¾ˆå¿«ï¼Ÿä½†æ˜¯è¯»â€¦)ã€‚</p><p>åœ¨å®ƒä»¬ä¸­é—´æœ‰ä¸€ä¸ªä¼˜åŒ–æ›²åº¦(Optimal Curve)ã€‚<br>åœ¨è¿™ä¸ªæ›²åº¦ä¸Šï¼Œä½ å¯ä»¥é€šè¿‡å¢åŠ &#x2F;å‡å°‘ä¸€ä¸ªå¸¸æ•°(1-epsilon)æ¥åšè¯»å’Œå†™ä¼˜åŒ–ç»„åˆï¼ŒLSM-tree&#x2F;Fractal-tree éƒ½åœ¨è¿™ä¸ªæ›²åº¦ä¹‹ä¸Šã€‚  </p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/btree-epsilon.png" align="center" style="zoom:20%;" /><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><b>æ€»ç»“</b></h2><p>æœ¬æ–‡ä¸»è¦è®¨è®ºäº‹åŠ¡æ€§å¼•æ“çš„æŠ€æœ¯æ¼”è¿›ï¼Œå…¶ä¸­åŒ…å«äº† IO å¤æ‚åº¦åˆ†æï¼Œå…¶å®è¿™ä¸ªåˆ†ææ˜¯åŸºäºä¸€ä¸ª DAM(Disk Access Machine)æ¨¡å‹ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚<br>è¿™ä¸ªæ¨¡å‹è¦è§£å†³ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ<br>å¦‚æœå·¥ç¨‹ä¸­æ¶‰åŠç¡¬ä»¶å±‚çº§å…³ç³»ï¼Œæ¯”å¦‚ Disk &#x2F; Memory &#x2F; CPUï¼Œæ•°æ®åœ¨Diskï¼Œè¯»å–(ä»¥ block ä¸ºå•ä½)åˆ° Memoryï¼ŒæŸ¥æ‰¾è®¡ç®—(cache-line)åœ¨ CPUï¼Œ<br>ä¸åŒä»‹è´¨é—´æ€§èƒ½å·®è·åˆéå¸¸ä¹‹å¤§ï¼Œæˆ‘ä»¬æ€ä¹ˆåšæ‰èƒ½è®©æ•´ä½“æ€§èƒ½æ›´ä¼˜çš„é—®é¢˜ã€‚<br>å’Œå½“ä»Šçš„ç¡¬ä»¶ç›¸èåˆï¼Œè¿™ä¸ªæ¨¡å‹ä¹Ÿä¸€æ ·é€‚ç”¨ã€‚</p><p>æœ€åå›åˆ° ClickHouse çš„ MergeTree å¼•æ“ï¼Œå®ƒåªä½¿ç”¨äº†æœ¬æ–‡ä¸­çš„éƒ¨åˆ†ä¼˜åŒ–ï¼Œå®ç°ä¹Ÿæ¯”è¾ƒç®€æ´ã€é«˜æ•ˆï¼Œæ¯•ç«Ÿæ²¡æœ‰äº‹åŠ¡ï¼Œæ’¸èµ·æ¥ä¹Ÿæ²¡å•¥å¿ƒç†è´Ÿæ‹…ã€‚<br><strong>éšæœºå˜é¡ºåºï¼Œç©ºé—´æ¢æ—¶é—´</strong>ï¼Œ MergeTree åŸç†ï¼Œè¯·å¬ä¸‹å›åˆ†è§£ã€‚</p><h2 id="References"><a href="#References" class="headerlink" title=" References"></a><b> References</b></h2><p>[1] <a href="https://www.cs.au.dk/~gerth/papers/cacheoblivious05.pdf">Cache-Oblivious Data Structures</a><br>[2] <a href="https://www3.cs.stonybrook.edu/~bender/talks/2013-BenderKuszmaul-xldb-tutorial.pdf">Data Structures and Algorithms for Big Databases</a><br>[3] <a href="https://link.springer.com/chapter/10.1007%2F3-540-60220-8_74">The buffer tree: A new technique for optimal I&#x2F;O-algorithms</a><br>[4] <a href="http://www.bzero.se/ldapd/btree.html">how the append-only btree works</a><br>[5] <a href="https://www.douban.com/note/269741273/">å†™ä¼˜åŒ–çš„æ•°æ®ç»“æ„(1):AOFå’Œb-treeä¹‹é—´</a><br>[6] <a href="https://www.douban.com/note/269744617/">å†™ä¼˜åŒ–çš„æ•°æ®ç»“æ„(2):buffered tree</a><br>[7] <a href="https://www.douban.com/note/304123656/">å­˜å‚¨å¼•æ“æ•°æ®ç»“æ„ä¼˜åŒ–(1):cpu bound</a><br>[8] <a href="https://www.douban.com/note/304349195/">å­˜å‚¨å¼•æ“æ•°æ®ç»“æ„ä¼˜åŒ–(2):io bound</a><br>[9] <a href="https://github.com/BohuTANG/nessDB">nessDB</a><br>[10] <a href="https://github.com/BohuTANG/omt">omt</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;21 ä¸–çºªçš„ç¬¬äºŒä¸ª 10 å¹´ï¼Œè™å“¥å·²ç»åœ¨å­˜å‚¨å¼•æ“ä¸€çº¿å¥‹æˆ˜è¿‘ 10 å¹´ï¼Œç”±äºå¼ºå¤§çš„å…´è¶£é©±åŠ¨ï¼Œè¿™ä¹ˆå¤šå¹´æ¥å‡ ä¹ä¸æ”¾è¿‡ arXiv ä¸Šä¸å­˜å‚¨ç›¸å…³çš„æ¯ä¸€ç¯‡ paperã€‚&lt;br&gt;å°¤å…¶æ˜¯çœ‹åˆ°å¸¦æœ‰ draft çš„ paper æ—¶ï¼Œæœ‰ä¸€ç§ä¹ä¸å¬åˆ°â€œå®å½“â€å“æ—¶çš„æ„‰æ‚¦ã€‚&lt;br&gt;çœ‹paperè¿™ç©æ„</summary>
      
    
    
    
    
    <category term="clickhouse" scheme="https://bohutang.me/tags/clickhouse/"/>
    
    <category term="ClickHouseå’Œä»–çš„æœ‹å‹ä»¬" scheme="https://bohutang.me/tags/ClickHouse%E5%92%8C%E4%BB%96%E7%9A%84%E6%9C%8B%E5%8F%8B%E4%BB%AC/"/>
    
    <category term="lsm" scheme="https://bohutang.me/tags/lsm/"/>
    
    <category term="btree" scheme="https://bohutang.me/tags/btree/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouseå’Œä»–çš„æœ‹å‹ä»¬ï¼ˆ4ï¼‰Pipelineå¤„ç†å™¨å’Œè°ƒåº¦å™¨</title>
    <link href="https://bohutang.me/2020/06/11/clickhouse-and-friends-processor/"/>
    <id>https://bohutang.me/2020/06/11/clickhouse-and-friends-processor/</id>
    <published>2020-06-10T16:00:00.000Z</published>
    <updated>2022-08-27T08:25:55.053Z</updated>
    
    <content type="html"><![CDATA[<p><b>æœ€åæ›´æ–°: 2020-08-15</b></p><p>æœ¬æ–‡è°ˆä¸‹ ClickHouse æ ¸å¿ƒç§‘æŠ€ï¼šå¤„ç†å™¨ Processor å’Œæœ‰å‘æ— ç¯è°ƒåº¦å™¨ DAG Schedulerã€‚</p><p>è¿™äº›æ¦‚å¿µå¹¶ä¸æ˜¯ ClickHouse é¦–åˆ›ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å…³æ³¨ä¸‹ <a href="https://github.com/MaterializeInc/materialize">materialize</a>çš„ <a href="https://github.com/TimelyDataflow/timely-dataflow">timely-dataflow</a>ï¼Œè™å“¥ç”¨golang ä¹Ÿå†™è¿‡ä¸€ä¸ª<a href="https://github.com/vectorengine/vectorsql/tree/master/src/processors">åŸå‹</a>ã€‚</p><p>æ‹¼çš„æ˜¯å®ç°ç»†èŠ‚ï¼Œæ­£æ˜¯è¿™äº›æ¨¡å—çš„ç²¾è‰¯è®¾è®¡ï¼Œæ‰æœ‰äº† ClickHous eæ•´ä½“çš„é«˜æ€§èƒ½ã€‚</p><h2 id="Pipelineé—®é¢˜"><a href="#Pipelineé—®é¢˜" class="headerlink" title="Pipelineé—®é¢˜"></a><b>Pipelineé—®é¢˜</b></h2><p>åœ¨ä¼ ç»Ÿæ•°æ®åº“ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ª Query å¤„ç†æµç¨‹å¤§ä½“æ˜¯:<br><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/processor-plan.png" align="center" style="zoom:50%;" /></p><p>å…¶ä¸­åœ¨Plané˜¶æ®µï¼Œå¾€å¾€ä¼šå¢åŠ ä¸€ä¸ª Pipeline ç»„è£…(ä¸€ä¸ª transformer ä»£è¡¨ä¸€æ¬¡æ•°æ®å¤„ç†)ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/processor-transformer.png" align="center" style="zoom:50%;" /><p>æ‰€æœ‰ transformer è¢«ç¼–æ’æˆä¸€ä¸ªæµæ°´çº¿(pipeline)ï¼Œç„¶åäº¤ç»™ executor ä¸²è¡Œå¼æ‰§è¡Œï¼Œæ¯æ‰§è¡Œä¸€ä¸ª transformer æ•°æ®é›†å°±ä¼šè¢«åŠ å·¥å¹¶è¾“å‡ºï¼Œä¸€ç›´åˆ°ä¸‹æ¸¸çš„ sinkerã€‚<br>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ¨¡å‹çš„ä¼˜ç‚¹æ˜¯<b>ç®€å•</b>ï¼Œç¼ºç‚¹æ˜¯<b>æ€§èƒ½ä½</b>ï¼Œæ— æ³•å‘æŒ¥ CPU çš„<b>å¹¶è¡Œ</b>èƒ½åŠ›ï¼Œé€šå¸¸å«ç«å±±æ¨¡å‹(<em>volcano</em>-style)ï¼Œå¯¹äº OLTP ä½å»¶è¿Ÿæ¥è¯´è¶³å¤Ÿï¼Œå¯¹äºè®¡ç®—å¯†é›†çš„ OLAP æ¥è¯´æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼ŒCPU ä¸åˆ° 100% å°±æ˜¯çŠ¯ç½ªï¼</p><p>å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼Œå¦‚æœ transformer1 å’Œ transformer2 æ²¡æœ‰äº¤é›†ï¼Œé‚£ä¹ˆå®ƒä»¬å°±å¯ä»¥å¹¶è¡Œå¤„ç†ï¼š</p><img src="https://bohutang-1253727613.cos.ap-beijing.myqcloud.com/posts/processor-transformer2.png" align="center" style="zoom:50%;" /><p>è¿™æ ·å°±æ¶‰åŠåˆ°ä¸€äº›æ¯”è¾ƒçµé­‚çš„é—®é¢˜ï¼š</p><ol><li>å¦‚ä½•å®ç° transformer çš„çµæ´»ç¼–æ’ï¼Ÿ</li><li>å¦‚ä½•å®ç° transformer é—´çš„æ•°æ®åŒæ­¥ï¼Ÿ</li><li>å¦‚ä½•å®ç° transformer é—´çš„å¹¶è¡Œè°ƒåº¦ï¼Ÿ</li></ol><h2 id="Processor-å’Œ-DAG-Scheduler"><a href="#Processor-å’Œ-DAG-Scheduler" class="headerlink" title="Processor å’Œ DAG Scheduler"></a><b>Processor å’Œ DAG Scheduler</b></h2><h3 id="1-Transformer-ç¼–æ’"><a href="#1-Transformer-ç¼–æ’" class="headerlink" title="1. Transformer ç¼–æ’"></a><b>1. Transformer ç¼–æ’</b></h3><p>ClickHouse å®ç°äº†ä¸€ç³»åˆ—åŸºç¡€ transformer æ¨¡å—ï¼Œè§ <a href="https://github.com/ClickHouse/ClickHouse/tree/master/src/Processors/Transforms">src&#x2F;Processors&#x2F;Transforms</a>ï¼Œæ¯”å¦‚:</p><ul><li>FilterTransform       â€“ WHERE æ¡ä»¶è¿‡æ»¤</li><li>SortingTransform   â€“ ORDER BY æ’åº</li><li>LimitByTransform  â€“ LIMIT è£å‰ª</li></ul><p>å½“æˆ‘ä»¬æ‰§è¡Œ:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t1 WHERE id=1 ORDER BY time DESC LIMIT 10</span><br></pre></td></tr></table></figure><p>å¯¹äº ClickHouse çš„ QueryPipeline æ¥è¯´ï¼Œå®ƒä¼šæŒ‰ç…§ä»¥ä¸‹æ–¹å¼è¿›è¡Œç¼–æ’ç»„è£…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">QueryPipeline::addSimpleTransform(Source)</span><br><span class="line">QueryPipeline::addSimpleTransform(FilterTransform)</span><br><span class="line">QueryPipeline::addSimpleTransform(SortingTransform)</span><br><span class="line">QueryPipeline::addSimpleTransform(LimitByTransform)</span><br><span class="line">QueryPipeline::addSimpleTransform(Sinker)</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å®ç°äº† Transformer çš„ç¼–æ’ï¼Œä½†æ˜¯æ‰§è¡Œæ—¶æ•°æ®å¦‚ä½•è¿›è¡ŒåŒæ­¥å‘¢ï¼Ÿ</p><h3 id="2-Transformer-æ•°æ®åŒæ­¥"><a href="#2-Transformer-æ•°æ®åŒæ­¥" class="headerlink" title="2. Transformer æ•°æ®åŒæ­¥"></a><b>2. Transformer æ•°æ®åŒæ­¥</b></h3><p>å½“ QueryPipeline è¿›è¡Œ transformer ç¼–æ’æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œæ›´åŠ åº•å±‚çš„ DAG è¿é€šæ„å»ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connect(Source.OutPort, FilterTransform.InPort)</span><br><span class="line">connect(FilterTransform.OutPort, SortingTransform.InPort)</span><br><span class="line">connect(SortingTransform.OutPort, LimitByTransform.InPort)</span><br><span class="line">connect(LimitByTransform.OutPort, Sinker.InPort)</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å®ç°äº†æ•°æ®çš„æµå‘å…³ç³»ï¼Œä¸€ä¸ª transformer çš„ OutPort å¯¹æ¥å¦å¤–ä¸€ä¸ªçš„ InPortï¼Œå°±åƒæˆ‘ä»¬ç°å®ä¸­çš„æ°´ç®¡ç®¡é“ä¸€æ ·ï¼Œæ¥å£æœ‰ 3 é€šç”šè‡³å¤šé€šã€‚</p><h3 id="3-Transformer-æ‰§è¡Œè°ƒåº¦"><a href="#3-Transformer-æ‰§è¡Œè°ƒåº¦" class="headerlink" title="3. Transformer æ‰§è¡Œè°ƒåº¦"></a><b>3. Transformer æ‰§è¡Œè°ƒåº¦</b></h3><p>ç°åœ¨ç®¡é“ç»„è£…èµ·æ¥äº†ï¼Œé‚£ä¹ˆç®¡é“å†…çš„æ°´å¦‚ä½•è¿›è¡Œå¤„ç†å’Œç»™å‹æµåŠ¨å‘¢ï¼Ÿ</p><p>ClickHouse å®šä¹‰äº†ä¸€å¥— transform çŠ¶æ€ï¼Œprocessor æ ¹æ®è¿™äº›çŠ¶æ€æ¥å®ç°è°ƒåº¦ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">Status</span></span><br><span class="line">&#123;</span><br><span class="line">    NeedData  <span class="comment">// ç­‰å¾…æ•°æ®æµè¿›å…¥</span></span><br><span class="line">    PortFull, <span class="comment">// ç®¡é“æµå‡ºç«¯é˜»å¡</span></span><br><span class="line">    Finished, <span class="comment">// å®ŒæˆçŠ¶æ€ï¼Œé€€å‡º</span></span><br><span class="line">    Ready,    <span class="comment">// åˆ‡æ¢åˆ° work å‡½æ•°ï¼Œè¿›è¡Œé€»è¾‘å¤„ç†</span></span><br><span class="line">    Async,    <span class="comment">// åˆ‡æ¢åˆ° schedule å‡½æ•°ï¼Œè¿›è¡Œå¼‚æ­¥å¤„ç†</span></span><br><span class="line">    Wait,     <span class="comment">// ç­‰å¾…å¼‚æ­¥å¤„ç†</span></span><br><span class="line">    ExpandPipeline,      <span class="comment">// Pipeline éœ€è¦è£‚å˜</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“ source ç”Ÿæˆæ•°æ®åï¼Œå®ƒçš„çŠ¶æ€ä¼šè®¾ç½®ä¸º PortFullï¼Œæ„æ€æ˜¯ç­‰ç€æµå…¥å…¶ä»– transformer çš„ InPortï¼Œprocessor ä¼šå¼€å§‹è°ƒåº¦ FilterTransformer(NeedData) çš„ Prepareï¼Œè¿›è¡Œ PullDataï¼Œç„¶åå®ƒçš„çŠ¶æ€è®¾ç½®ä¸º Readyï¼Œç­‰å¾… processor è°ƒåº¦ Work æ–¹æ³•è¿›è¡Œæ•°æ®Filterå¤„ç†ï¼Œå¤§å®¶å°±è¿™æ ·é çŠ¶æ€è®© processor å»æ„ŸçŸ¥ï¼Œæ¥è°ƒåº¦å’ŒåšçŠ¶æ€è¿ç§»ï¼Œç›´åˆ° Finished çŠ¶æ€ã€‚</p><p>è¿™é‡Œå€¼å¾—ä¸€æçš„æ˜¯ ExpandPipeline çŠ¶æ€ï¼Œå®ƒä¼šæ ¹æ® transformer çš„å®ç°ï¼Œå¯ä»¥æŠŠä¸€ä¸ª transformer è£‚å˜å‡ºæ›´å¤šä¸ª transformer å¹¶è¡Œæ‰§è¡Œï¼Œè¾¾åˆ°ä¸€ä¸ªçˆ†ç‚¸æ•ˆæœã€‚</p><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a><b>Example</b></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT number + 1 FROM t1;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ›´åŠ æ·±å…¥ç†è§£ ClickHouse çš„ processor å’Œ scheduler æœºåˆ¶ï¼Œæˆ‘ä»¬æ¥ä¸€ä¸ªåŸç”Ÿæ€çš„ example:</p><ol><li>ä¸€ä¸ª Source:{0,1,2,3,4}</li><li>AdderTransformer å¯¹æ¯ä¸ªæ•°å­—åšåŠ 1æ“ä½œ</li><li>ä¸€ä¸ª Sinkerï¼Œè¾“å‡ºç»“æœ</li></ol><h3 id="1-Source"><a href="#1-Source" class="headerlink" title="1. Source"></a><b>1. Source</b></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MySource</span> : <span class="keyword">public</span> ISource</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="string">&quot;MySource&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MySource</span>(UInt64 end_)</span><br><span class="line">        : <span class="built_in">ISource</span>(<span class="built_in">Block</span>(&#123;ColumnWithTypeAndName&#123;ColumnUInt64::<span class="built_in">create</span>(), std::<span class="built_in">make_shared</span>&lt;DataTypeUInt64&gt;(), <span class="string">&quot;number&quot;</span>&#125;&#125;)), <span class="built_in">end</span>(end_)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    UInt64 end;</span><br><span class="line">    <span class="type">bool</span> done = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Chunk <span class="title">generate</span><span class="params">()</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (done)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Chunk</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        MutableColumns columns;</span><br><span class="line">        columns.<span class="built_in">emplace_back</span>(ColumnUInt64::<span class="built_in">create</span>());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0U</span>; i &lt; end; i++)</span><br><span class="line">            columns[<span class="number">0</span>]-&gt;<span class="built_in">insert</span>(i);</span><br><span class="line"></span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Chunk</span>(std::<span class="built_in">move</span>(columns), end);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="2-MyAddTransform"><a href="#2-MyAddTransform" class="headerlink" title="2. MyAddTransform"></a><b>2. MyAddTransform</b></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyAddTransformer</span> : <span class="keyword">public</span> IProcessor</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="string">&quot;MyAddTransformer&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MyAddTransformer</span>()</span><br><span class="line">        : <span class="built_in">IProcessor</span>(</span><br><span class="line">            &#123;<span class="built_in">Block</span>(&#123;ColumnWithTypeAndName&#123;ColumnUInt64::<span class="built_in">create</span>(), std::<span class="built_in">make_shared</span>&lt;DataTypeUInt64&gt;(), <span class="string">&quot;number&quot;</span>&#125;&#125;)&#125;,</span><br><span class="line">            &#123;<span class="built_in">Block</span>(&#123;ColumnWithTypeAndName&#123;ColumnUInt64::<span class="built_in">create</span>(), std::<span class="built_in">make_shared</span>&lt;DataTypeUInt64&gt;(), <span class="string">&quot;number&quot;</span>&#125;&#125;)&#125;)</span><br><span class="line">        , <span class="built_in">input</span>(inputs.<span class="built_in">front</span>())</span><br><span class="line">        , <span class="built_in">output</span>(outputs.<span class="built_in">front</span>())</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Status <span class="title">prepare</span><span class="params">()</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (output.<span class="built_in">isFinished</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            input.<span class="built_in">close</span>();</span><br><span class="line">            <span class="keyword">return</span> Status::Finished;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!output.<span class="built_in">canPush</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            input.<span class="built_in">setNotNeeded</span>();</span><br><span class="line">            <span class="keyword">return</span> Status::PortFull;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (has_process_data)</span><br><span class="line">        &#123;</span><br><span class="line">            output.<span class="built_in">push</span>(std::<span class="built_in">move</span>(current_chunk));</span><br><span class="line">            has_process_data = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (input.<span class="built_in">isFinished</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            output.<span class="built_in">finish</span>();</span><br><span class="line">            <span class="keyword">return</span> Status::Finished;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!input.<span class="built_in">hasData</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            input.<span class="built_in">setNeeded</span>();</span><br><span class="line">            <span class="keyword">return</span> Status::NeedData;</span><br><span class="line">        &#125;</span><br><span class="line">        current_chunk = input.<span class="built_in">pull</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> Status::Ready;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">work</span><span class="params">()</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> num_rows = current_chunk.<span class="built_in">getNumRows</span>();</span><br><span class="line">        <span class="keyword">auto</span> result_columns = current_chunk.<span class="built_in">cloneEmptyColumns</span>();</span><br><span class="line">        <span class="keyword">auto</span> columns = current_chunk.<span class="built_in">detachColumns</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0U</span>; i &lt; num_rows; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">auto</span> val = columns[<span class="number">0</span>]-&gt;<span class="built_in">getUInt</span>(i);</span><br><span class="line">            result_columns[<span class="number">0</span>]-&gt;<span class="built_in">insert</span>(val+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        current_chunk.<span class="built_in">setColumns</span>(std::<span class="built_in">move</span>(result_columns), num_rows);</span><br><span class="line">        has_process_data = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">InputPort &amp; <span class="title">getInputPort</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> input; &#125;</span><br><span class="line">    <span class="function">OutputPort &amp; <span class="title">getOutputPort</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> output; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">bool</span> has_input = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> has_process_data = <span class="literal">false</span>;</span><br><span class="line">    Chunk current_chunk;</span><br><span class="line">    InputPort &amp; input;</span><br><span class="line">    OutputPort &amp; output;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-MySink"><a href="#3-MySink" class="headerlink" title="3. MySink"></a><b>3. MySink</b></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MySink</span> : <span class="keyword">public</span> ISink</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="string">&quot;MySinker&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MySink</span>() : <span class="built_in">ISink</span>(<span class="built_in">Block</span>(&#123;ColumnWithTypeAndName&#123;ColumnUInt64::<span class="built_in">create</span>(), std::<span class="built_in">make_shared</span>&lt;DataTypeUInt64&gt;(), <span class="string">&quot;number&quot;</span>&#125;&#125;)) &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    WriteBufferFromFileDescriptor out&#123;STDOUT_FILENO&#125;;</span><br><span class="line">    FormatSettings settings;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">consume</span><span class="params">(Chunk chunk)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">size_t</span> rows = chunk.<span class="built_in">getNumRows</span>();</span><br><span class="line">        <span class="type">size_t</span> columns = chunk.<span class="built_in">getNumColumns</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> row_num = <span class="number">0</span>; row_num &lt; rows; ++row_num)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">writeString</span>(<span class="string">&quot;prefix-&quot;</span>, out);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> column_num = <span class="number">0</span>; column_num &lt; columns; ++column_num)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (column_num != <span class="number">0</span>)</span><br><span class="line">                    <span class="built_in">writeChar</span>(<span class="string">&#x27;\t&#x27;</span>, out);</span><br><span class="line">                <span class="built_in">getPort</span>()</span><br><span class="line">                    .<span class="built_in">getHeader</span>()</span><br><span class="line">                    .<span class="built_in">getByPosition</span>(column_num)</span><br><span class="line">                    .type-&gt;<span class="built_in">serializeAsText</span>(*chunk.<span class="built_in">getColumns</span>()[column_num], row_num, out, settings);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">writeChar</span>(<span class="string">&#x27;\n&#x27;</span>, out);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        out.<span class="built_in">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="4-DAG-Scheduler"><a href="#4-DAG-Scheduler" class="headerlink" title="4. DAG Scheduler"></a><b>4. DAG Scheduler</b></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int main(int, char **)</span><br><span class="line">&#123;</span><br><span class="line">    auto source0 = std::make_shared&lt;MySource&gt;(5);</span><br><span class="line">    auto add0 = std::make_shared&lt;MyAddTransformer&gt;();</span><br><span class="line">    auto sinker0 = std::make_shared&lt;MySink&gt;();</span><br><span class="line"></span><br><span class="line">    /// Connect.</span><br><span class="line">    connect(source0-&gt;getPort(), add0-&gt;getInputPort());</span><br><span class="line">    connect(add0-&gt;getOutputPort(), sinker0-&gt;getPort());</span><br><span class="line"></span><br><span class="line">    std::vector&lt;ProcessorPtr&gt; processors = &#123;source0, add0, sinker0&#125;;</span><br><span class="line">    PipelineExecutor executor(processors);</span><br><span class="line">    executor.execute(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»å¼€å‘è€…è§’åº¦çœ‹è¿˜æ˜¯æ¯”è¾ƒå¤æ‚ï¼ŒçŠ¶æ€è¿ç§»è¿˜éœ€è¦å¼€å‘è€…è‡ªå·±æ§åˆ¶ï¼Œä¸è¿‡ upstream å·²ç»åšäº†å¤§é‡çš„åŸºç¡€å·¥ä½œï¼Œæ¯”å¦‚å¯¹ sourceçš„å°è£… ISourceï¼Œå¯¹ sink çš„å°è£… ISinkï¼Œè¿˜æœ‰ä¸€ä¸ªåŸºç¡€çš„ ISimpleTransformï¼Œè®©å¼€å‘è€…åœ¨ä¸Šå±‚ä½¿ç”¨ processor æ—¶æ›´åŠ å®¹æ˜“ï¼Œå¯ä»¥ç§¯æœ¨å¼æ­å»ºå‡ºè‡ªå·±æƒ³è¦çš„ pipelineã€‚</p><p>ClickHouse çš„ transformer æ•°æ®å•å…ƒæ˜¯ Chunkï¼Œtransformer å¯¹ä¸Šæ¸¸ OutPort æµè¿‡æ¥çš„ Chunk è¿›è¡ŒåŠ å·¥ï¼Œç„¶åè¾“å‡ºç»™ä¸‹æ¸¸çš„ InPortï¼Œå›¾è¿é€šå¼çš„æµæ°´çº¿å¹¶è¡Œå·¥ä½œï¼Œè®© CPU å°½é‡æ»¡è´Ÿè·å·¥ä½œã€‚</p><p>å½“ä¸€ä¸ª SQL è¢«è§£ææˆ AST åï¼ŒClickHouse æ ¹æ® AST æ„å»º Query Planï¼Œç„¶åæ ¹æ® QueryPlan æ„å»ºå‡º pipelineï¼Œæœ€åç”±  processor è´Ÿè´£è°ƒåº¦å’Œæ‰§è¡Œã€‚<br>ç›®å‰ï¼ŒClickHouse æ–°ç‰ˆæœ¬å·²ç»é»˜è®¤å¼€å¯ QueryPipelineï¼ŒåŒæ—¶è¿™å—ä»£ç ä¹Ÿåœ¨ä¸åœçš„è¿­ä»£ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;b&gt;æœ€åæ›´æ–°: 2020-08-15&lt;/b&gt;&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡è°ˆä¸‹ ClickHouse æ ¸å¿ƒç§‘æŠ€ï¼šå¤„ç†å™¨ Processor å’Œæœ‰å‘æ— ç¯è°ƒåº¦å™¨ DAG Schedulerã€‚&lt;/p&gt;
&lt;p&gt;è¿™äº›æ¦‚å¿µå¹¶ä¸æ˜¯ ClickHouse é¦–åˆ›ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å…³æ³¨ä¸‹ &lt;a hre</summary>
      
    
    
    
    
    <category term="clickhouse" scheme="https://bohutang.me/tags/clickhouse/"/>
    
    <category term="ClickHouseå’Œä»–çš„æœ‹å‹ä»¬" scheme="https://bohutang.me/tags/ClickHouse%E5%92%8C%E4%BB%96%E7%9A%84%E6%9C%8B%E5%8F%8B%E4%BB%AC/"/>
    
    <category term="processor" scheme="https://bohutang.me/tags/processor/"/>
    
    <category term="pipeline" scheme="https://bohutang.me/tags/pipeline/"/>
    
    <category term="dag scheduler" scheme="https://bohutang.me/tags/dag-scheduler/"/>
    
  </entry>
  
</feed>
